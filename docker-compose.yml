services:
  # PostgreSQL 16 - 主数据库
  postgres:
    image: postgres:16-alpine
    container_name: flotilla-postgres
    restart: unless-stopped
    ports:
      - '5434:5432'
    environment:
      POSTGRES_USER: devplatform
      POSTGRES_PASSWORD: c0tmOi9Wx7LeXGBNipOTo+DmZ0PmKdPOiNO89d7r4y8=
      POSTGRES_DB: flotilla
      POSTGRES_INITDB_ARGS: '--encoding=UTF-8 --lc-collate=C --lc-ctype=C'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U devplatform -d flotilla']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - flotilla-network

  # Redis 7 - 缓存和会话存储
  redis:
    image: redis:7-alpine
    container_name: flotilla-redis
    restart: unless-stopped
    ports:
      - '6380:6379'
    command: redis-server --appendonly yes --requirepass O2iPiza2dCSq6pw+v0Wlc3aGrEOzbojQ
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - flotilla-network

  # MinIO - 对象存储（S3兼容）
  minio:
    image: minio/minio:latest
    container_name: flotilla-minio
    restart: unless-stopped
    ports:
      - '9000:9000'   # API端口
      - '9001:9001'   # Console端口
    environment:
      MINIO_ROOT_USER: db98129c12cd8d178d76771d06de1c4f
      MINIO_ROOT_PASSWORD: 'TT8td4psNhL4uKHkJHyQ1HBf/hAgiqIGXxR5UBd0G6I='
    command: server /data --console-address ':9001'
    volumes:
      - minio_data:/data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - flotilla-network

  # MeiliSearch - 代码搜索引擎
  meilisearch:
    image: getmeili/meilisearch:v1.10
    container_name: flotilla-meilisearch
    restart: unless-stopped
    ports:
      - '7700:7700'
    environment:
      MEILI_MASTER_KEY: 'VgzSTrUwaIg0cV/2Ta+7R+VmzHECUnUbMG+LnW15pmw='
      MEILI_ENV: development
      MEILI_HTTP_ADDR: '0.0.0.0:7700'
      MEILI_NO_ANALYTICS: 'true'
    volumes:
      - meilisearch_data:/meili_data
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://127.0.0.1:7700/health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - flotilla-network

  # 后端 NestJS API
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    container_name: flotilla-backend
    restart: unless-stopped
    ports:
      - '4000:4000'
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: 'postgresql://devplatform:c0tmOi9Wx7LeXGBNipOTo%2BDmZ0PmKdPOiNO89d7r4y8%3D@postgres:5432/flotilla'
      REDIS_URL: 'redis://:O2iPiza2dCSq6pw+v0Wlc3aGrEOzbojQ@redis:6379'
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: db98129c12cd8d178d76771d06de1c4f
      MINIO_SECRET_KEY: 'TT8td4psNhL4uKHkJHyQ1HBf/hAgiqIGXxR5UBd0G6I='
      MINIO_USE_SSL: 'false'
      MINIO_BUCKET_NAME: flotilla-storage
      MEILI_HOST: 'http://meilisearch:7700'
      MEILI_MASTER_KEY: 'VgzSTrUwaIg0cV/2Ta+7R+VmzHECUnUbMG+LnW15pmw='
      MEILI_INDEX_PREFIX: 'flotilla_'
      JWT_SECRET: 'r+zzXRzVHRadjucwWvAZxE0FoeNxfzQP7foO4ZJWNqg='
      JWT_EXPIRATION: '7d'
      JWT_REFRESH_SECRET: 'kiICQ4l3urhFt0KvaVvTR93WsjfkroYs+nJxNxC0Id8='
      JWT_REFRESH_EXPIRATION: '30d'
      FRONTEND_URL: 'http://localhost:3000'
      WEBSITE_URL: 'http://localhost:3003'
      GIT_STORAGE_PATH: '/app/repos'
      INITIAL_ADMIN_EMAIL: 'jia202520@gmail.com'
    volumes:
      - git_repos_data:/app/repos
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    networks:
      - flotilla-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:4000/api/docs']
      interval: 10s
      timeout: 5s
      retries: 5

  # 前端 Next.js
  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
    container_name: flotilla-frontend
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      PORT: 3000
      NEXT_PUBLIC_API_URL: 'http://localhost:4000/api'
      NEXT_TELEMETRY_DISABLED: 1
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - flotilla-network

  # 官网 Next.js
  website:
    build:
      context: .
      dockerfile: website/Dockerfile
    container_name: flotilla-website
    restart: unless-stopped
    ports:
      - '3003:3003'
    environment:
      NODE_ENV: production
      PORT: 3003
      NEXT_TELEMETRY_DISABLED: 1
    networks:
      - flotilla-network

  # PostgreSQL 从库（可选，用于读写分离）
  postgres-replica:
    image: postgres:16-alpine
    container_name: flotilla-postgres-replica
    restart: unless-stopped
    ports:
      - '5435:5432'
    environment:
      POSTGRES_USER: devplatform
      POSTGRES_PASSWORD: c0tmOi9Wx7LeXGBNipOTo+DmZ0PmKdPOiNO89d7r4y8=
      POSTGRES_DB: flotilla
    volumes:
      - postgres_replica_data:/var/lib/postgresql/data
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - flotilla-network
    profiles:
      - replica   # 使用 docker-compose --profile replica up 来启动

volumes:
  postgres_data:
    driver: local
  postgres_replica_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  meilisearch_data:
    driver: local
  git_repos_data:
    driver: local

networks:
  flotilla-network:
    driver: bridge
