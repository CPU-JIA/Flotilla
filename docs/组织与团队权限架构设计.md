# 组织与团队权限架构设计文档

## 文档概述

**文档版本**: v1.0.0
**创建日期**: 2025-10-17
**作者**: Claude Code + JIA总
**目标**: 为平台引入企业级三层权限架构（Platform → Organization → Team → Project）

---

## 1. 设计背景与动机

### 1.1 现有系统问题分析

**问题描述**：
当前系统仅有两层权限架构：
- **平台层**: USER / SUPER_ADMIN
- **项目层**: OWNER / MAINTAINER / MEMBER / VIEWER

**核心缺陷**：
1. ❌ **缺少组织实体**：无法支持企业级多人协作
2. ❌ **无团队概念**：无法批量管理项目权限
3. ❌ **权限粒度单一**：每个项目独立管理成员，运维成本高
4. ❌ **与定位矛盾**：需求文档定位"团队协作平台"，实际仅支持个人项目

### 1.2 业界对比研究

| 平台    | 权限层级                                | 特点                    |
| ------- | --------------------------------------- | ----------------------- |
| GitHub  | Platform → Organization → Team → Repo  | 3层，支持SAML SSO       |
| GitLab  | Platform → Group → Subgroup → Project  | 3层，无限嵌套Group      |
| Gitee   | Platform → Org → Team → Repo           | 4层，显式定义Team层     |
| **本项目** | Platform → Organization → Team → Project | **3层，借鉴GitHub + Gitee** |

---

## 2. 新架构设计方案

### 2.1 权限层级结构

```
┌─────────────────────────────────────────────────────────────┐
│                    Platform Level (平台层)                   │
│  UserRole: USER | SUPER_ADMIN                               │
│  - SUPER_ADMIN: 平台运维权限（用户管理、系统监控）         │
│  - USER: 普通用户，可创建组织和项目                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                Organization Level (组织层)                   │
│  OrgRole: OWNER | ADMIN | MEMBER                            │
│  - OWNER: 组织所有者（最高权限，可删除组织）                │
│  - ADMIN: 组织管理员（可管理成员和设置）                    │
│  - MEMBER: 组织成员（基础权限）                              │
│                                                              │
│  配额限制:                                                   │
│  - 每用户最多创建 10 个组织                                  │
│  - 每组织默认 1000 个项目配额                                │
│  - 每组织默认 1000 个成员配额                                │
│  - 每组织默认 100GB 存储配额                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Team Level (团队层)                       │
│  TeamRole: MAINTAINER | MEMBER                              │
│  - MAINTAINER: 团队维护者（可管理团队和分配项目权限）       │
│  - MEMBER: 团队成员（继承团队被赋予的项目权限）             │
│                                                              │
│  配额限制:                                                   │
│  - 每团队默认 100 个成员配额                                 │
│  - 团队可被分配到多个项目                                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Project Level (项目层)                     │
│  MemberRole: OWNER | MAINTAINER | MEMBER | VIEWER           │
│  - OWNER: 项目所有者（完全控制权）                           │
│  - MAINTAINER: 项目维护者（可审核PR、管理设置）             │
│  - MEMBER: 项目成员（可读写代码）                            │
│  - VIEWER: 项目查看者（只读权限）                            │
│                                                              │
│  权限来源优先级:                                             │
│  1. 直接项目成员权限（ProjectMember）                        │
│  2. 团队项目权限（TeamProjectPermission）                    │
│  3. 组织继承权限（Organization OWNER/ADMIN）                 │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心数据模型

#### 2.2.1 Organization（组织）

```prisma
model Organization {
  id           String   @id @default(cuid())
  name         String   @db.VarChar(100)        // 2-50字符，支持中文
  slug         String   @unique @db.VarChar(100) // 全局唯一标识
  description  String?  @db.Text
  avatar       String?  @db.VarChar(500)
  website      String?  @db.VarChar(500)

  // 资源配额
  maxProjects  Int      @default(1000)
  maxMembers   Int      @default(1000)
  storageQuota BigInt   @default(107374182400)  // 100GB
  storageUsed  BigInt   @default(0)

  // 个人组织标识（用于数据迁移）
  isPersonal   Boolean  @default(false)

  // 软删除支持（30天保护期）
  deletedAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // 关系
  members  OrganizationMember[]
  teams    Team[]
  projects Project[]
}
```

**字段说明**：
- `name`: 组织名称，支持中文，2-50字符
- `slug`: URL友好的唯一标识，全局唯一，用于路由（如 `/orgs/alibaba-cloud`）
- `isPersonal`: 标识个人组织（数据迁移时为现有用户自动创建）
- `deletedAt`: 软删除时间戳，支持30天恢复期（平台管理员可恢复）

#### 2.2.2 OrganizationMember（组织成员）

```prisma
model OrganizationMember {
  id             String  @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole @default(MEMBER)
  joinedAt       DateTime @default(now())

  organization Organization @relation(...)
  user         User         @relation(...)

  @@unique([organizationId, userId])
}
```

**权限矩阵**：

| 操作                     | OWNER | ADMIN | MEMBER |
| ------------------------ | ----- | ----- | ------ |
| 查看组织信息             | ✅     | ✅     | ✅      |
| 创建项目                 | ✅     | ✅     | ✅      |
| 管理组织设置             | ✅     | ✅     | ❌      |
| 邀请/移除成员            | ✅     | ✅     | ❌      |
| 创建/删除团队            | ✅     | ✅     | ❌      |
| 删除组织                 | ✅     | ❌     | ❌      |
| 转让组织所有权           | ✅     | ❌     | ❌      |

#### 2.2.3 Team（团队）

```prisma
model Team {
  id             String  @id @default(cuid())
  organizationId String
  name           String  @db.VarChar(100)
  slug           String  @db.VarChar(100)
  description    String? @db.Text
  avatar         String? @db.VarChar(500)
  maxMembers     Int     @default(100)

  organization       Organization            @relation(...)
  members            TeamMember[]
  projectPermissions TeamProjectPermission[]

  @@unique([organizationId, slug])
}
```

**设计特点**：
- `slug`: 组织内唯一，用于路由（如 `/orgs/alibaba/teams/frontend-team`）
- `maxMembers`: 默认100人，可根据组织配额调整
- 团队可以被分配到多个项目，实现批量权限管理

#### 2.2.4 TeamMember（团队成员）

```prisma
model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     TeamRole @default(MEMBER)
  joinedAt DateTime @default(now())

  team Team @relation(...)
  user User @relation(...)

  @@unique([teamId, userId])
}
```

**权限矩阵**：

| 操作                   | MAINTAINER | MEMBER |
| ---------------------- | ---------- | ------ |
| 查看团队信息           | ✅          | ✅      |
| 管理团队设置           | ✅          | ❌      |
| 添加/移除团队成员      | ✅          | ❌      |
| 分配团队到项目         | ✅          | ❌      |
| 修改团队项目权限       | ✅          | ❌      |

#### 2.2.5 TeamProjectPermission（团队项目权限）

```prisma
model TeamProjectPermission {
  id        String     @id @default(cuid())
  teamId    String
  projectId String
  role      MemberRole // 复用项目角色

  team    Team    @relation(...)
  project Project @relation(...)

  @@unique([teamId, projectId])
}
```

**权限继承机制**：
- 团队被分配到项目时，指定一个项目角色（OWNER/MAINTAINER/MEMBER/VIEWER）
- 团队所有成员自动继承该角色对该项目的权限
- 优点：批量管理权限，无需逐个添加成员

#### 2.2.6 Project（项目 - 修改）

```prisma
model Project {
  id             String   @id @default(cuid())
  name           String   @db.VarChar(100)
  organizationId String?  // 可选：支持个人项目（迁移兼容）

  owner           User                    @relation("ProjectOwner")
  organization    Organization?           @relation(...)
  members         ProjectMember[]
  teamPermissions TeamProjectPermission[]

  @@unique([ownerId, name])        // 个人项目：用户内唯一
  @@unique([organizationId, name]) // 组织项目：组织内唯一
}
```

**关键变更**：
- 新增 `organizationId` 字段（可选）
- 支持两种项目类型：
  - **个人项目**：`organizationId = null`，保持向后兼容
  - **组织项目**：`organizationId != null`，归属于组织

---

## 3. 权限计算逻辑

### 3.1 权限优先级规则

```typescript
/**
 * 获取用户对项目的最终权限
 * 优先级：直接成员 > 团队权限 > 组织继承
 */
function calculateProjectPermission(
  userId: string,
  projectId: string
): MemberRole | null {
  // 1. 检查直接项目成员权限（最高优先级）
  const directMember = await prisma.projectMember.findUnique({
    where: { projectId_userId: { projectId, userId } }
  });
  if (directMember) return directMember.role;

  // 2. 检查团队项目权限（中优先级）
  const teamPermissions = await prisma.teamProjectPermission.findMany({
    where: {
      projectId,
      team: { members: { some: { userId } } }
    },
    orderBy: { role: 'asc' } // OWNER < MAINTAINER < MEMBER < VIEWER
  });
  if (teamPermissions.length > 0) {
    return teamPermissions[0].role; // 返回最高权限
  }

  // 3. 检查组织继承权限（低优先级）
  const project = await prisma.project.findUnique({
    where: { id: projectId },
    include: {
      organization: {
        include: {
          members: { where: { userId } }
        }
      }
    }
  });

  if (project?.organization) {
    const orgMember = project.organization.members[0];
    if (orgMember) {
      // 组织 OWNER/ADMIN → 项目 MAINTAINER
      // 组织 MEMBER → 项目 VIEWER
      return orgMember.role === 'MEMBER' ? 'VIEWER' : 'MAINTAINER';
    }
  }

  return null; // 无权限
}
```

### 3.2 权限检查中间件（伪代码）

```typescript
@Injectable()
export class PermissionGuard implements CanActivate {
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    const projectId = request.params.projectId;
    const requiredRole = this.reflector.get<MemberRole>(
      'required-role',
      context.getHandler()
    );

    const userRole = await this.calculateProjectPermission(
      user.id,
      projectId
    );

    return this.hasPermission(userRole, requiredRole);
  }

  private hasPermission(
    userRole: MemberRole,
    requiredRole: MemberRole
  ): boolean {
    const roleHierarchy = {
      OWNER: 4,
      MAINTAINER: 3,
      MEMBER: 2,
      VIEWER: 1
    };
    return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
  }
}
```

---

## 4. 数据迁移策略

### 4.1 迁移目标

**问题**: 现有系统有用户和项目，但没有组织实体。

**解决方案**: 为每个现有用户自动创建一个"个人组织"。

### 4.2 迁移脚本逻辑

```typescript
async function migrateExistingUsersToOrganizations() {
  const users = await prisma.user.findMany();

  for (const user of users) {
    // 为每个用户创建个人组织
    const personalOrg = await prisma.organization.create({
      data: {
        name: `${user.username}'s Organization`,
        slug: `user-${user.username.toLowerCase()}`,
        isPersonal: true, // 标记为个人组织
        members: {
          create: {
            userId: user.id,
            role: 'OWNER'
          }
        }
      }
    });

    // 将用户的现有项目关联到个人组织
    await prisma.project.updateMany({
      where: { ownerId: user.id },
      data: { organizationId: personalOrg.id }
    });
  }

  console.log(`Migrated ${users.length} users to personal organizations`);
}
```

### 4.3 迁移后状态

| 迁移前                       | 迁移后                                      |
| ---------------------------- | ------------------------------------------- |
| User: `alice` 有 3 个项目    | → Organization: `user-alice` (isPersonal=true) |
| Project: `project1` (owner: alice) | → Project: `project1` (organizationId: org-alice-id) |

**用户体验**：
- ✅ 现有用户无感知，项目正常访问
- ✅ 用户可以继续创建个人项目
- ✅ 用户可以创建企业组织并迁移项目

---

## 5. 业务规则与约束

### 5.1 配额限制

| 资源类型       | 默认配额 | 可调整 | 超额处理            |
| -------------- | -------- | ------ | ------------------- |
| 用户组织数     | 10       | ❌      | 拒绝创建，提示升级  |
| 组织项目数     | 1000     | ✅      | Organization.maxProjects |
| 组织成员数     | 1000     | ✅      | Organization.maxMembers |
| 组织存储配额   | 100GB    | ✅      | Organization.storageQuota |
| 团队成员数     | 100      | ✅      | Team.maxMembers     |

### 5.2 软删除与恢复

**Organization 软删除**：
- 设置 `deletedAt` 时间戳，不物理删除
- 30天保护期内，SUPER_ADMIN 可恢复
- 30天后，后台任务自动物理删除

```typescript
// 软删除组织
await prisma.organization.update({
  where: { id: orgId },
  data: { deletedAt: new Date() }
});

// 恢复组织
await prisma.organization.update({
  where: { id: orgId },
  data: { deletedAt: null }
});

// 自动清理（定时任务）
const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
await prisma.organization.deleteMany({
  where: {
    deletedAt: { lte: thirtyDaysAgo }
  }
});
```

### 5.3 命名规范

**Organization Slug**:
- 2-50字符，仅支持小写字母、数字、连字符
- 不能以连字符开头或结尾
- 全局唯一

**Team Slug**:
- 2-50字符，同 Organization Slug 规则
- 组织内唯一（非全局唯一）

**验证正则**:
```typescript
const slugRegex = /^[a-z0-9]([a-z0-9-]{0,48}[a-z0-9])?$/;
```

---

## 6. API 设计规范

### 6.1 RESTful 路由设计

```
# Organization Management
GET    /api/organizations                     # 列出我加入的所有组织
POST   /api/organizations                     # 创建组织
GET    /api/organizations/:slug               # 获取组织详情
PATCH  /api/organizations/:slug               # 更新组织设置
DELETE /api/organizations/:slug               # 软删除组织

# Organization Members
GET    /api/organizations/:slug/members       # 列出成员
POST   /api/organizations/:slug/members       # 邀请成员
PATCH  /api/organizations/:slug/members/:userId  # 修改成员角色
DELETE /api/organizations/:slug/members/:userId  # 移除成员

# Team Management
GET    /api/organizations/:slug/teams         # 列出组织的所有团队
POST   /api/organizations/:slug/teams         # 创建团队
GET    /api/organizations/:slug/teams/:teamSlug  # 团队详情
PATCH  /api/organizations/:slug/teams/:teamSlug  # 更新团队设置
DELETE /api/organizations/:slug/teams/:teamSlug  # 删除团队

# Team Members
GET    /api/organizations/:slug/teams/:teamSlug/members     # 团队成员列表
POST   /api/organizations/:slug/teams/:teamSlug/members     # 添加成员
DELETE /api/organizations/:slug/teams/:teamSlug/members/:userId  # 移除成员

# Team Project Permissions
GET    /api/organizations/:slug/teams/:teamSlug/projects    # 团队被分配的项目
POST   /api/organizations/:slug/teams/:teamSlug/projects    # 分配团队到项目
PATCH  /api/organizations/:slug/teams/:teamSlug/projects/:projectId  # 修改权限
DELETE /api/organizations/:slug/teams/:teamSlug/projects/:projectId  # 移除分配

# Project Management (修改后)
GET    /api/organizations/:slug/projects      # 列出组织的所有项目
POST   /api/organizations/:slug/projects      # 在组织下创建项目
```

### 6.2 响应格式示例

```json
// GET /api/organizations/:slug
{
  "id": "clxxx",
  "name": "Alibaba Cloud",
  "slug": "alibaba-cloud",
  "description": "Alibaba Cloud DevOps Team",
  "avatar": "https://cdn.example.com/org-avatar.png",
  "website": "https://www.alibabacloud.com",
  "stats": {
    "memberCount": 256,
    "teamCount": 12,
    "projectCount": 89,
    "storageUsed": 45000000000,
    "storageQuota": 107374182400
  },
  "quotas": {
    "maxProjects": 1000,
    "maxMembers": 1000,
    "storageQuota": 107374182400
  },
  "myRole": "ADMIN",
  "isPersonal": false,
  "createdAt": "2025-10-15T10:30:00Z"
}
```

---

## 7. 前端路由设计

```
# 组织管理
/orgs                                   # 我的组织列表
/orgs/new                               # 创建组织
/orgs/:slug                             # 组织首页（项目列表）
/orgs/:slug/settings                    # 组织设置
/orgs/:slug/members                     # 成员管理
/orgs/:slug/teams                       # 团队管理

# 团队管理
/orgs/:slug/teams/:teamSlug             # 团队详情
/orgs/:slug/teams/:teamSlug/settings    # 团队设置
/orgs/:slug/teams/:teamSlug/members     # 团队成员
/orgs/:slug/teams/:teamSlug/projects    # 团队项目权限

# 项目管理（保持向后兼容）
/projects/:id                           # 项目详情（兼容个人项目）
/orgs/:slug/projects/:name              # 组织项目详情（新路由）
```

---

## 8. 技术实现要点

### 8.1 前端状态管理

```typescript
// apps/frontend/src/stores/organization-store.ts
import { create } from 'zustand';

interface OrganizationStore {
  currentOrg: Organization | null;
  organizations: Organization[];
  setCurrentOrg: (org: Organization) => void;
  fetchOrganizations: () => Promise<void>;
}

export const useOrganizationStore = create<OrganizationStore>((set) => ({
  currentOrg: null,
  organizations: [],
  setCurrentOrg: (org) => set({ currentOrg: org }),
  fetchOrganizations: async () => {
    const orgs = await fetchOrganizationsAPI();
    set({ organizations: orgs });
  }
}));
```

### 8.2 服务端缓存策略

```typescript
// 使用 TanStack Query 缓存组织数据
const { data: organizations } = useQuery({
  queryKey: ['organizations'],
  queryFn: fetchOrganizationsAPI,
  staleTime: 5 * 60 * 1000, // 5分钟
  cacheTime: 30 * 60 * 1000 // 30分钟
});
```

### 8.3 权限装饰器（NestJS）

```typescript
// apps/backend/src/common/decorators/require-org-role.decorator.ts
import { SetMetadata } from '@nestjs/common';
import { OrgRole } from '@prisma/client';

export const REQUIRE_ORG_ROLE_KEY = 'requireOrgRole';
export const RequireOrgRole = (role: OrgRole) =>
  SetMetadata(REQUIRE_ORG_ROLE_KEY, role);

// 使用示例
@Controller('organizations/:slug')
export class OrganizationsController {
  @Patch(':slug')
  @RequireOrgRole('ADMIN')
  updateOrganization(@Param('slug') slug: string) {
    // 只有 OWNER/ADMIN 可以访问
  }
}
```

---

## 9. 测试策略

### 9.1 单元测试

```typescript
describe('OrganizationService', () => {
  it('should create personal organization for new user', async () => {
    const user = await createTestUser();
    const org = await service.createPersonalOrganization(user.id);

    expect(org.isPersonal).toBe(true);
    expect(org.name).toContain(user.username);
  });

  it('should prevent user from creating more than 10 organizations', async () => {
    const user = await createTestUser();
    await createMultipleOrganizations(user.id, 10);

    await expect(
      service.createOrganization(user.id, { name: 'Org 11' })
    ).rejects.toThrow('Quota exceeded');
  });
});
```

### 9.2 E2E 测试

```typescript
// Playwright 测试
test('Admin can invite members to organization', async ({ page }) => {
  await page.goto('/orgs/test-org/members');
  await page.click('button:has-text("Invite Member")');
  await page.fill('input[name="email"]', 'newmember@example.com');
  await page.selectOption('select[name="role"]', 'MEMBER');
  await page.click('button:has-text("Send Invitation")');

  await expect(page.locator('text=Invitation sent')).toBeVisible();
});
```

---

## 10. 后续优化方向

### 10.1 Phase 2 功能增强

- [ ] **组织邮件域验证**：验证企业邮箱域名，自动批准成员加入
- [ ] **SAML SSO 集成**：支持企业单点登录
- [ ] **审计日志**：记录所有权限变更操作
- [ ] **组织计费系统**：按组织订阅不同套餐

### 10.2 性能优化

- [ ] **权限缓存**：Redis 缓存用户权限，减少数据库查询
- [ ] **批量权限检查**：优化 N+1 查询问题
- [ ] **GraphQL 支持**：复杂查询使用 GraphQL 减少请求次数

---

## 11. 总结

### 11.1 设计亮点

✅ **向后兼容**：现有个人项目无缝迁移，用户无感知
✅ **灵活权限**：三层权限体系，满足从个人到企业的所有场景
✅ **可扩展性**：预留配额字段，支持未来商业化
✅ **工程规范**：完整的索引、唯一约束、软删除机制

### 11.2 关键指标

| 指标               | 目标值       |
| ------------------ | ------------ |
| 权限检查响应时间   | < 50ms       |
| 组织列表加载时间   | < 200ms      |
| 支持最大组织规模   | 10,000+ 成员 |
| 数据库索引覆盖率   | 100%         |

---

**文档结束**
