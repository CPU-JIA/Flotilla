# 数据库设计文档

**项目名称：** 基于云计算的开发协作平台
**负责人：** JIA
**版本：** v1.0
**编写日期：** 2025-10-10

---

## 目录

1. [数据库概述](#1-数据库概述)
2. [ER图设计](#2-er图设计)
3. [Prisma Schema完整定义](#3-prisma-schema完整定义)
4. [数据表详细设计](#4-数据表详细设计)
5. [索引设计](#5-索引设计)
6. [数据约束和完整性](#6-数据约束和完整性)
7. [数据迁移策略](#7-数据迁移策略)
8. [数据安全和隐私](#8-数据安全和隐私)
9. [性能优化](#9-性能优化)
10. [备份和恢复策略](#10-备份和恢复策略)

---

## 1. 数据库概述

### 1.1 数据库选型

**主数据库：** PostgreSQL 16
**理由：**
- 功能强大的关系型数据库
- 支持JSON/JSONB类型（灵活性）
- 优秀的并发控制（MVCC）
- 支持全文搜索
- 开源且活跃的社区

**ORM工具：** Prisma 6
**理由：**
- 类型安全，自动生成TypeScript类型
- 声明式Schema定义
- 自动化数据库迁移
- 优秀的查询性能

### 1.2 数据库架构

```
PostgreSQL Cluster
├── Master (读写)
│   ├── 主要业务数据
│   └── 实时写入
└── Replicas (只读)
    ├── Replica-1: 查询负载分担
    └── Replica-2: 备份和分析
```

### 1.3 命名规范

- **表名：** 使用PascalCase（如：User, Project）
- **字段名：** 使用camelCase（如：createdAt, passwordHash）
- **外键：** 使用`xxxId`格式（如：ownerId, projectId）
- **索引：** 自动生成或使用`@@index`指定
- **枚举：** 使用SCREAMING_SNAKE_CASE（如：USER_ROLE）

---

## 2. ER图设计

### 2.1 核心实体关系图

```mermaid
erDiagram
    User ||--o{ Project : "owns"
    User ||--o{ ProjectMember : "participates"
    User ||--o{ Commit : "authors"

    Project ||--|| Repository : "has"
    Project ||--o{ ProjectMember : "has members"

    Repository ||--o{ Branch : "contains"
    Repository ||--o{ Commit : "stores"

    Branch }o--|| Commit : "points to"

    Commit ||--o{ File : "contains"
    Commit }o--|| User : "authored by"
    Commit }o--|| Repository : "belongs to"

    ProjectMember }o--|| Project : "member of"
    ProjectMember }o--|| User : "is user"

    User {
        string id PK
        string username UK
        string email UK
        string passwordHash
        string avatar
        string bio
        enum role
        datetime createdAt
        datetime updatedAt
    }

    Project {
        string id PK
        string name
        string description
        enum visibility
        string ownerId FK
        datetime createdAt
        datetime updatedAt
    }

    Repository {
        string id PK
        string projectId FK,UK
        string defaultBranch
        bigint storageUsed
        datetime createdAt
        datetime updatedAt
    }

    Branch {
        string id PK
        string repositoryId FK
        string name
        string commitId FK
        datetime createdAt
        datetime updatedAt
    }

    Commit {
        string id PK
        string repositoryId FK
        string branchId FK
        string authorId FK
        string message
        string hash UK
        datetime createdAt
    }

    File {
        string id PK
        string commitId FK
        string path
        string contentUrl
        int size
        string mimeType
        datetime createdAt
    }

    ProjectMember {
        string id PK
        string projectId FK
        string userId FK
        enum role
        datetime joinedAt
    }
```

### 2.2 枚举类型关系

```mermaid
graph LR
    User -->|role| UserRole
    Project -->|visibility| Visibility
    ProjectMember -->|role| MemberRole

    UserRole[UserRole Enum]
    UserRole -->|DEVELOPER| Dev[默认用户]
    UserRole -->|ADMIN| Admin[管理员]

    Visibility[Visibility Enum]
    Visibility -->|PRIVATE| Priv[私有项目]
    Visibility -->|PUBLIC| Pub[公开项目]

    MemberRole[MemberRole Enum]
    MemberRole -->|OWNER| Owner[拥有者]
    MemberRole -->|MEMBER| Member[成员]
    MemberRole -->|VIEWER| Viewer[查看者]
```

---

## 3. Prisma Schema完整定义

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// 枚举类型定义
// ========================================

enum UserRole {
  DEVELOPER  // 普通开发者
  ADMIN      // 系统管理员
}

enum Visibility {
  PRIVATE    // 私有项目
  PUBLIC     // 公开项目
}

enum MemberRole {
  OWNER      // 项目拥有者
  MEMBER     // 项目成员（读写权限）
  VIEWER     // 访客（只读权限）
}

// ========================================
// 用户模块
// ========================================

model User {
  id           String   @id @default(cuid())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @db.VarChar(255)
  avatar       String?  @db.VarChar(500)
  bio          String?  @db.Text
  role         UserRole @default(DEVELOPER)

  createdAt    DateTime @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime @updatedAt @db.Timestamptz(3)

  // 关系
  ownedProjects  Project[]        @relation("ProjectOwner")
  projectMembers ProjectMember[]
  commits        Commit[]

  @@index([email])
  @@index([username])
  @@index([createdAt])
  @@map("users")
}

// ========================================
// 项目模块
// ========================================

model Project {
  id          String     @id @default(cuid())
  name        String     @db.VarChar(100)
  description String?    @db.Text
  visibility  Visibility @default(PRIVATE)
  ownerId     String

  createdAt   DateTime   @default(now()) @db.Timestamptz(3)
  updatedAt   DateTime   @updatedAt @db.Timestamptz(3)

  // 关系
  owner      User            @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  repository Repository?
  members    ProjectMember[]

  @@unique([ownerId, name], name: "project_owner_name_unique")
  @@index([ownerId])
  @@index([visibility])
  @@index([createdAt])
  @@index([updatedAt])
  @@map("projects")
}

// ========================================
// 仓库模块
// ========================================

model Repository {
  id            String   @id @default(cuid())
  projectId     String   @unique
  defaultBranch String   @default("main") @db.VarChar(100)
  storageUsed   BigInt   @default(0)

  createdAt     DateTime @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime @updatedAt @db.Timestamptz(3)

  // 关系
  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branches Branch[]
  commits  Commit[]

  @@index([projectId])
  @@index([createdAt])
  @@map("repositories")
}

model Branch {
  id           String   @id @default(cuid())
  repositoryId String
  name         String   @db.VarChar(100)
  commitId     String?

  createdAt    DateTime @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime @updatedAt @db.Timestamptz(3)

  // 关系
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  commit     Commit?    @relation("BranchCommit", fields: [commitId], references: [id])
  commits    Commit[]   @relation("CommitBranch")

  @@unique([repositoryId, name], name: "branch_repo_name_unique")
  @@index([repositoryId])
  @@index([commitId])
  @@map("branches")
}

model Commit {
  id           String   @id @default(cuid())
  repositoryId String
  branchId     String
  authorId     String
  message      String   @db.Text
  hash         String   @unique @db.VarChar(64)
  parentHash   String?  @db.VarChar(64)

  createdAt    DateTime @default(now()) @db.Timestamptz(3)

  // 关系
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  branch     Branch     @relation("CommitBranch", fields: [branchId], references: [id])
  author     User       @relation(fields: [authorId], references: [id])
  files      File[]
  pointedByBranches Branch[] @relation("BranchCommit")

  @@index([repositoryId])
  @@index([branchId])
  @@index([authorId])
  @@index([hash])
  @@index([createdAt])
  @@map("commits")
}

model File {
  id         String   @id @default(cuid())
  commitId   String
  path       String   @db.VarChar(500)
  contentUrl String   @db.Text
  size       Int
  mimeType   String   @db.VarChar(100)

  createdAt  DateTime @default(now()) @db.Timestamptz(3)

  // 关系
  commit Commit @relation(fields: [commitId], references: [id], onDelete: Cascade)

  @@unique([commitId, path], name: "file_commit_path_unique")
  @@index([commitId])
  @@index([path])
  @@map("files")
}

// ========================================
// 协作模块
// ========================================

model ProjectMember {
  id        String     @id @default(cuid())
  projectId String
  userId    String
  role      MemberRole @default(MEMBER)

  joinedAt  DateTime   @default(now()) @db.Timestamptz(3)

  // 关系
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId], name: "member_project_user_unique")
  @@index([projectId])
  @@index([userId])
  @@index([role])
  @@map("project_members")
}

// ========================================
// Raft共识模块（元数据）
// ========================================

model RaftLog {
  id        String   @id @default(cuid())
  term      Int
  index     Int      @unique
  command   String   @db.Text
  committed Boolean  @default(false)

  createdAt DateTime @default(now()) @db.Timestamptz(3)

  @@index([term])
  @@index([index])
  @@index([committed])
  @@map("raft_logs")
}

model RaftState {
  id           String   @id @default(cuid())
  nodeId       String   @unique @db.VarChar(100)
  currentTerm  Int      @default(0)
  votedFor     String?  @db.VarChar(100)
  commitIndex  Int      @default(0)
  lastApplied  Int      @default(0)

  updatedAt    DateTime @updatedAt @db.Timestamptz(3)

  @@map("raft_states")
}
```

---

## 4. 数据表详细设计

### 4.1 用户表（users）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 用户唯一标识 |
| username | VARCHAR | 50 | UNIQUE, NOT NULL | - | 用户名（3-20字符） |
| email | VARCHAR | 255 | UNIQUE, NOT NULL | - | 邮箱地址 |
| passwordHash | VARCHAR | 255 | NOT NULL | - | Bcrypt加密的密码 |
| avatar | VARCHAR | 500 | NULL | NULL | 头像URL |
| bio | TEXT | - | NULL | NULL | 个人简介 |
| role | ENUM | - | NOT NULL | DEVELOPER | 用户角色 |
| createdAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 创建时间 |
| updatedAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 更新时间 |

**业务规则：**
- username必须唯一，3-20个字符，只能包含字母、数字、下划线
- email必须唯一且符合邮箱格式
- passwordHash使用bcrypt加密，salt rounds=12
- 删除用户时级联删除其创建的项目和成员记录

### 4.2 项目表（projects）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 项目唯一标识 |
| name | VARCHAR | 100 | NOT NULL | - | 项目名称 |
| description | TEXT | - | NULL | NULL | 项目描述 |
| visibility | ENUM | - | NOT NULL | PRIVATE | 可见性 |
| ownerId | VARCHAR | 25 | FK, NOT NULL | - | 拥有者ID |
| createdAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 创建时间 |
| updatedAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 更新时间 |

**业务规则：**
- 同一用户下项目名称唯一（UNIQUE约束：ownerId + name）
- visibility默认为PRIVATE
- 删除项目时级联删除Repository和ProjectMember

### 4.3 仓库表（repositories）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 仓库唯一标识 |
| projectId | VARCHAR | 25 | FK, UNIQUE, NOT NULL | - | 关联项目ID |
| defaultBranch | VARCHAR | 100 | NOT NULL | "main" | 默认分支名 |
| storageUsed | BIGINT | - | NOT NULL | 0 | 已使用存储（字节） |
| createdAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 创建时间 |
| updatedAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 更新时间 |

**业务规则：**
- 一个项目只能有一个仓库（projectId UNIQUE）
- storageUsed在上传文件时自动累加
- 删除Repository时级联删除所有Branch、Commit、File

### 4.4 分支表（branches）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 分支唯一标识 |
| repositoryId | VARCHAR | 25 | FK, NOT NULL | - | 所属仓库ID |
| name | VARCHAR | 100 | NOT NULL | - | 分支名称 |
| commitId | VARCHAR | 25 | FK, NULL | NULL | 当前指向的Commit |
| createdAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 创建时间 |
| updatedAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 更新时间 |

**业务规则：**
- 同一仓库下分支名称唯一（UNIQUE约束：repositoryId + name）
- commitId可以为NULL（初始化时）
- 不能删除defaultBranch

### 4.5 提交表（commits）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 提交唯一标识 |
| repositoryId | VARCHAR | 25 | FK, NOT NULL | - | 所属仓库ID |
| branchId | VARCHAR | 25 | FK, NOT NULL | - | 所属分支ID |
| authorId | VARCHAR | 25 | FK, NOT NULL | - | 作者ID |
| message | TEXT | - | NOT NULL | - | 提交信息 |
| hash | VARCHAR | 64 | UNIQUE, NOT NULL | - | SHA-256 hash |
| parentHash | VARCHAR | 64 | NULL | NULL | 父提交hash |
| createdAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 创建时间 |

**业务规则：**
- hash全局唯一，使用SHA-256生成
- parentHash用于构建提交历史链
- 删除Commit时级联删除所有File记录

### 4.6 文件表（files）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 文件唯一标识 |
| commitId | VARCHAR | 25 | FK, NOT NULL | - | 所属提交ID |
| path | VARCHAR | 500 | NOT NULL | - | 文件路径 |
| contentUrl | TEXT | - | NOT NULL | - | MinIO存储URL |
| size | INT | - | NOT NULL | - | 文件大小（字节） |
| mimeType | VARCHAR | 100 | NOT NULL | - | MIME类型 |
| createdAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 创建时间 |

**业务规则：**
- 同一Commit下文件路径唯一（UNIQUE约束：commitId + path）
- contentUrl指向MinIO对象存储
- size用于计算Repository的storageUsed

### 4.7 项目成员表（project_members）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 成员记录唯一标识 |
| projectId | VARCHAR | 25 | FK, NOT NULL | - | 项目ID |
| userId | VARCHAR | 25 | FK, NOT NULL | - | 用户ID |
| role | ENUM | - | NOT NULL | MEMBER | 成员角色 |
| joinedAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 加入时间 |

**业务规则：**
- 同一用户在同一项目中只能有一个角色（UNIQUE约束：projectId + userId）
- 项目至少保留一个OWNER
- 删除用户或项目时级联删除成员记录

### 4.8 Raft日志表（raft_logs）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 日志唯一标识 |
| term | INT | - | NOT NULL | - | 任期号 |
| index | INT | - | UNIQUE, NOT NULL | - | 日志索引 |
| command | TEXT | - | NOT NULL | - | 操作命令（JSON） |
| committed | BOOLEAN | - | NOT NULL | false | 是否已提交 |
| createdAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 创建时间 |

**业务规则：**
- index全局唯一且递增
- command存储为JSON格式，包含操作类型和参数
- committed标记日志是否已被大多数节点确认

### 4.9 Raft状态表（raft_states）

| 字段名 | 类型 | 长度 | 约束 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | VARCHAR | 25 | PK | cuid() | 状态唯一标识 |
| nodeId | VARCHAR | 100 | UNIQUE, NOT NULL | - | 节点ID |
| currentTerm | INT | - | NOT NULL | 0 | 当前任期 |
| votedFor | VARCHAR | 100 | NULL | NULL | 投票给谁 |
| commitIndex | INT | - | NOT NULL | 0 | 已提交日志索引 |
| lastApplied | INT | - | NOT NULL | 0 | 已应用日志索引 |
| updatedAt | TIMESTAMPTZ | 3 | NOT NULL | now() | 更新时间 |

**业务规则：**
- 每个节点只有一条状态记录（nodeId UNIQUE）
- currentTerm在选举时递增
- votedFor在每个任期内最多投一票

---

## 5. 索引设计

### 5.1 主键索引

所有表的`id`字段自动创建PRIMARY KEY索引（B-Tree）。

### 5.2 唯一索引

| 表名 | 字段 | 索引类型 | 说明 |
|------|------|----------|------|
| users | username | UNIQUE | 用户名唯一 |
| users | email | UNIQUE | 邮箱唯一 |
| projects | (ownerId, name) | UNIQUE COMPOSITE | 同一用户下项目名唯一 |
| repositories | projectId | UNIQUE | 一对一关系 |
| branches | (repositoryId, name) | UNIQUE COMPOSITE | 同一仓库下分支名唯一 |
| commits | hash | UNIQUE | Commit hash唯一 |
| files | (commitId, path) | UNIQUE COMPOSITE | 同一提交下文件路径唯一 |
| project_members | (projectId, userId) | UNIQUE COMPOSITE | 用户在项目中唯一 |
| raft_logs | index | UNIQUE | 日志索引唯一 |
| raft_states | nodeId | UNIQUE | 节点状态唯一 |

### 5.3 普通索引

| 表名 | 字段 | 索引类型 | 原因 |
|------|------|----------|------|
| users | email | B-Tree | 登录时按邮箱查询 |
| users | username | B-Tree | 登录时按用户名查询 |
| users | createdAt | B-Tree | 按注册时间排序 |
| projects | ownerId | B-Tree | 查询用户的项目 |
| projects | visibility | B-Tree | 查询公开项目 |
| projects | createdAt | B-Tree | 按创建时间排序 |
| projects | updatedAt | B-Tree | 按更新时间排序 |
| repositories | projectId | B-Tree | 外键查询 |
| branches | repositoryId | B-Tree | 查询仓库的分支 |
| branches | commitId | B-Tree | 外键查询 |
| commits | repositoryId | B-Tree | 查询仓库的提交 |
| commits | branchId | B-Tree | 查询分支的提交 |
| commits | authorId | B-Tree | 查询用户的提交 |
| commits | hash | B-Tree | 按hash查询提交 |
| commits | createdAt | B-Tree | 按时间排序提交历史 |
| files | commitId | B-Tree | 查询提交的文件 |
| files | path | B-Tree | 按路径搜索文件 |
| project_members | projectId | B-Tree | 查询项目的成员 |
| project_members | userId | B-Tree | 查询用户参与的项目 |
| project_members | role | B-Tree | 按角色过滤成员 |
| raft_logs | term | B-Tree | 按任期查询日志 |
| raft_logs | index | B-Tree | 按索引查询日志 |
| raft_logs | committed | B-Tree | 查询未提交的日志 |

### 5.4 全文搜索索引（未来扩展）

```sql
-- 为项目名称和描述创建全文搜索索引
CREATE INDEX projects_fulltext_idx ON projects USING GIN (
  to_tsvector('english', name || ' ' || COALESCE(description, ''))
);

-- 为文件路径创建全文搜索索引
CREATE INDEX files_path_fulltext_idx ON files USING GIN (
  to_tsvector('english', path)
);
```

---

## 6. 数据约束和完整性

### 6.1 主键约束

所有表都有`id`字段作为主键，使用`cuid()`生成唯一标识。

### 6.2 外键约束

| 子表 | 外键字段 | 父表 | 引用字段 | 级联操作 |
|------|----------|------|----------|----------|
| projects | ownerId | users | id | ON DELETE CASCADE |
| repositories | projectId | projects | id | ON DELETE CASCADE |
| branches | repositoryId | repositories | id | ON DELETE CASCADE |
| branches | commitId | commits | id | ON DELETE SET NULL |
| commits | repositoryId | repositories | id | ON DELETE CASCADE |
| commits | branchId | branches | id | ON DELETE RESTRICT |
| commits | authorId | users | id | ON DELETE RESTRICT |
| files | commitId | commits | id | ON DELETE CASCADE |
| project_members | projectId | projects | id | ON DELETE CASCADE |
| project_members | userId | users | id | ON DELETE CASCADE |

**级联删除说明：**
- 删除用户 → 删除其拥有的项目（CASCADE）
- 删除项目 → 删除仓库、成员记录（CASCADE）
- 删除仓库 → 删除分支、提交、文件（CASCADE）
- 删除提交 → 删除文件记录（CASCADE）
- 删除分支 → 不能删除被引用的分支（RESTRICT）

### 6.3 检查约束（应用层实现）

以下约束在应用层通过Zod/class-validator验证：

```typescript
// 用户名验证
username: z.string()
  .min(3, "用户名至少3个字符")
  .max(20, "用户名最多20个字符")
  .regex(/^[a-zA-Z0-9_]+$/, "用户名只能包含字母、数字、下划线")

// 邮箱验证
email: z.string().email("无效的邮箱格式")

// 密码强度验证
password: z.string()
  .min(8, "密码至少8个字符")
  .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/, "密码必须包含大小写字母和数字")

// 项目名称验证
projectName: z.string()
  .min(2, "项目名至少2个字符")
  .max(50, "项目名最多50个字符")
  .regex(/^[a-zA-Z0-9_-]+$/, "项目名只能包含字母、数字、下划线、连字符")

// 文件大小验证
fileSize: z.number()
  .max(100 * 1024 * 1024, "单个文件最大100MB")
```

### 6.4 NOT NULL约束

关键字段设置为NOT NULL：
- 所有ID字段（id, ownerId, projectId等）
- 用户凭据（username, email, passwordHash）
- 必要的描述字段（name, message）
- 时间戳字段（createdAt, updatedAt）

---

## 7. 数据迁移策略

### 7.1 Prisma Migrate工作流

```bash
# 1. 开发环境：创建并应用迁移
pnpm prisma migrate dev --name add_user_bio

# 2. 生成Prisma Client
pnpm prisma generate

# 3. 生产环境：应用迁移
pnpm prisma migrate deploy

# 4. 重置数据库（仅开发环境）
pnpm prisma migrate reset
```

### 7.2 迁移命名规范

```
<timestamp>_<descriptive_name>

示例：
20251010120000_init_database
20251011153000_add_user_bio
20251012094500_add_raft_tables
20251015163000_add_file_mime_type
```

### 7.3 数据迁移脚本示例

```typescript
// migrations/seed.ts
import { PrismaClient } from '@prisma/client'
import * as bcrypt from 'bcrypt'

const prisma = new PrismaClient()

async function main() {
  // 创建管理员用户
  const adminPassword = await bcrypt.hash('Admin@123456', 12)
  const admin = await prisma.user.upsert({
    where: { email: 'admin@example.com' },
    update: {},
    create: {
      username: 'admin',
      email: 'admin@example.com',
      passwordHash: adminPassword,
      role: 'ADMIN',
    },
  })

  console.log('Admin user created:', admin)

  // 创建测试项目
  const testProject = await prisma.project.create({
    data: {
      name: 'test-project',
      description: '测试项目',
      visibility: 'PUBLIC',
      ownerId: admin.id,
      repository: {
        create: {
          defaultBranch: 'main',
        },
      },
    },
  })

  console.log('Test project created:', testProject)
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

### 7.4 回滚策略

```bash
# 查看迁移历史
pnpm prisma migrate status

# 回滚到指定迁移（谨慎使用）
# 注意：Prisma不支持自动回滚，需要手动创建回滚迁移

# 手动回滚步骤：
# 1. 创建新的迁移文件撤销更改
pnpm prisma migrate dev --name revert_add_user_bio --create-only

# 2. 手动编辑SQL文件，添加回滚逻辑
# 3. 应用迁移
pnpm prisma migrate dev
```

---

## 8. 数据安全和隐私

### 8.1 敏感数据加密

| 字段 | 加密方式 | 说明 |
|------|----------|------|
| passwordHash | Bcrypt (salt rounds=12) | 单向Hash，不可逆 |
| email | 明文存储，传输加密 | HTTPS传输 |
| 文件内容 | 存储在MinIO，支持加密 | AES-256加密 |

### 8.2 数据访问控制

```typescript
// Row-Level Security示例（应用层实现）
class ProjectService {
  async getProject(projectId: string, userId: string) {
    const project = await prisma.project.findUnique({
      where: { id: projectId },
      include: { members: true },
    })

    // 权限检查
    if (project.visibility === 'PRIVATE') {
      const isMember = project.members.some(m => m.userId === userId)
      if (!isMember && project.ownerId !== userId) {
        throw new ForbiddenException('无权访问此项目')
      }
    }

    return project
  }
}
```

### 8.3 数据脱敏

```typescript
// 日志脱敏
function sanitizeForLog(user: User) {
  return {
    id: user.id,
    username: user.username,
    email: user.email.replace(/(.{3}).*(@.*)/, '$1***$2'), // 邮箱脱敏
    // 不记录passwordHash
  }
}
```

### 8.4 审计日志（未来扩展）

```prisma
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String   // CREATE, UPDATE, DELETE
  resource  String   // Project, File, etc.
  resourceId String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}
```

---

## 9. 性能优化

### 9.1 查询优化

**1. 使用索引覆盖查询**
```typescript
// 好的做法：只查询需要的字段
const users = await prisma.user.findMany({
  select: {
    id: true,
    username: true,
    avatar: true,
  },
})

// 避免：SELECT *
```

**2. 避免N+1查询**
```typescript
// 使用include预加载关系
const projects = await prisma.project.findMany({
  include: {
    owner: true,
    repository: {
      include: {
        branches: true,
      },
    },
  },
})
```

**3. 使用分页**
```typescript
const projects = await prisma.project.findMany({
  skip: (page - 1) * pageSize,
  take: pageSize,
  orderBy: { createdAt: 'desc' },
})
```

### 9.2 连接池配置

```env
# .env
DATABASE_URL="postgresql://user:pass@localhost:5432/db?schema=public&connection_limit=20&pool_timeout=20"
```

### 9.3 批量操作

```typescript
// 批量插入
await prisma.file.createMany({
  data: files.map(f => ({
    commitId,
    path: f.path,
    contentUrl: f.url,
    size: f.size,
    mimeType: f.mimeType,
  })),
  skipDuplicates: true,
})
```

### 9.4 数据库读写分离

```typescript
// prisma/client.ts
import { PrismaClient } from '@prisma/client'

// 写库连接
export const prismaMaster = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_MASTER_URL,
    },
  },
})

// 读库连接
export const prismaReplica = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_REPLICA_URL,
    },
  },
})

// 使用示例
export class UserService {
  async findUser(id: string) {
    return prismaReplica.user.findUnique({ where: { id } })
  }

  async createUser(data: CreateUserDto) {
    return prismaMaster.user.create({ data })
  }
}
```

---

## 10. 备份和恢复策略

### 10.1 备份策略

**全量备份（每日）**
```bash
#!/bin/bash
# backup-full.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups/postgresql"
DB_NAME="devplatform"

pg_dump -U postgres -d $DB_NAME -F c -b -v -f "$BACKUP_DIR/full_$DATE.backup"

# 保留最近7天的备份
find $BACKUP_DIR -name "full_*.backup" -mtime +7 -delete
```

**增量备份（每小时）**
```bash
# 使用WAL归档实现增量备份
# postgresql.conf配置：
# wal_level = replica
# archive_mode = on
# archive_command = 'cp %p /backups/wal_archive/%f'
```

### 10.2 恢复策略

**从全量备份恢复**
```bash
# 停止应用
kubectl scale deployment backend --replicas=0

# 恢复数据库
pg_restore -U postgres -d devplatform -c /backups/postgresql/full_20251010_120000.backup

# 启动应用
kubectl scale deployment backend --replicas=3
```

**时间点恢复（PITR）**
```bash
# 恢复到特定时间点
pg_restore -U postgres -d devplatform /backups/postgresql/full_20251010_120000.backup

# 应用WAL日志到指定时间
# recovery.conf:
# restore_command = 'cp /backups/wal_archive/%f %p'
# recovery_target_time = '2025-10-10 15:30:00'
```

### 10.3 灾难恢复计划

| RTO (Recovery Time Objective) | RPO (Recovery Point Objective) |
|-------------------------------|--------------------------------|
| < 5分钟 | < 1分钟 |

**步骤：**
1. 检测故障（自动健康检查）
2. 切换到Replica节点（自动故障转移）
3. 从备份恢复Master（如需要）
4. 验证数据完整性
5. 恢复正常服务

---

## 11. 数据库维护

### 11.1 定期维护任务

**每日任务**
```sql
-- 更新统计信息
ANALYZE;

-- 清理死行（自动VACUUM已启用）
-- PostgreSQL会自动执行，无需手动
```

**每周任务**
```sql
-- 全量VACUUM（释放磁盘空间）
VACUUM FULL;

-- 重建索引（如有碎片）
REINDEX DATABASE devplatform;
```

**每月任务**
```sql
-- 检查表膨胀
SELECT schemaname, tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 检查未使用的索引
SELECT schemaname, tablename, indexname, idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0 AND indexname NOT LIKE '%_pkey';
```

### 11.2 监控指标

| 指标 | 告警阈值 | 说明 |
|------|----------|------|
| 连接数 | > 80% | 接近连接池上限 |
| 慢查询 | > 1s | 查询性能问题 |
| 缓存命中率 | < 95% | 内存不足或查询效率低 |
| 复制延迟 | > 10s | Replica同步延迟 |
| 磁盘使用率 | > 80% | 需要扩容 |

---

## 12. 附录

### 12.1 数据库配置参数

```conf
# postgresql.conf 推荐配置

# 连接和认证
max_connections = 100
superuser_reserved_connections = 3

# 内存设置（16GB RAM服务器）
shared_buffers = 4GB
effective_cache_size = 12GB
work_mem = 64MB
maintenance_work_mem = 1GB

# WAL设置
wal_level = replica
max_wal_senders = 5
wal_keep_size = 1GB

# 检查点
checkpoint_timeout = 15min
max_wal_size = 2GB
min_wal_size = 1GB

# 查询优化
random_page_cost = 1.1  # 适用于SSD
effective_io_concurrency = 200

# 日志
log_destination = 'csvlog'
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_min_duration_statement = 1000  # 记录超过1秒的查询
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 自动VACUUM
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
```

### 12.2 常用SQL查询

**查看表大小**
```sql
SELECT
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
  pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS index_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

**查看慢查询**
```sql
SELECT
  query,
  calls,
  total_exec_time,
  mean_exec_time,
  max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

**查看锁等待**
```sql
SELECT
  blocked_locks.pid AS blocked_pid,
  blocked_activity.usename AS blocked_user,
  blocking_locks.pid AS blocking_pid,
  blocking_activity.usename AS blocking_user,
  blocked_activity.query AS blocked_statement,
  blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

---

**文档版本历史**

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-10-10 | 初始版本 | JIA |

**文档结束**
