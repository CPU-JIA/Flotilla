# 数据库设计文档

**项目名称：** 基于云计算的开发协作平台（Flotilla）
**负责人：** JIA
**版本：** v2.0（基于实现状态更新）
**编写日期：** 2025-10-10
**最后更新：** 2025-12-22

---

> **实现状态说明**: ✅ 已实现 | ⚠️ 部分实现 | ❌ 未实现
>
> 本文档已根据实际 `prisma/schema.prisma` 更新，当前数据库包含 **33个数据模型** 和 **17个枚举类型**。

---

## 目录

1. [数据库概述](#1-数据库概述)
2. [ER图设计](#2-er图设计)
3. [Prisma Schema完整定义](#3-prisma-schema完整定义)
4. [数据表详细设计](#4-数据表详细设计)
5. [索引设计](#5-索引设计)
6. [数据约束和完整性](#6-数据约束和完整性)
7. [数据迁移策略](#7-数据迁移策略)
8. [数据安全和隐私](#8-数据安全和隐私)
9. [性能优化](#9-性能优化)
10. [备份和恢复策略](#10-备份和恢复策略)

---

## 1. 数据库概述

### 1.1 数据库选型

**主数据库：** PostgreSQL 16
**理由：**
- 功能强大的关系型数据库
- 支持JSON/JSONB类型（灵活性）
- 优秀的并发控制（MVCC）
- 支持全文搜索
- 开源且活跃的社区

**ORM工具：** Prisma 6
**理由：**
- 类型安全，自动生成TypeScript类型
- 声明式Schema定义
- 自动化数据库迁移
- 优秀的查询性能

### 1.2 数据库架构

```
PostgreSQL Cluster
├── Master (读写)
│   ├── 主要业务数据
│   └── 实时写入
└── Replicas (只读)
    ├── Replica-1: 查询负载分担
    └── Replica-2: 备份和分析
```

### 1.3 命名规范

- **表名：** 使用PascalCase（如：User, Project）
- **字段名：** 使用camelCase（如：createdAt, passwordHash）
- **外键：** 使用`xxxId`格式（如：ownerId, projectId）
- **索引：** 自动生成或使用`@@index`指定
- **枚举：** 使用SCREAMING_SNAKE_CASE（如：USER_ROLE）

---

## 2. ER图设计

### 2.1 完整实体关系图（已实现）

```mermaid
erDiagram
    %% 用户模块
    User ||--o{ Organization : "创建"
    User ||--o{ OrganizationMember : "加入组织"
    User ||--o{ TeamMember : "加入团队"
    User ||--o{ Project : "拥有"
    User ||--o{ ProjectMember : "参与项目"
    User ||--o{ Commit : "提交代码"
    User ||--o{ Issue : "创建Issue"
    User ||--o{ PullRequest : "创建PR"
    User ||--o{ PasswordHistory : "密码历史"
    User ||--o{ UserSession : "登录会话"
    User ||--o{ AuditLog : "审计日志"
    User ||--o{ Notification : "接收通知"

    %% 组织与团队
    Organization ||--o{ OrganizationMember : "有成员"
    Organization ||--o{ Team : "包含团队"
    Organization ||--o{ Project : "拥有项目"
    Team ||--o{ TeamMember : "有成员"
    Team ||--o{ TeamProjectPermission : "项目权限"

    %% 项目模块
    Project ||--|| Repository : "有仓库"
    Project ||--o{ ProjectMember : "有成员"
    Project ||--o{ ProjectFile : "上传文件"
    Project ||--o{ Issue : "有Issue"
    Project ||--o{ PullRequest : "有PR"
    Project ||--o{ Label : "有标签"
    Project ||--o{ Milestone : "有里程碑"
    Project ||--o{ BranchProtectionRule : "分支保护"
    Project ||--o{ TeamProjectPermission : "团队权限"

    %% 仓库模块
    Repository ||--o{ Branch : "有分支"
    Repository ||--o{ Commit : "有提交"
    Repository ||--o{ File : "有文件"
    Repository ||--o{ SearchMetadata : "搜索索引"

    %% Issue模块
    Issue ||--o{ IssueComment : "有评论"
    Issue ||--o{ IssueEvent : "有事件"
    Issue ||--o{ IssueAssignee : "有分配人"
    Issue }o--o| Milestone : "属于里程碑"

    %% PR模块
    PullRequest ||--o{ PRReview : "有审查"
    PullRequest ||--o{ PRComment : "有评论"
    PullRequest ||--o{ PREvent : "有事件"
    PullRequest ||--o{ PRAssignee : "有分配人"

    %% 核心实体字段
    User {
        string id PK
        string username UK
        string email UK
        string passwordHash
        enum role "USER/SUPER_ADMIN"
        boolean emailVerified
        int tokenVersion
    }

    Organization {
        string id PK
        string slug UK
        string name
        int maxProjects
        int maxMembers
        bigint storageQuota
    }

    Project {
        string id PK
        string name
        enum visibility
        string ownerId FK
        string organizationId FK
        boolean isArchived
    }

    Issue {
        string id PK
        int number
        string title
        enum state "OPEN/CLOSED"
        string authorId FK
    }

    PullRequest {
        string id PK
        int number
        string title
        enum state "OPEN/MERGED/CLOSED"
        string sourceBranch
        string targetBranch
    }
```

### 2.2 枚举类型一览（17个）

| 枚举类型 | 值 | 用途 |
|---------|-----|------|
| **UserRole** | USER, SUPER_ADMIN | 平台角色 |
| **OrgRole** | OWNER, ADMIN, MEMBER | 组织角色 |
| **TeamRole** | MAINTAINER, MEMBER | 团队角色 |
| **MemberRole** | OWNER, MAINTAINER, MEMBER, VIEWER | 项目角色 |
| **ProjectVisibility** | PUBLIC, PRIVATE | 项目可见性 |
| **IssueState** | OPEN, CLOSED | Issue状态 |
| **PRState** | OPEN, MERGED, CLOSED | PR状态 |
| **ReviewState** | APPROVED, CHANGES_REQUESTED, COMMENTED | 审查状态 |
| **MergeStrategy** | MERGE, SQUASH, REBASE | 合并策略 |
| **MilestoneState** | OPEN, CLOSED | 里程碑状态 |
| **RaftNodeState** | FOLLOWER, CANDIDATE, LEADER | Raft节点状态 |
| **IndexStatus** | PENDING, INDEXING, INDEXED, FAILED, OUTDATED | 搜索索引状态 |
| **NotificationType** | PR_CREATED, PR_MERGED, ISSUE_MENTIONED, ... | 通知类型 |
| **AuditAction** | CREATE, UPDATE, DELETE, LOGIN, LOGOUT, ... | 审计操作类型 |
| **AuditEntityType** | USER, PROJECT, REPOSITORY, ISSUE, PR, ... | 审计实体类型 |

---

## 3. Prisma Schema完整定义

> **完整 Schema 请查看**: `apps/backend/prisma/schema.prisma`（1000+ 行）
>
> 以下为模型分类概览：

### 3.1 数据模型分类（33个）

#### 用户与认证模块 ✅
| 模型 | 说明 |
|------|------|
| **User** | 用户表（邮箱验证、密码重置、token版本控制） |
| **PasswordHistory** | 密码历史记录（防止重用旧密码，CWE-521） |
| **UserSession** | 用户会话（设备管理、异地登录检测） |

#### 组织与团队模块 ✅
| 模型 | 说明 |
|------|------|
| **Organization** | 组织（配额、软删除） |
| **OrganizationMember** | 组织成员（OWNER/ADMIN/MEMBER） |
| **Team** | 团队 |
| **TeamMember** | 团队成员（MAINTAINER/MEMBER） |
| **TeamProjectPermission** | 团队项目权限映射 |

#### 项目与仓库模块 ✅
| 模型 | 说明 |
|------|------|
| **Project** | 项目（归档、PR审批设置） |
| **ProjectMember** | 项目成员（四级角色） |
| **Repository** | 仓库 |
| **Branch** | 分支 |
| **Commit** | 提交 |
| **File** | 仓库文件 |
| **ProjectFile** | 项目上传文件（MinIO） |

#### Issue追踪模块 ✅
| 模型 | 说明 |
|------|------|
| **Issue** | Issue |
| **Label** | 标签 |
| **Milestone** | 里程碑 |
| **IssueComment** | Issue评论 |
| **IssueAssignee** | Issue被分配人（关联表） |
| **IssueEvent** | Issue事件日志 |

#### Pull Request模块 ✅
| 模型 | 说明 |
|------|------|
| **PullRequest** | PR（源分支、目标分支、合并策略） |
| **PRReview** | PR审查（APPROVED/CHANGES_REQUESTED/COMMENTED） |
| **PRComment** | PR评论（支持行级评论） |
| **PRAssignee** | PR被分配人（关联表） |
| **PREvent** | PR事件日志 |

#### 代码搜索模块 ✅
| 模型 | 说明 |
|------|------|
| **SearchMetadata** | 文件索引元数据（MeiliSearch集成） |

#### 通知模块 ✅
| 模型 | 说明 |
|------|------|
| **Notification** | 通知记录 |
| **NotificationPreference** | 用户通知偏好（1:1关系） |

#### 分支保护模块 ✅
| 模型 | 说明 |
|------|------|
| **BranchProtectionRule** | 分支保护规则（审批数、强推禁止等） |

#### Raft共识模块 ✅
| 模型 | 说明 |
|------|------|
| **RaftLog** | Raft日志 |
| **RaftState** | Raft节点状态 |

#### 审计日志模块 ✅
| 模型 | 说明 |
|------|------|
| **AuditLog** | 安全审计日志（SOC2/ISO27001合规） |

### 3.2 核心模型示例（User）

```prisma
model User {
  id           String   @id @default(cuid())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @db.VarChar(255)
  avatar       String?  @db.VarChar(500)
  bio          String?  @db.Text
  role         UserRole @default(USER)
  isActive     Boolean  @default(true) // 账户封禁

  // 邮箱验证
  emailVerified      Boolean   @default(false)
  emailVerifyToken   String?   @unique @db.VarChar(255)
  emailVerifyExpires DateTime?

  // 密码重置
  passwordResetToken   String?   @unique @db.VarChar(255)
  passwordResetExpires DateTime?

  // Token版本控制（CWE-613防护）
  tokenVersion Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关系（20+）
  ownedProjects       Project[]
  projectMembers      ProjectMember[]
  organizationMembers OrganizationMember[]
  teamMembers         TeamMember[]
  commits             Commit[]
  authoredIssues      Issue[]
  authoredPRs         PullRequest[]
  notifications       Notification[]
  auditLogs           AuditLog[]
  passwordHistories   PasswordHistory[]
  sessions            UserSession[]
  // ... 更多关系

  @@index([email])
  @@index([username])
  @@map("users")
}
```

---

## 4. 数据表详细设计

> **说明**：以下仅列出核心表和新增表的设计。完整字段定义请参考 `prisma/schema.prisma`。

### 4.1 用户表（users）✅ 已更新

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | cuid() 生成 |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名 |
| email | VARCHAR(255) | UNIQUE, NOT NULL | 邮箱 |
| passwordHash | VARCHAR(255) | NOT NULL | Bcrypt加密 |
| role | ENUM | NOT NULL, DEFAULT 'USER' | USER / SUPER_ADMIN |
| isActive | BOOLEAN | NOT NULL, DEFAULT true | 账户封禁状态 |
| emailVerified | BOOLEAN | DEFAULT false | 邮箱验证状态 |
| emailVerifyToken | VARCHAR(255) | UNIQUE | 邮箱验证Token |
| passwordResetToken | VARCHAR(255) | UNIQUE | 密码重置Token |
| tokenVersion | INT | DEFAULT 0 | JWT版本（CWE-613防护） |

**新增安全字段（Phase 4）**：
- `tokenVersion`: 密码重置/登出时递增，使旧Token失效
- `isActive`: 支持账户封禁功能

### 4.2 密码历史表（password_histories）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| userId | VARCHAR(25) | FK, NOT NULL | 用户ID |
| passwordHash | VARCHAR(255) | NOT NULL | 历史密码Hash |
| createdAt | TIMESTAMPTZ | NOT NULL | 记录时间 |

**业务规则**：防止用户重用最近5个密码（CWE-521）

### 4.3 用户会话表（user_sessions）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| userId | VARCHAR(25) | FK, NOT NULL | 用户ID |
| ipAddress | VARCHAR(45) | NOT NULL | IP地址 |
| userAgent | TEXT | NOT NULL | 浏览器标识 |
| device | VARCHAR(100) | | 设备类型 |
| location | VARCHAR(200) | | 地理位置 |
| tokenVersion | INT | NOT NULL | Token版本 |
| isActive | BOOLEAN | DEFAULT true | 会话状态 |
| expiresAt | TIMESTAMPTZ | NOT NULL | 过期时间 |

**用途**：设备管理、异地登录检测、会话撤销

### 4.4 组织表（organizations）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| slug | VARCHAR(100) | UNIQUE | URL友好标识 |
| name | VARCHAR(100) | NOT NULL | 组织名称 |
| maxProjects | INT | DEFAULT 1000 | 项目配额 |
| maxMembers | INT | DEFAULT 1000 | 成员配额 |
| storageQuota | BIGINT | DEFAULT 107374182400 | 存储配额(100GB) |
| isPersonal | BOOLEAN | DEFAULT false | 个人组织标识 |
| deletedAt | TIMESTAMPTZ | | 软删除时间 |

### 4.5 Issue表（issues）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| projectId | VARCHAR(25) | FK, NOT NULL | 项目ID |
| number | INT | NOT NULL | 项目内编号 |
| title | VARCHAR(500) | NOT NULL | 标题 |
| body | TEXT | | 内容(Markdown) |
| state | ENUM | DEFAULT 'OPEN' | OPEN / CLOSED |
| authorId | VARCHAR(25) | FK, NOT NULL | 作者ID |
| milestoneId | VARCHAR(25) | FK | 里程碑ID |

**唯一约束**：`(projectId, number)` - 确保编号在项目内唯一

### 4.6 Pull Request表（pull_requests）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| projectId | VARCHAR(25) | FK, NOT NULL | 项目ID |
| number | INT | NOT NULL | 项目内编号 |
| title | VARCHAR(500) | NOT NULL | 标题 |
| sourceBranch | VARCHAR(100) | NOT NULL | 源分支 |
| targetBranch | VARCHAR(100) | NOT NULL | 目标分支 |
| state | ENUM | DEFAULT 'OPEN' | OPEN / MERGED / CLOSED |
| authorId | VARCHAR(25) | FK, NOT NULL | 作者ID |
| mergedBy | VARCHAR(25) | FK | 合并者ID |
| mergeStrategy | ENUM | | MERGE / SQUASH / REBASE |
| mergeCommit | VARCHAR(64) | | 合并后的commit hash |

### 4.7 分支保护规则表（branch_protection_rules）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| projectId | VARCHAR(25) | FK, NOT NULL | 项目ID |
| branchPattern | VARCHAR(100) | NOT NULL | 分支名称模式 |
| requirePullRequest | BOOLEAN | DEFAULT true | 必须通过PR |
| requiredApprovingReviews | INT | DEFAULT 1 | 最少审批数 |
| dismissStaleReviews | BOOLEAN | DEFAULT false | 新提交作废旧审查 |
| allowForcePushes | BOOLEAN | DEFAULT false | 允许强推 |
| allowDeletions | BOOLEAN | DEFAULT false | 允许删除 |

**唯一约束**：`(projectId, branchPattern)`

### 4.8 审计日志表（audit_logs）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| action | ENUM | NOT NULL | CREATE/UPDATE/DELETE/LOGIN... |
| entityType | ENUM | NOT NULL | USER/PROJECT/REPOSITORY... |
| entityId | VARCHAR(100) | | 实体ID |
| userId | VARCHAR(100) | FK | 操作者ID |
| username | VARCHAR(50) | | 操作者用户名(冗余) |
| ipAddress | VARCHAR(45) | | IP地址 |
| userAgent | TEXT | | User-Agent |
| description | TEXT | NOT NULL | 操作描述 |
| metadata | JSON | | 额外元数据 |
| success | BOOLEAN | DEFAULT true | 操作是否成功 |

**合规要求**：SOC2要求保留至少90天

### 4.9 通知表（notifications）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| userId | VARCHAR(25) | FK, NOT NULL | 接收者ID |
| type | ENUM | NOT NULL | 通知类型 |
| title | VARCHAR(200) | NOT NULL | 标题 |
| body | TEXT | | 内容(Markdown) |
| read | BOOLEAN | DEFAULT false | 已读状态 |
| link | VARCHAR(500) | | 相关资源链接 |
| metadata | JSON | | 额外元数据 |

### 4.10 搜索元数据表（search_metadata）✅ 新增

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | VARCHAR(25) | PK | |
| fileId | VARCHAR(25) | FK, UNIQUE | 文件ID |
| projectId | VARCHAR(25) | FK | 项目ID |
| status | ENUM | DEFAULT 'PENDING' | 索引状态 |
| indexedAt | TIMESTAMPTZ | | 上次索引时间 |
| contentHash | VARCHAR(64) | | 内容SHA256 |
| symbolCount | INT | DEFAULT 0 | 符号数量 |
| lineCount | INT | DEFAULT 0 | 行数 |

**用途**：MeiliSearch代码搜索索引管理

---

## 5. 索引设计

### 5.1 主键索引

所有表的`id`字段自动创建PRIMARY KEY索引（B-Tree）。

### 5.2 唯一索引

| 表名 | 字段 | 索引类型 | 说明 |
|------|------|----------|------|
| users | username | UNIQUE | 用户名唯一 |
| users | email | UNIQUE | 邮箱唯一 |
| projects | (ownerId, name) | UNIQUE COMPOSITE | 同一用户下项目名唯一 |
| repositories | projectId | UNIQUE | 一对一关系 |
| branches | (repositoryId, name) | UNIQUE COMPOSITE | 同一仓库下分支名唯一 |
| commits | hash | UNIQUE | Commit hash唯一 |
| files | (commitId, path) | UNIQUE COMPOSITE | 同一提交下文件路径唯一 |
| project_members | (projectId, userId) | UNIQUE COMPOSITE | 用户在项目中唯一 |
| raft_logs | index | UNIQUE | 日志索引唯一 |
| raft_states | nodeId | UNIQUE | 节点状态唯一 |

### 5.3 普通索引

| 表名 | 字段 | 索引类型 | 原因 |
|------|------|----------|------|
| users | email | B-Tree | 登录时按邮箱查询 |
| users | username | B-Tree | 登录时按用户名查询 |
| users | createdAt | B-Tree | 按注册时间排序 |
| projects | ownerId | B-Tree | 查询用户的项目 |
| projects | visibility | B-Tree | 查询公开项目 |
| projects | createdAt | B-Tree | 按创建时间排序 |
| projects | updatedAt | B-Tree | 按更新时间排序 |
| repositories | projectId | B-Tree | 外键查询 |
| branches | repositoryId | B-Tree | 查询仓库的分支 |
| branches | commitId | B-Tree | 外键查询 |
| commits | repositoryId | B-Tree | 查询仓库的提交 |
| commits | branchId | B-Tree | 查询分支的提交 |
| commits | authorId | B-Tree | 查询用户的提交 |
| commits | hash | B-Tree | 按hash查询提交 |
| commits | createdAt | B-Tree | 按时间排序提交历史 |
| files | commitId | B-Tree | 查询提交的文件 |
| files | path | B-Tree | 按路径搜索文件 |
| project_members | projectId | B-Tree | 查询项目的成员 |
| project_members | userId | B-Tree | 查询用户参与的项目 |
| project_members | role | B-Tree | 按角色过滤成员 |
| raft_logs | term | B-Tree | 按任期查询日志 |
| raft_logs | index | B-Tree | 按索引查询日志 |
| raft_logs | committed | B-Tree | 查询未提交的日志 |

### 5.4 全文搜索索引（未来扩展）

```sql
-- 为项目名称和描述创建全文搜索索引
CREATE INDEX projects_fulltext_idx ON projects USING GIN (
  to_tsvector('english', name || ' ' || COALESCE(description, ''))
);

-- 为文件路径创建全文搜索索引
CREATE INDEX files_path_fulltext_idx ON files USING GIN (
  to_tsvector('english', path)
);
```

---

## 6. 数据约束和完整性

### 6.1 主键约束

所有表都有`id`字段作为主键，使用`cuid()`生成唯一标识。

### 6.2 外键约束

| 子表 | 外键字段 | 父表 | 引用字段 | 级联操作 |
|------|----------|------|----------|----------|
| projects | ownerId | users | id | ON DELETE CASCADE |
| repositories | projectId | projects | id | ON DELETE CASCADE |
| branches | repositoryId | repositories | id | ON DELETE CASCADE |
| branches | commitId | commits | id | ON DELETE SET NULL |
| commits | repositoryId | repositories | id | ON DELETE CASCADE |
| commits | branchId | branches | id | ON DELETE RESTRICT |
| commits | authorId | users | id | ON DELETE RESTRICT |
| files | commitId | commits | id | ON DELETE CASCADE |
| project_members | projectId | projects | id | ON DELETE CASCADE |
| project_members | userId | users | id | ON DELETE CASCADE |

**级联删除说明：**
- 删除用户 → 删除其拥有的项目（CASCADE）
- 删除项目 → 删除仓库、成员记录（CASCADE）
- 删除仓库 → 删除分支、提交、文件（CASCADE）
- 删除提交 → 删除文件记录（CASCADE）
- 删除分支 → 不能删除被引用的分支（RESTRICT）

### 6.3 检查约束（应用层实现）

以下约束在应用层通过Zod/class-validator验证：

```typescript
// 用户名验证
username: z.string()
  .min(3, "用户名至少3个字符")
  .max(20, "用户名最多20个字符")
  .regex(/^[a-zA-Z0-9_]+$/, "用户名只能包含字母、数字、下划线")

// 邮箱验证
email: z.string().email("无效的邮箱格式")

// 密码强度验证
password: z.string()
  .min(8, "密码至少8个字符")
  .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/, "密码必须包含大小写字母和数字")

// 项目名称验证
projectName: z.string()
  .min(2, "项目名至少2个字符")
  .max(50, "项目名最多50个字符")
  .regex(/^[a-zA-Z0-9_-]+$/, "项目名只能包含字母、数字、下划线、连字符")

// 文件大小验证
fileSize: z.number()
  .max(100 * 1024 * 1024, "单个文件最大100MB")
```

### 6.4 NOT NULL约束

关键字段设置为NOT NULL：
- 所有ID字段（id, ownerId, projectId等）
- 用户凭据（username, email, passwordHash）
- 必要的描述字段（name, message）
- 时间戳字段（createdAt, updatedAt）

---

## 7. 数据迁移策略

### 7.1 Prisma Migrate工作流

```bash
# 1. 开发环境：创建并应用迁移
pnpm prisma migrate dev --name add_user_bio

# 2. 生成Prisma Client
pnpm prisma generate

# 3. 生产环境：应用迁移
pnpm prisma migrate deploy

# 4. 重置数据库（仅开发环境）
pnpm prisma migrate reset
```

### 7.2 迁移命名规范

```
<timestamp>_<descriptive_name>

示例：
20251010120000_init_database
20251011153000_add_user_bio
20251012094500_add_raft_tables
20251015163000_add_file_mime_type
```

### 7.3 数据迁移脚本示例

```typescript
// migrations/seed.ts
import { PrismaClient } from '@prisma/client'
import * as bcrypt from 'bcrypt'

const prisma = new PrismaClient()

async function main() {
  // 创建管理员用户
  const adminPassword = await bcrypt.hash('Admin@123456', 12)
  const admin = await prisma.user.upsert({
    where: { email: 'admin@example.com' },
    update: {},
    create: {
      username: 'admin',
      email: 'admin@example.com',
      passwordHash: adminPassword,
      role: 'ADMIN',
    },
  })

  console.log('Admin user created:', admin)

  // 创建测试项目
  const testProject = await prisma.project.create({
    data: {
      name: 'test-project',
      description: '测试项目',
      visibility: 'PUBLIC',
      ownerId: admin.id,
      repository: {
        create: {
          defaultBranch: 'main',
        },
      },
    },
  })

  console.log('Test project created:', testProject)
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

### 7.4 回滚策略

```bash
# 查看迁移历史
pnpm prisma migrate status

# 回滚到指定迁移（谨慎使用）
# 注意：Prisma不支持自动回滚，需要手动创建回滚迁移

# 手动回滚步骤：
# 1. 创建新的迁移文件撤销更改
pnpm prisma migrate dev --name revert_add_user_bio --create-only

# 2. 手动编辑SQL文件，添加回滚逻辑
# 3. 应用迁移
pnpm prisma migrate dev
```

---

## 8. 数据安全和隐私

### 8.1 敏感数据加密

| 字段 | 加密方式 | 说明 |
|------|----------|------|
| passwordHash | Bcrypt (salt rounds=12) | 单向Hash，不可逆 |
| email | 明文存储，传输加密 | HTTPS传输 |
| 文件内容 | 存储在MinIO，支持加密 | AES-256加密 |

### 8.2 数据访问控制

```typescript
// Row-Level Security示例（应用层实现）
class ProjectService {
  async getProject(projectId: string, userId: string) {
    const project = await prisma.project.findUnique({
      where: { id: projectId },
      include: { members: true },
    })

    // 权限检查
    if (project.visibility === 'PRIVATE') {
      const isMember = project.members.some(m => m.userId === userId)
      if (!isMember && project.ownerId !== userId) {
        throw new ForbiddenException('无权访问此项目')
      }
    }

    return project
  }
}
```

### 8.3 数据脱敏

```typescript
// 日志脱敏
function sanitizeForLog(user: User) {
  return {
    id: user.id,
    username: user.username,
    email: user.email.replace(/(.{3}).*(@.*)/, '$1***$2'), // 邮箱脱敏
    // 不记录passwordHash
  }
}
```

### 8.4 审计日志（未来扩展）

```prisma
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String   // CREATE, UPDATE, DELETE
  resource  String   // Project, File, etc.
  resourceId String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}
```

---

## 9. 性能优化

### 9.1 查询优化

**1. 使用索引覆盖查询**
```typescript
// 好的做法：只查询需要的字段
const users = await prisma.user.findMany({
  select: {
    id: true,
    username: true,
    avatar: true,
  },
})

// 避免：SELECT *
```

**2. 避免N+1查询**
```typescript
// 使用include预加载关系
const projects = await prisma.project.findMany({
  include: {
    owner: true,
    repository: {
      include: {
        branches: true,
      },
    },
  },
})
```

**3. 使用分页**
```typescript
const projects = await prisma.project.findMany({
  skip: (page - 1) * pageSize,
  take: pageSize,
  orderBy: { createdAt: 'desc' },
})
```

### 9.2 连接池配置

```env
# .env
DATABASE_URL="postgresql://user:pass@localhost:5432/db?schema=public&connection_limit=20&pool_timeout=20"
```

### 9.3 批量操作

```typescript
// 批量插入
await prisma.file.createMany({
  data: files.map(f => ({
    commitId,
    path: f.path,
    contentUrl: f.url,
    size: f.size,
    mimeType: f.mimeType,
  })),
  skipDuplicates: true,
})
```

### 9.4 数据库读写分离

```typescript
// prisma/client.ts
import { PrismaClient } from '@prisma/client'

// 写库连接
export const prismaMaster = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_MASTER_URL,
    },
  },
})

// 读库连接
export const prismaReplica = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_REPLICA_URL,
    },
  },
})

// 使用示例
export class UserService {
  async findUser(id: string) {
    return prismaReplica.user.findUnique({ where: { id } })
  }

  async createUser(data: CreateUserDto) {
    return prismaMaster.user.create({ data })
  }
}
```

---

## 10. 备份和恢复策略

### 10.1 备份策略

**全量备份（每日）**
```bash
#!/bin/bash
# backup-full.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups/postgresql"
DB_NAME="devplatform"

pg_dump -U postgres -d $DB_NAME -F c -b -v -f "$BACKUP_DIR/full_$DATE.backup"

# 保留最近7天的备份
find $BACKUP_DIR -name "full_*.backup" -mtime +7 -delete
```

**增量备份（每小时）**
```bash
# 使用WAL归档实现增量备份
# postgresql.conf配置：
# wal_level = replica
# archive_mode = on
# archive_command = 'cp %p /backups/wal_archive/%f'
```

### 10.2 恢复策略

**从全量备份恢复**
```bash
# 停止应用
kubectl scale deployment backend --replicas=0

# 恢复数据库
pg_restore -U postgres -d devplatform -c /backups/postgresql/full_20251010_120000.backup

# 启动应用
kubectl scale deployment backend --replicas=3
```

**时间点恢复（PITR）**
```bash
# 恢复到特定时间点
pg_restore -U postgres -d devplatform /backups/postgresql/full_20251010_120000.backup

# 应用WAL日志到指定时间
# recovery.conf:
# restore_command = 'cp /backups/wal_archive/%f %p'
# recovery_target_time = '2025-10-10 15:30:00'
```

### 10.3 灾难恢复计划

| RTO (Recovery Time Objective) | RPO (Recovery Point Objective) |
|-------------------------------|--------------------------------|
| < 5分钟 | < 1分钟 |

**步骤：**
1. 检测故障（自动健康检查）
2. 切换到Replica节点（自动故障转移）
3. 从备份恢复Master（如需要）
4. 验证数据完整性
5. 恢复正常服务

---

## 11. 数据库维护

### 11.1 定期维护任务

**每日任务**
```sql
-- 更新统计信息
ANALYZE;

-- 清理死行（自动VACUUM已启用）
-- PostgreSQL会自动执行，无需手动
```

**每周任务**
```sql
-- 全量VACUUM（释放磁盘空间）
VACUUM FULL;

-- 重建索引（如有碎片）
REINDEX DATABASE devplatform;
```

**每月任务**
```sql
-- 检查表膨胀
SELECT schemaname, tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 检查未使用的索引
SELECT schemaname, tablename, indexname, idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0 AND indexname NOT LIKE '%_pkey';
```

### 11.2 监控指标

| 指标 | 告警阈值 | 说明 |
|------|----------|------|
| 连接数 | > 80% | 接近连接池上限 |
| 慢查询 | > 1s | 查询性能问题 |
| 缓存命中率 | < 95% | 内存不足或查询效率低 |
| 复制延迟 | > 10s | Replica同步延迟 |
| 磁盘使用率 | > 80% | 需要扩容 |

---

## 12. 附录

### 12.1 数据库配置参数

```conf
# postgresql.conf 推荐配置

# 连接和认证
max_connections = 100
superuser_reserved_connections = 3

# 内存设置（16GB RAM服务器）
shared_buffers = 4GB
effective_cache_size = 12GB
work_mem = 64MB
maintenance_work_mem = 1GB

# WAL设置
wal_level = replica
max_wal_senders = 5
wal_keep_size = 1GB

# 检查点
checkpoint_timeout = 15min
max_wal_size = 2GB
min_wal_size = 1GB

# 查询优化
random_page_cost = 1.1  # 适用于SSD
effective_io_concurrency = 200

# 日志
log_destination = 'csvlog'
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_min_duration_statement = 1000  # 记录超过1秒的查询
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 自动VACUUM
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
```

### 12.2 常用SQL查询

**查看表大小**
```sql
SELECT
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size,
  pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS index_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

**查看慢查询**
```sql
SELECT
  query,
  calls,
  total_exec_time,
  mean_exec_time,
  max_exec_time
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

**查看锁等待**
```sql
SELECT
  blocked_locks.pid AS blocked_pid,
  blocked_activity.usename AS blocked_user,
  blocking_locks.pid AS blocking_pid,
  blocking_activity.usename AS blocking_user,
  blocked_activity.query AS blocked_statement,
  blocking_activity.query AS blocking_statement
FROM pg_catalog.pg_locks blocked_locks
JOIN pg_catalog.pg_stat_activity blocked_activity ON blocked_activity.pid = blocked_locks.pid
JOIN pg_catalog.pg_locks blocking_locks ON blocking_locks.locktype = blocked_locks.locktype
JOIN pg_catalog.pg_stat_activity blocking_activity ON blocking_activity.pid = blocking_locks.pid
WHERE NOT blocked_locks.granted;
```

---

**文档版本历史**

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-10-10 | 初始版本 | JIA |
| v2.0 | 2025-12-22 | 根据实现状态全面更新：<br>- 模型数量从9个扩展到33个<br>- 新增组织/团队/Issue/PR/通知/审计等模块<br>- 更新ER图和枚举类型（17个）<br>- 添加安全相关表（密码历史、会话管理） | JIA |

**文档结束**
