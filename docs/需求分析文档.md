# 需求分析文档

**项目名称：** 基于云计算的开发协作平台（Flotilla）
**版本：** v2.0（基于实现状态更新）
**编写日期：** 2025-10-10
**最后更新：** 2025-12-22
**编写人：** JIA

---

## 1. 项目概述

### 1.1 项目背景

随着软件开发团队的分布式化和云计算技术的成熟，开发者需要一个高效、可靠的协作平台来管理代码、跟踪项目进度并实现团队协作。本项目旨在构建一个基于云计算架构的开发协作平台，提供类似GitHub/GitLab的核心功能，并通过分布式共识算法保证数据一致性和系统可用性。

### 1.2 项目目标

**业务目标：**
- 为开发团队提供一个集中的代码托管和协作平台
- 支持多人协作开发，提供版本控制和权限管理
- 基于云计算实现高可用性和可扩展性
- 降低团队协作成本，提升开发效率

**技术目标：**
- 构建可扩展的前后端分离架构
- 实现简化版Raft分布式共识算法
- 达到企业级代码质量标准（测试覆盖率80%+）
- 支持容器化部署和云原生架构

### 1.3 功能实现状态

> **说明**: ✅ 已实现 | ⚠️ 部分实现 | ❌ 未实现

**核心功能（Phase 1-2 完成）：**
- ✅ 用户认证和授权系统（JWT + 邮箱验证 + 密码重置）
- ✅ 项目/仓库管理（CRUD + 文件管理）
- ✅ Git HTTP Smart Protocol（clone/push/fetch）
- ✅ 组织与团队权限系统（三层权限架构）
- ✅ 分布式数据同步（简化版Raft）
- ✅ Issue追踪系统（完整：issues, comments, labels, milestones）
- ✅ Pull Request代码审查（创建/审查/合并 + 多种合并策略）
- ✅ 代码搜索（MeiliSearch全文搜索）
- ✅ 分支保护规则
- ✅ 通知系统（WebSocket + 邮件）
- ✅ 审计日志系统
- ✅ 文件管理（MinIO对象存储）

**安全功能（Phase 3-4 完成）：**
- ✅ HTTPS强制重定向
- ✅ Security Headers中间件
- ✅ CSRF保护
- ✅ Rate Limiting（分层策略）
- ✅ 密码历史记录（防重用）
- ✅ 会话管理（设备管理、异地登录检测）
- ✅ Token版本控制（CWE-613防护）

**计划功能（未实现）：**
- ❌ CI/CD流水线集成（预留字段，触发机制未实现）
- ❌ OAuth/SSO单点登录
- ❌ 双因素认证（2FA）
- ❌ GDPR数据导出
- ❌ Webhook事件推送
- ❌ API令牌（Personal Access Token）
- ❌ Wiki文档系统
- ❌ 实时协作编辑

---

## 2. 用户角色定义

### 2.1 平台层角色

**超级管理员（SUPER_ADMIN）** ✅ 已实现
- **描述：** 平台运维者，最高权限
- **权限：** 用户管理、系统监控、配置管理、审计日志查看
- **典型场景：** 运维人员、平台管理员

**普通用户（USER）** ✅ 已实现
- **描述：** 平台注册用户
- **权限：** 创建组织、创建项目、参与协作
- **典型场景：** 开发者

### 2.2 组织层角色 ✅ 已实现

**组织所有者（OWNER）**
- **描述：** 组织创建者或被转让所有权的用户
- **权限：** 删除组织、转让所有权、所有管理操作

**组织管理员（ADMIN）**
- **描述：** 被授权管理组织的成员
- **权限：** 管理成员、管理团队、管理设置

**组织成员（MEMBER）**
- **描述：** 组织的普通成员
- **权限：** 创建项目、查看组织信息

### 2.3 团队层角色 ✅ 已实现

**团队维护者（MAINTAINER）**
- **描述：** 团队管理者
- **权限：** 管理团队成员、分配项目权限

**团队成员（MEMBER）**
- **描述：** 团队普通成员
- **权限：** 继承团队被赋予的项目权限

### 2.4 项目层角色 ✅ 已实现

**项目所有者（OWNER）**
- **描述：** 项目创建者或被转让所有权的用户
- **权限：** 完全控制权，包括删除项目、管理成员

**项目维护者（MAINTAINER）**
- **描述：** 项目核心维护者
- **权限：** 审核PR、管理Issue、分支保护设置

**项目成员（MEMBER）**
- **描述：** 项目开发成员
- **权限：** 读写代码、创建Issue和PR

**项目查看者（VIEWER）**
- **描述：** 只读访问权限
- **权限：** 查看代码和项目信息

---

## 3. 功能需求（用户故事）

### 3.1 用户认证模块

#### US-001: 用户注册
**作为** 新用户
**我想要** 通过邮箱和密码注册账号
**以便** 开始使用平台功能

**验收标准：**
- 必填字段：用户名、邮箱、密码
- 用户名唯一，3-20个字符，仅支持字母数字下划线
- 邮箱格式验证且唯一
- 密码至少8位，包含大小写字母和数字
- 密码使用bcrypt加密存储
- 注册成功后自动登录

#### US-002: 用户登录
**作为** 注册用户
**我想要** 使用用户名/邮箱和密码登录
**以便** 访问我的项目和数据

**验收标准：**
- 支持用户名或邮箱登录
- 密码验证失败时返回安全的错误提示（不泄露用户存在性）
- 登录成功返回JWT token（有效期7天）
- Token包含用户ID和角色信息
- 支持"记住我"功能（30天有效期）

#### US-003: 用户信息管理
**作为** 登录用户
**我想要** 查看和编辑我的个人信息
**以便** 保持资料的准确性

**验收标准：**
- 可查看：用户名、邮箱、头像、创建时间
- 可编辑：昵称、头像、个人简介
- 支持头像上传（限制5MB，支持jpg/png）
- 修改邮箱需要邮箱验证

---

### 3.2 项目管理模块

#### US-004: 创建项目
**作为** 开发者
**我想要** 创建新的代码项目
**以便** 开始管理我的代码

**验收标准：**
- 必填字段：项目名称、可见性（公开/私有）
- 可选字段：项目描述、README初始化
- 项目名称唯一（同一用户下），2-50个字符
- 自动创建默认分支（main）
- 自动设置创建者为项目Owner

#### US-005: 项目列表和搜索
**作为** 用户
**我想要** 查看我的项目列表并搜索项目
**以便** 快速找到目标项目

**验收标准：**
- 显示我创建的项目
- 显示我参与的项目
- 支持按名称搜索
- 支持按创建时间/更新时间排序
- 分页显示（每页20条）

#### US-006: 项目设置
**作为** 项目Owner
**我想要** 修改项目设置
**以便** 管理项目配置

**验收标准：**
- 可修改：项目名称、描述、可见性
- 可删除项目（需二次确认）
- 删除项目会删除所有相关数据
- 删除操作不可逆

---

### 3.3 代码仓库模块

#### US-007: 代码文件上传
**作为** 项目成员
**我想要** 上传代码文件到项目
**以便** 版本化管理我的代码

**验收标准：**
- 支持单文件上传和批量上传
- 文件大小限制：单个文件最大100MB
- 支持文件夹结构上传
- 每次上传生成唯一的版本ID
- 记录上传者、时间、提交信息

#### US-008: 代码浏览
**作为** 用户
**我想要** 浏览项目中的代码文件
**以便** 查看代码内容

**验收标准：**
- 显示文件树结构
- 支持文件内容预览
- 代码语法高亮（支持主流语言）
- 显示文件大小和最后修改时间
- 支持文件下载

#### US-009: 版本历史
**作为** 用户
**我想要** 查看文件的版本历史
**以便** 追踪代码变更

**验收标准：**
- 显示所有版本记录
- 每条记录包含：版本ID、提交者、时间、提交信息
- 支持查看特定版本的文件内容
- 显示版本间的差异（diff）

#### US-010: 分支管理（简化版）
**作为** 开发者
**我想要** 创建和切换分支
**以便** 并行开发不同功能

**验收标准：**
- 默认分支为main
- 支持从现有分支创建新分支
- 分支名称规则：字母数字下划线，2-50字符
- 可切换查看不同分支的代码
- 显示当前分支名称

---

### 3.4 协作和权限模块

#### US-011: 成员邀请
**作为** 项目Owner
**我想要** 邀请其他用户加入项目
**以便** 实现团队协作

**验收标准：**
- 通过用户名或邮箱邀请
- 指定成员角色：Owner / Member / Viewer
- 发送邀请通知（站内信）
- 被邀请者可接受或拒绝邀请

#### US-012: 权限控制
**作为** 系统
**我需要** 严格控制资源访问权限
**以便** 保护数据安全

**验收标准：**
- **Owner权限：** 所有操作，包括删除项目、管理成员
- **Member权限：** 读写代码、查看项目信息
- **Viewer权限：** 仅读取代码和项目信息
- 私有项目仅对成员可见
- 公开项目对所有用户可见（但仅成员可写）

#### US-013: 成员管理
**作为** 项目Owner
**我想要** 管理项目成员
**以便** 控制团队构成

**验收标准：**
- 查看所有项目成员列表
- 修改成员角色
- 移除成员（不能移除自己）
- 至少保留一个Owner

---

### 3.5 Issue追踪模块 ✅ 已实现

#### US-014: 创建Issue
**作为** 项目成员
**我想要** 创建Issue报告问题或提出功能需求
**以便** 追踪项目待办事项

**验收标准：**
- 必填字段：标题
- 可选字段：描述（支持Markdown）、标签、里程碑、被分配人
- 自动分配Issue编号（项目内递增）
- 支持@提及其他用户

#### US-015: Issue管理
**作为** 项目维护者
**我想要** 管理Issue的状态和属性
**以便** 组织项目工作流

**验收标准：**
- 支持打开/关闭Issue
- 支持添加/移除标签
- 支持设置里程碑
- 支持分配/取消分配成员
- 支持评论和讨论

#### US-016: 标签管理
**作为** 项目维护者
**我想要** 创建和管理标签
**以便** 对Issue进行分类

**验收标准：**
- 自定义标签名称和颜色
- 支持批量操作
- 预设常用标签（bug, feature, enhancement等）

#### US-017: 里程碑管理
**作为** 项目维护者
**我想要** 创建和管理里程碑
**以便** 规划项目进度

**验收标准：**
- 设置里程碑名称、描述、截止日期
- 关联Issue到里程碑
- 显示里程碑完成进度

---

### 3.6 Pull Request模块 ✅ 已实现

#### US-018: 创建Pull Request
**作为** 项目成员
**我想要** 创建Pull Request提交代码变更
**以便** 进行代码审查和合并

**验收标准：**
- 选择源分支和目标分支
- 填写标题和描述（支持Markdown）
- 显示变更文件和差异
- 自动检测合并冲突

#### US-019: 代码审查
**作为** 项目维护者
**我想要** 审查Pull Request的代码变更
**以便** 确保代码质量

**验收标准：**
- 查看文件差异（unified diff格式）
- 在代码行添加评论
- 提交审查意见（批准/请求修改/评论）
- 支持多轮审查

#### US-020: 合并Pull Request
**作为** 项目维护者
**我想要** 合并审核通过的Pull Request
**以便** 将代码变更合入主分支

**验收标准：**
- 支持多种合并策略（merge, squash, rebase）
- 检查分支保护规则
- 检查必需审批数量
- 合并后可选删除源分支

#### US-021: 分支保护规则
**作为** 项目所有者
**我想要** 设置分支保护规则
**以便** 保护重要分支不被直接修改

**验收标准：**
- 要求Pull Request审查才能合并
- 设置最少批准人数
- 禁止强制推送
- 禁止删除保护分支

---

### 3.7 代码搜索模块 ✅ 已实现

#### US-022: 全局代码搜索
**作为** 用户
**我想要** 搜索代码内容
**以便** 快速找到相关代码

**验收标准：**
- 支持全文搜索（MeiliSearch）
- 支持按项目筛选
- 显示搜索结果和上下文
- 支持高亮匹配关键词

---

### 3.8 通知模块 ✅ 已实现

#### US-023: 实时通知
**作为** 用户
**我想要** 收到相关活动的通知
**以便** 及时了解项目动态

**验收标准：**
- WebSocket实时推送
- 支持邮件通知
- 通知类型：Issue评论、PR审查、被提及等
- 支持配置通知偏好

---

### 3.9 分布式共识模块 ✅ 已实现

#### US-024: 数据同步
**作为** 系统
**我需要** 在多个节点间同步数据
**以便** 保证数据一致性

**验收标准：**
- 使用简化版Raft算法实现
- 支持至少3个节点集群
- Leader节点处理所有写请求
- Follower节点复制日志
- 网络分区后自动恢复

#### US-015: 高可用性
**作为** 系统
**我需要** 在节点故障时保持服务可用
**以便** 提供可靠的服务

**验收标准：**
- Leader节点故障时自动选举新Leader
- 选举超时时间：150-300ms
- 数据复制到大多数节点后才返回成功
- 故障节点恢复后自动同步数据

---

## 4. 非功能需求

### 4.1 性能需求

- **响应时间：**
  - API请求平均响应时间 < 200ms
  - 页面首屏加载时间 < 2s
  - 文件上传速度 > 1MB/s（100Mbps网络）

- **并发能力：**
  - 支持1000+并发用户
  - 支持100+并发写操作

- **存储容量：**
  - 单个项目存储上限：10GB
  - 单个用户存储上限：100GB
  - 系统总存储：可扩展至PB级

### 4.2 可用性需求

- **系统可用性：** 99.9%（年均停机时间 < 8.76小时）
- **数据可靠性：** 99.999%（数据丢失概率 < 0.001%）
- **故障恢复时间（RTO）：** < 5分钟
- **数据恢复点（RPO）：** < 1分钟

### 4.3 安全性需求

- **认证安全：**
  - 密码强度要求（最少8位，复杂度）
  - JWT token加密传输
  - 防暴力破解（登录失败5次锁定10分钟）

- **数据安全：**
  - 数据库密码加密存储（bcrypt）
  - HTTPS加密传输（TLS 1.3）
  - 敏感数据脱敏（日志中不显示密码）

- **访问控制：**
  - 基于角色的访问控制（RBAC）
  - API权限验证（JWT + 权限中间件）
  - 防CSRF攻击
  - 防XSS攻击（输入验证和输出编码）

### 4.4 可扩展性需求

- **水平扩展：** 支持通过增加服务器节点扩展处理能力
- **数据库扩展：** 支持读写分离和分片
- **存储扩展：** 使用对象存储（S3兼容）
- **CDN加速：** 静态资源使用CDN分发

### 4.5 可维护性需求

- **代码质量：**
  - 单元测试覆盖率 > 80%
  - 集成测试覆盖核心业务流程
  - E2E测试覆盖关键用户路径

- **日志和监控：**
  - 集中式日志收集（ELK Stack）
  - 实时监控指标（Prometheus + Grafana）
  - 错误追踪和告警

- **文档：**
  - API文档（OpenAPI/Swagger）
  - 架构设计文档
  - 运维手册

### 4.6 兼容性需求

- **浏览器兼容性：**
  - Chrome 90+
  - Firefox 88+
  - Safari 14+
  - Edge 90+

- **设备兼容性：**
  - 桌面端（1920x1080及以上）
  - 平板端（768x1024及以上）
  - 移动端响应式设计

---

## 5. 业务规则和约束

### 5.1 业务规则

1. **用户规则：**
   - 用户名和邮箱全局唯一
   - 用户删除后，其创建的项目归档到系统账户
   - 用户必须验证邮箱才能创建项目

2. **项目规则：**
   - 项目名称在同一用户下唯一
   - 删除项目需要Owner权限
   - 项目至少有一个Owner
   - 私有项目仅对成员可见

3. **权限规则：**
   - Owner可以转让所有权
   - 最后一个Owner不能退出项目
   - Viewer不能修改任何数据

4. **存储规则：**
   - 免费用户存储配额：10GB
   - 单个文件大小限制：100MB
   - 存储超限后禁止上传新文件

### 5.2 技术约束

1. **技术栈约束：**
   - 前端：Next.js 15 + React 19 + TypeScript
   - 后端：NestJS + Prisma + PostgreSQL
   - 缓存：Redis
   - 对象存储：MinIO（S3兼容）

2. **部署约束：**
   - 容器化部署（Docker + Kubernetes）
   - 最小集群规模：3节点
   - 数据库主从复制

3. **开发约束：**
   - 遵循SOLID原则
   - 代码审查通过才能合并
   - Git commit遵循Conventional Commits规范

---

## 6. 数据字典（概要）

### 6.1 核心实体

**User（用户）**
- id, username, email, passwordHash, avatar, bio, role, createdAt, updatedAt

**Project（项目）**
- id, name, description, visibility, ownerId, createdAt, updatedAt

**Repository（仓库）**
- id, projectId, defaultBranch, storageUsed, createdAt, updatedAt

**Branch（分支）**
- id, repositoryId, name, commitId, createdAt, updatedAt

**Commit（提交）**
- id, repositoryId, branchId, authorId, message, hash, createdAt

**File（文件）**
- id, commitId, path, content, size, mimeType, createdAt

**ProjectMember（项目成员）**
- id, projectId, userId, role, joinedAt

---

## 7. 风险分析

### 7.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 分布式共识算法实现复杂 | 高 | 高 | 先实现简化版本，逐步优化；使用成熟库作为参考 |
| 性能瓶颈 | 中 | 高 | 早期进行性能测试；使用缓存和CDN优化 |
| 数据一致性问题 | 中 | 高 | 严格的事务控制；完善的错误恢复机制 |
| 安全漏洞 | 低 | 高 | 代码安全审查；使用成熟的安全库；定期安全测试 |

### 7.2 业务风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 功能范围膨胀 | 高 | 中 | 严格控制MVP范围；增量迭代开发 |
| 用户体验不佳 | 中 | 中 | 早期用户测试；持续优化UI/UX |
| 竞争对手压力 | 低 | 低 | 专注学术价值和技术创新 |

---

## 8. 成功标准

### 8.1 MVP交付标准

✅ **功能完整性：** 所有MVP功能实现并通过测试
✅ **代码质量：** 测试覆盖率 ≥ 80%，无重大Bug
✅ **性能指标：** 满足4.1节性能需求
✅ **安全性：** 通过基本安全测试
✅ **文档完整：** 所有文档齐全

### 8.2 学术成果标准

✅ **需求分析文档：** 详细、完整、可追溯
✅ **架构设计文档：** 包含UML图和技术选型说明
✅ **数据库设计文档：** 包含ER图和标准化设计
✅ **算法设计文档：** 分布式共识算法详细说明
✅ **测试报告：** 完整的测试计划和结果
✅ **个人总结：** 反思和学习收获

---

## 9. 术语表

- **MVP（Minimum Viable Product）：** 最小可行产品
- **Raft：** 一种分布式共识算法
- **JWT（JSON Web Token）：** 基于JSON的访问令牌
- **RBAC（Role-Based Access Control）：** 基于角色的访问控制
- **ORM（Object-Relational Mapping）：** 对象关系映射
- **CDN（Content Delivery Network）：** 内容分发网络
- **SSR（Server-Side Rendering）：** 服务端渲染
- **Commit：** 代码提交版本
- **Branch：** 代码分支
- **Repository：** 代码仓库

---

## 10. 附录

### 10.1 参考文献

1. "In Search of an Understandable Consensus Algorithm" - Raft Paper
2. GitHub REST API Documentation
3. GitLab Architecture Documentation
4. Next.js 15 Official Documentation
5. NestJS Official Documentation

### 10.2 变更历史

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| v1.0 | 2025-10-10 | 初始版本 | JIA |
| v2.0 | 2025-12-22 | 根据实现状态更新：<br>- 新增Issue/PR/搜索/通知模块用户故事<br>- 更新用户角色定义（三层权限架构）<br>- 标注已实现/未实现功能 | JIA |

---

**文档结束**
