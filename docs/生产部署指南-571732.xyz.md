# ğŸš€ Flotilla ç”Ÿäº§éƒ¨ç½²æŒ‡å—

## åŸŸåï¼š571732.xyz

---

## ğŸ“‹ éƒ¨ç½²æ¶æ„

```
571732.xyz â†’ é‡å®šå‘åˆ° flotilla.571732.xyz
â”œâ”€â”€ flotilla.571732.xyz (å®˜ç½‘ Website - Port 3003)
â”œâ”€â”€ app.571732.xyz      (åº”ç”¨ Frontend - Port 3000)
â””â”€â”€ api.571732.xyz      (API Backend - Port 4000)
```

**Nginx åå‘ä»£ç†ï¼š**
- æ‰€æœ‰å­åŸŸåé€šè¿‡ Nginx ä»£ç†åˆ°å†…éƒ¨ Docker æœåŠ¡
- HTTP (80) â†’ HTTPS (443) è‡ªåŠ¨é‡å®šå‘
- Let's Encrypt è‡ªåŠ¨ SSL è¯ä¹¦ç®¡ç†

---

## ğŸ”§ éƒ¨ç½²å‰å‡†å¤‡

### 1. DNS é…ç½®

åœ¨æ‚¨çš„åŸŸåæä¾›å•†ï¼ˆå¦‚ Cloudflare / é˜¿é‡Œäº‘ / è…¾è®¯äº‘ï¼‰é…ç½®ä»¥ä¸‹ A è®°å½•ï¼š

| ç±»å‹ | ä¸»æœºè®°å½• | è®°å½•å€¼ | TTL |
|------|---------|--------|-----|
| A | @ | YOUR_SERVER_IP | 600 |
| A | www | YOUR_SERVER_IP | 600 |
| A | flotilla | YOUR_SERVER_IP | 600 |
| A | app | YOUR_SERVER_IP | 600 |
| A | api | YOUR_SERVER_IP | 600 |

**éªŒè¯ DNS ç”Ÿæ•ˆï¼š**

```bash
# Windows
nslookup flotilla.571732.xyz
nslookup app.571732.xyz
nslookup api.571732.xyz

# Linux/Mac
dig flotilla.571732.xyz +short
dig app.571732.xyz +short
dig api.571732.xyz +short
```

### 2. é˜²ç«å¢™é…ç½®

ç¡®ä¿ä»¥ä¸‹ç«¯å£å¼€æ”¾ï¼š

```bash
# Windows Firewall
netsh advfirewall firewall add rule name="HTTP" protocol=TCP dir=in localport=80 action=allow
netsh advfirewall firewall add rule name="HTTPS" protocol=TCP dir=in localport=443 action=allow

# Linux UFW
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload

# Linux iptables
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

ç¼–è¾‘ `docker-compose.prod.yml` ç¡®è®¤ç¯å¢ƒå˜é‡ï¼š

```yaml
backend:
  environment:
    - FRONTEND_URL=https://app.571732.xyz
    - API_URL=https://api.571732.xyz

frontend:
  environment:
    - NEXT_PUBLIC_API_URL=https://api.571732.xyz/api

website:
  environment:
    - NEXT_PUBLIC_APP_URL=https://app.571732.xyz
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1ï¼šåœæ­¢å¼€å‘ç¯å¢ƒï¼ˆå¦‚æœè¿è¡Œä¸­ï¼‰

```bash
docker-compose down
```

### æ­¥éª¤ 2ï¼šå¯åŠ¨ç”Ÿäº§ç¯å¢ƒï¼ˆHTTP onlyï¼Œå…ˆä¸é…ç½® HTTPSï¼‰

```bash
# ä½¿ç”¨ç”Ÿäº§é…ç½®å¯åŠ¨
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### æ­¥éª¤ 3ï¼šéªŒè¯ HTTP è®¿é—®

```bash
# æµ‹è¯•å„ä¸ªæœåŠ¡
curl -I http://flotilla.571732.xyz
curl -I http://app.571732.xyz
curl -I http://api.571732.xyz/api/docs
```

### æ­¥éª¤ 4ï¼šé…ç½® SSL è¯ä¹¦

#### æ–¹æ³• Aï¼šä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# Windows Git Bash æˆ– WSL
bash scripts/setup-ssl.sh

# æŒ‰ç…§æç¤ºæ“ä½œï¼š
# 1. ç¡®è®¤ DNS é…ç½®æ­£ç¡®
# 2. ç­‰å¾…è¯ä¹¦è·å–
# 3. æ‰‹åŠ¨ç¼–è¾‘ nginx/flotilla.conf å¯ç”¨ HTTPS
# 4. é‡æ–°åŠ è½½ Nginx
```

#### æ–¹æ³• Bï¼šæ‰‹åŠ¨é…ç½®

```bash
# 1. è·å–è¯ä¹¦ - flotilla.571732.xyz
docker-compose -f docker-compose.yml -f docker-compose.prod.yml run --rm certbot \
  certonly --webroot \
  --webroot-path=/var/www/certbot \
  --email jia@571732.xyz \
  --agree-tos \
  --no-eff-email \
  -d flotilla.571732.xyz

# 2. è·å–è¯ä¹¦ - app.571732.xyz
docker-compose -f docker-compose.yml -f docker-compose.prod.yml run --rm certbot \
  certonly --webroot \
  --webroot-path=/var/www/certbot \
  --email jia@571732.xyz \
  --agree-tos \
  --no-eff-email \
  -d app.571732.xyz

# 3. è·å–è¯ä¹¦ - api.571732.xyz
docker-compose -f docker-compose.yml -f docker-compose.prod.yml run --rm certbot \
  certonly --webroot \
  --webroot-path=/var/www/certbot \
  --email jia@571732.xyz \
  --agree-tos \
  --no-eff-email \
  -d api.571732.xyz

# 4. ç¼–è¾‘ nginx/flotilla.conf
# - å–æ¶ˆæ³¨é‡Š HTTPS server å—ï¼ˆ# server { listen 443 ssl ... }ï¼‰
# - æ³¨é‡Šæ‰ä¸´æ—¶ HTTP location å—
# - å–æ¶ˆæ³¨é‡Š HTTP â†’ HTTPS é‡å®šå‘ï¼ˆreturn 301 https://...ï¼‰

# 5. é‡æ–°åŠ è½½ Nginx
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec nginx nginx -s reload
```

### æ­¥éª¤ 5ï¼šéªŒè¯ HTTPS è®¿é—®

```bash
# æµ‹è¯• HTTPS
curl -I https://flotilla.571732.xyz
curl -I https://app.571732.xyz
curl -I https://api.571732.xyz/api/docs

# æµ‹è¯• HTTP â†’ HTTPS é‡å®šå‘
curl -I http://flotilla.571732.xyz  # åº”è¿”å› 301
```

---

## ğŸ¯ è®¿é—®åœ°å€

éƒ¨ç½²å®Œæˆåï¼Œæ‚¨çš„å¹³å°å¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

| æœåŠ¡ | HTTP | HTTPS | è¯´æ˜ |
|-----|------|-------|------|
| **å®˜ç½‘** | http://flotilla.571732.xyz | https://flotilla.571732.xyz | å“ç‰Œå®˜ç½‘ï¼Œä»‹ç»é¡µ |
| **åº”ç”¨** | http://app.571732.xyz | https://app.571732.xyz | ä¸»åº”ç”¨ï¼Œå¼€å‘å¹³å° |
| **API** | http://api.571732.xyz | https://api.571732.xyz | RESTful API å’Œ Swagger æ–‡æ¡£ |

---

## ğŸ”’ å®‰å…¨åŠ å›º

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

ç¼–è¾‘ `docker-compose.yml` æˆ–åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# PostgreSQL
POSTGRES_PASSWORD=YOUR_STRONG_PASSWORD

# Redis
REDIS_PASSWORD=YOUR_STRONG_PASSWORD

# MinIO
MINIO_ROOT_PASSWORD=YOUR_STRONG_PASSWORD

# JWT
JWT_SECRET=YOUR_64_CHAR_RANDOM_SECRET
JWT_REFRESH_SECRET=YOUR_64_CHAR_RANDOM_SECRET
```

**ç”Ÿæˆå¼ºå¯†ç ï¼š**

```bash
# ç”Ÿæˆ 64 å­—ç¬¦éšæœºå¯†é’¥ï¼ˆJWTï¼‰
openssl rand -hex 32

# ç”Ÿæˆ 32 å­—ç¬¦å¯†ç ï¼ˆæ•°æ®åº“/Redisï¼‰
openssl rand -base64 24
```

### 2. é™åˆ¶å†…éƒ¨ç«¯å£æš´éœ²

ä¿®æ”¹ `docker-compose.yml`ï¼Œåªå…è®¸æœ¬åœ°è®¿é—®å†…éƒ¨ç«¯å£ï¼š

```yaml
ports:
  # åªæš´éœ²ç»™ Nginxï¼Œä¸å¯¹å¤–å¼€æ”¾
  - "127.0.0.1:3000:3000"  # Frontend
  - "127.0.0.1:3003:3003"  # Website
  - "127.0.0.1:4000:4000"  # Backend
  - "127.0.0.1:5434:5432"  # PostgreSQL
  - "127.0.0.1:6380:6379"  # Redis
  - "127.0.0.1:9000:9000"  # MinIO API
  - "127.0.0.1:9001:9001"  # MinIO Console
```

### 3. é…ç½®é˜²ç«å¢™

```bash
# åªå…è®¸ 80 å’Œ 443 ç«¯å£å¯¹å¤–å¼€æ”¾
# å…¶ä»–ç«¯å£åªå…è®¸æœ¬åœ°è®¿é—®
```

---

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### æŸ¥çœ‹æ—¥å¿—

```bash
# æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

# ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f nginx
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f frontend
```

### SSL è¯ä¹¦ç»­æœŸ

Certbot å®¹å™¨ä¼šè‡ªåŠ¨æ¯ 12 å°æ—¶æ£€æŸ¥è¯ä¹¦å¹¶ç»­æœŸã€‚æ‰‹åŠ¨è§¦å‘ç»­æœŸï¼š

```bash
docker-compose -f docker-compose.yml -f docker-compose.prod.yml run --rm certbot renew
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec nginx nginx -s reload
```

### å¤‡ä»½æ•°æ®

```bash
# æ•°æ®åº“å¤‡ä»½
docker exec flotilla-postgres pg_dump -U devplatform cloud_dev_platform > backup_$(date +%Y%m%d_%H%M%S).sql

# å‹ç¼©å¤‡ä»½
gzip backup_*.sql

# MinIO æ•°æ®å¤‡ä»½ï¼ˆéœ€è¦è¿›å…¥å®¹å™¨ï¼‰
docker exec flotilla-minio tar czf /tmp/minio_backup.tar.gz /data
docker cp flotilla-minio:/tmp/minio_backup.tar.gz ./minio_backup_$(date +%Y%m%d).tar.gz
```

### æ›´æ–°éƒ¨ç½²

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# é‡æ–°æ„å»ºé•œåƒ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate

# æŸ¥çœ‹çŠ¶æ€
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šDNS æœªè§£æ

```bash
# æ£€æŸ¥ DNS æ˜¯å¦ç”Ÿæ•ˆ
nslookup flotilla.571732.xyz

# ç­‰å¾… DNS ä¼ æ’­ï¼ˆå¯èƒ½éœ€è¦ 5-30 åˆ†é’Ÿï¼‰
```

### é—®é¢˜ 2ï¼šSSL è¯ä¹¦è·å–å¤±è´¥

```bash
# æ£€æŸ¥ 80 ç«¯å£æ˜¯å¦å¯è®¿é—®
curl -I http://flotilla.571732.xyz

# æ£€æŸ¥ Nginx æ—¥å¿—
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs nginx

# æ£€æŸ¥ Certbot æ—¥å¿—
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs certbot
```

### é—®é¢˜ 3ï¼š502 Bad Gateway

```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps

# æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec backend wget -q -O- http://localhost:4000/api/docs
```

### é—®é¢˜ 4ï¼šCORS é”™è¯¯

ç¼–è¾‘åç«¯ CORS é…ç½®ï¼Œå…è®¸æ‚¨çš„åŸŸåï¼š

```typescript
// apps/backend/src/main.ts
app.enableCors({
  origin: ['https://flotilla.571732.xyz', 'https://app.571732.xyz'],
  credentials: true,
});
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] DNS A è®°å½•å·²é…ç½®å¹¶ç”Ÿæ•ˆ
- [ ] é˜²ç«å¢™ 80/443 ç«¯å£å·²å¼€æ”¾
- [ ] Docker æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] Nginx é…ç½®æ­£ç¡®
- [ ] SSL è¯ä¹¦å·²è·å–å¹¶é…ç½®
- [ ] HTTPS è®¿é—®æ­£å¸¸
- [ ] HTTP è‡ªåŠ¨é‡å®šå‘åˆ° HTTPS
- [ ] é»˜è®¤å¯†ç å·²ä¿®æ”¹
- [ ] å¤‡ä»½ç­–ç•¥å·²é…ç½®
- [ ] æ—¥å¿—ç›‘æ§å·²è®¾ç½®

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **æ—¥å¿—æ–‡ä»¶ï¼š** `docker-compose logs -f`
2. **å¥åº·æ£€æŸ¥ï¼š** `docker-compose ps`
3. **ç½‘ç»œè¿æ¥ï¼š** `curl -I https://your-domain.xyz`
4. **DNS è§£æï¼š** `nslookup your-domain.xyz`

---

**éƒ¨ç½²å®Œæˆåï¼Œæ‚¨çš„ Flotilla å¹³å°å°†é€šè¿‡ HTTPS å®‰å…¨è®¿é—®ï¼ğŸ‰**
