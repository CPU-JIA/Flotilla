# 🚀 Flotilla 生产部署指南

## 域名：571732.xyz

---

## 📋 部署架构

```
571732.xyz → 重定向到 flotilla.571732.xyz
├── flotilla.571732.xyz (官网 Website - Port 3003)
├── app.571732.xyz      (应用 Frontend - Port 3000)
└── api.571732.xyz      (API Backend - Port 4000)
```

**Nginx 反向代理：**
- 所有子域名通过 Nginx 代理到内部 Docker 服务
- HTTP (80) → HTTPS (443) 自动重定向
- Let's Encrypt 自动 SSL 证书管理

---

## 🔧 部署前准备

### 1. DNS 配置

在您的域名提供商（如 Cloudflare / 阿里云 / 腾讯云）配置以下 A 记录：

| 类型 | 主机记录 | 记录值 | TTL |
|------|---------|--------|-----|
| A | @ | YOUR_SERVER_IP | 600 |
| A | www | YOUR_SERVER_IP | 600 |
| A | flotilla | YOUR_SERVER_IP | 600 |
| A | app | YOUR_SERVER_IP | 600 |
| A | api | YOUR_SERVER_IP | 600 |

**验证 DNS 生效：**

```bash
# Windows
nslookup flotilla.571732.xyz
nslookup app.571732.xyz
nslookup api.571732.xyz

# Linux/Mac
dig flotilla.571732.xyz +short
dig app.571732.xyz +short
dig api.571732.xyz +short
```

### 2. 防火墙配置

确保以下端口开放：

```bash
# Windows Firewall
netsh advfirewall firewall add rule name="HTTP" protocol=TCP dir=in localport=80 action=allow
netsh advfirewall firewall add rule name="HTTPS" protocol=TCP dir=in localport=443 action=allow

# Linux UFW
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload

# Linux iptables
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

### 3. 环境变量配置

编辑 `docker-compose.prod.yml` 确认环境变量：

```yaml
backend:
  environment:
    - FRONTEND_URL=https://app.571732.xyz
    - API_URL=https://api.571732.xyz

frontend:
  environment:
    - NEXT_PUBLIC_API_URL=https://api.571732.xyz/api

website:
  environment:
    - NEXT_PUBLIC_APP_URL=https://app.571732.xyz
```

---

## 🚀 部署步骤

### 步骤 1：停止开发环境（如果运行中）

```bash
docker-compose down
```

### 步骤 2：启动生产环境（HTTP only，先不配置 HTTPS）

```bash
# 使用生产配置启动
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### 步骤 3：验证 HTTP 访问

```bash
# 测试各个服务
curl -I http://flotilla.571732.xyz
curl -I http://app.571732.xyz
curl -I http://api.571732.xyz/api/docs
```

### 步骤 4：配置 SSL 证书

#### 方法 A：使用自动化脚本（推荐）

```bash
# Windows Git Bash 或 WSL
bash scripts/setup-ssl.sh

# 按照提示操作：
# 1. 确认 DNS 配置正确
# 2. 等待证书获取
# 3. 手动编辑 nginx/flotilla.conf 启用 HTTPS
# 4. 重新加载 Nginx
```

#### 方法 B：手动配置

```bash
# 1. 获取证书 - flotilla.571732.xyz
docker-compose -f docker-compose.yml -f docker-compose.prod.yml run --rm certbot \
  certonly --webroot \
  --webroot-path=/var/www/certbot \
  --email jia@571732.xyz \
  --agree-tos \
  --no-eff-email \
  -d flotilla.571732.xyz

# 2. 获取证书 - app.571732.xyz
docker-compose -f docker-compose.yml -f docker-compose.prod.yml run --rm certbot \
  certonly --webroot \
  --webroot-path=/var/www/certbot \
  --email jia@571732.xyz \
  --agree-tos \
  --no-eff-email \
  -d app.571732.xyz

# 3. 获取证书 - api.571732.xyz
docker-compose -f docker-compose.yml -f docker-compose.prod.yml run --rm certbot \
  certonly --webroot \
  --webroot-path=/var/www/certbot \
  --email jia@571732.xyz \
  --agree-tos \
  --no-eff-email \
  -d api.571732.xyz

# 4. 编辑 nginx/flotilla.conf
# - 取消注释 HTTPS server 块（# server { listen 443 ssl ... }）
# - 注释掉临时 HTTP location 块
# - 取消注释 HTTP → HTTPS 重定向（return 301 https://...）

# 5. 重新加载 Nginx
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec nginx nginx -s reload
```

### 步骤 5：验证 HTTPS 访问

```bash
# 测试 HTTPS
curl -I https://flotilla.571732.xyz
curl -I https://app.571732.xyz
curl -I https://api.571732.xyz/api/docs

# 测试 HTTP → HTTPS 重定向
curl -I http://flotilla.571732.xyz  # 应返回 301
```

---

## 🎯 访问地址

部署完成后，您的平台可通过以下地址访问：

| 服务 | HTTP | HTTPS | 说明 |
|-----|------|-------|------|
| **官网** | http://flotilla.571732.xyz | https://flotilla.571732.xyz | 品牌官网，介绍页 |
| **应用** | http://app.571732.xyz | https://app.571732.xyz | 主应用，开发平台 |
| **API** | http://api.571732.xyz | https://api.571732.xyz | RESTful API 和 Swagger 文档 |

---

## 🔒 安全加固

### 1. 修改默认密码

编辑 `docker-compose.yml` 或创建 `.env` 文件：

```bash
# PostgreSQL
POSTGRES_PASSWORD=YOUR_STRONG_PASSWORD

# Redis
REDIS_PASSWORD=YOUR_STRONG_PASSWORD

# MinIO
MINIO_ROOT_PASSWORD=YOUR_STRONG_PASSWORD

# JWT
JWT_SECRET=YOUR_64_CHAR_RANDOM_SECRET
JWT_REFRESH_SECRET=YOUR_64_CHAR_RANDOM_SECRET
```

**生成强密码：**

```bash
# 生成 64 字符随机密钥（JWT）
openssl rand -hex 32

# 生成 32 字符密码（数据库/Redis）
openssl rand -base64 24
```

### 2. 限制内部端口暴露

修改 `docker-compose.yml`，只允许本地访问内部端口：

```yaml
ports:
  # 只暴露给 Nginx，不对外开放
  - "127.0.0.1:3000:3000"  # Frontend
  - "127.0.0.1:3003:3003"  # Website
  - "127.0.0.1:4000:4000"  # Backend
  - "127.0.0.1:5434:5432"  # PostgreSQL
  - "127.0.0.1:6380:6379"  # Redis
  - "127.0.0.1:9000:9000"  # MinIO API
  - "127.0.0.1:9001:9001"  # MinIO Console
```

### 3. 配置防火墙

```bash
# 只允许 80 和 443 端口对外开放
# 其他端口只允许本地访问
```

---

## 📊 监控与维护

### 查看日志

```bash
# 所有服务日志
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f

# 特定服务日志
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f nginx
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs -f frontend
```

### SSL 证书续期

Certbot 容器会自动每 12 小时检查证书并续期。手动触发续期：

```bash
docker-compose -f docker-compose.yml -f docker-compose.prod.yml run --rm certbot renew
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec nginx nginx -s reload
```

### 备份数据

```bash
# 数据库备份
docker exec flotilla-postgres pg_dump -U devplatform cloud_dev_platform > backup_$(date +%Y%m%d_%H%M%S).sql

# 压缩备份
gzip backup_*.sql

# MinIO 数据备份（需要进入容器）
docker exec flotilla-minio tar czf /tmp/minio_backup.tar.gz /data
docker cp flotilla-minio:/tmp/minio_backup.tar.gz ./minio_backup_$(date +%Y%m%d).tar.gz
```

### 更新部署

```bash
# 拉取最新代码
git pull origin main

# 重新构建镜像
docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache

# 重启服务
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate

# 查看状态
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
```

---

## 🐛 故障排查

### 问题 1：DNS 未解析

```bash
# 检查 DNS 是否生效
nslookup flotilla.571732.xyz

# 等待 DNS 传播（可能需要 5-30 分钟）
```

### 问题 2：SSL 证书获取失败

```bash
# 检查 80 端口是否可访问
curl -I http://flotilla.571732.xyz

# 检查 Nginx 日志
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs nginx

# 检查 Certbot 日志
docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs certbot
```

### 问题 3：502 Bad Gateway

```bash
# 检查后端服务是否运行
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps

# 检查后端健康状态
docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec backend wget -q -O- http://localhost:4000/api/docs
```

### 问题 4：CORS 错误

编辑后端 CORS 配置，允许您的域名：

```typescript
// apps/backend/src/main.ts
app.enableCors({
  origin: ['https://flotilla.571732.xyz', 'https://app.571732.xyz'],
  credentials: true,
});
```

---

## ✅ 部署检查清单

- [ ] DNS A 记录已配置并生效
- [ ] 防火墙 80/443 端口已开放
- [ ] Docker 服务运行正常
- [ ] Nginx 配置正确
- [ ] SSL 证书已获取并配置
- [ ] HTTPS 访问正常
- [ ] HTTP 自动重定向到 HTTPS
- [ ] 默认密码已修改
- [ ] 备份策略已配置
- [ ] 日志监控已设置

---

## 📞 技术支持

如遇到问题，请检查：

1. **日志文件：** `docker-compose logs -f`
2. **健康检查：** `docker-compose ps`
3. **网络连接：** `curl -I https://your-domain.xyz`
4. **DNS 解析：** `nslookup your-domain.xyz`

---

**部署完成后，您的 Flotilla 平台将通过 HTTPS 安全访问！🎉**
