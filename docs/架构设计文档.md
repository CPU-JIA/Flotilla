# 架构设计文档

**项目名称：** 基于云计算的开发协作平台
**版本：** v1.0
**编写日期：** 2025-10-10
**编写人：** JIA

---

## 目录

1. [系统整体架构](#1-系统整体架构)
2. [技术栈选型](#2-技术栈选型)
3. [前端架构设计](#3-前端架构设计)
4. [后端架构设计](#4-后端架构设计)
5. [数据库架构设计](#5-数据库架构设计)
6. [分布式架构设计](#6-分布式架构设计)
7. [API设计](#7-api设计)
8. [安全架构](#8-安全架构)
9. [部署架构](#9-部署架构)
10. [UML设计图](#10-uml设计图)

---

## 1. 系统整体架构

### 1.1 架构风格

本系统采用**前后端分离**的**微服务架构**，遵循**云原生**设计原则。

### 1.2 系统架构图

```mermaid
graph TB
    subgraph "客户端层"
        Browser[Web浏览器]
        Mobile[移动设备]
    end

    subgraph "CDN/边缘层"
        CDN[CDN<br/>CloudFlare/AWS CloudFront]
    end

    subgraph "负载均衡层"
        LB[负载均衡器<br/>Nginx/AWS ALB]
    end

    subgraph "前端服务层"
        FrontEnd[Next.js 15 应用<br/>SSR + Static]
    end

    subgraph "API网关层"
        Gateway[API Gateway<br/>Kong/AWS API Gateway]
    end

    subgraph "后端服务层"
        AuthService[认证服务<br/>NestJS]
        ProjectService[项目服务<br/>NestJS]
        RepoService[仓库服务<br/>NestJS]
        ConsensusService[共识服务<br/>Raft]
    end

    subgraph "缓存层"
        Redis[(Redis<br/>Session & Cache)]
    end

    subgraph "数据持久层"
        PostgreSQL[(PostgreSQL<br/>主库)]
        PostgreSQLReplica[(PostgreSQL<br/>从库)]
        MinIO[(MinIO<br/>对象存储)]
    end

    subgraph "监控和日志"
        Prometheus[Prometheus]
        Grafana[Grafana]
        ELK[ELK Stack]
    end

    Browser --> CDN
    Mobile --> CDN
    CDN --> LB
    LB --> FrontEnd
    FrontEnd --> Gateway
    Gateway --> AuthService
    Gateway --> ProjectService
    Gateway --> RepoService

    AuthService --> Redis
    ProjectService --> Redis
    RepoService --> Redis

    AuthService --> PostgreSQL
    ProjectService --> PostgreSQL
    RepoService --> PostgreSQL
    RepoService --> MinIO

    PostgreSQL --> PostgreSQLReplica

    ConsensusService --> PostgreSQL
    ConsensusService --> AuthService
    ConsensusService --> ProjectService
    ConsensusService --> RepoService

    AuthService -.-> Prometheus
    ProjectService -.-> Prometheus
    RepoService -.-> Prometheus
    Prometheus --> Grafana

    AuthService -.-> ELK
    ProjectService -.-> ELK
    RepoService -.-> ELK
```

### 1.3 架构特点

- **前后端分离：** 前端Next.js独立部署，通过API与后端通信
- **服务模块化：** 后端按业务领域划分为多个NestJS模块
- **分布式一致性：** 核心数据通过Raft算法保证强一致性
- **高可用性：** 多节点部署，故障自动切换
- **可扩展性：** 水平扩展各个服务层
- **安全性：** 多层安全防护（网关、JWT、RBAC）

---

## 2. 技术栈选型

### 2.1 前端技术栈

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| **Next.js** | 15.x | React框架 | SSR/SSG支持，App Router，性能优异 |
| **React** | 19.x | UI库 | Server Components，生态成熟 |
| **TypeScript** | 5.x | 类型系统 | 类型安全，减少运行时错误 |
| **Tailwind CSS** | 4.x | CSS框架 | 原子化CSS，高度可定制 |
| **Shadcn/ui** | latest | 组件库 | 基于Radix UI，高质量组件 |
| **Zustand** | 5.x | 状态管理 | 轻量级，比Redux简单 |
| **Zod** | 3.x | 数据验证 | 类型安全的Schema验证 |
| **TanStack Query** | 5.x | 数据获取 | 服务器状态管理，缓存优化 |
| **Monaco Editor** | latest | 代码编辑器 | VS Code同款编辑器 |

### 2.2 后端技术栈

| 技术 | 版本 | 用途 | 选型理由 |
|------|------|------|----------|
| **NestJS** | 11.x | Node.js框架 | 企业级架构，模块化，依赖注入 |
| **Prisma** | 6.x | ORM | 类型安全，自动迁移，性能好 |
| **PostgreSQL** | 16.x | 关系数据库 | 功能强大，JSON支持，开源 |
| **Redis** | 7.x | 缓存/会话 | 高性能内存数据库 |
| **MinIO** | latest | 对象存储 | S3兼容，开源，易部署 |
| **JWT** | latest | 认证Token | 无状态认证，标准协议 |
| **Bcrypt** | latest | 密码加密 | 安全的密码Hash算法 |
| **Swagger** | latest | API文档 | 自动生成API文档 |

### 2.3 开发工具链

| 工具 | 用途 |
|------|------|
| **pnpm** | 包管理器（比npm/yarn更快） |
| **ESLint** | 代码检查 |
| **Prettier** | 代码格式化 |
| **Husky** | Git hooks |
| **lint-staged** | 提交前检查 |
| **Commitlint** | Commit message规范 |
| **Docker** | 容器化 |
| **Docker Compose** | 本地开发环境编排 |

### 2.4 测试技术栈

| 技术 | 用途 |
|------|------|
| **Vitest** | 单元测试框架（比Jest更快） |
| **Playwright** | E2E测试 |
| **Supertest** | API集成测试 |
| **Testing Library** | React组件测试 |

### 2.5 DevOps技术栈

| 技术 | 用途 |
|------|------|
| **GitHub Actions** | CI/CD |
| **Kubernetes** | 容器编排 |
| **Helm** | K8s包管理 |
| **Prometheus** | 监控指标收集 |
| **Grafana** | 监控可视化 |
| **ELK Stack** | 日志收集分析 |

---

## 3. 前端架构设计

### 3.1 前端目录结构

```
frontend/
├── src/
│   ├── app/                  # Next.js App Router
│   │   ├── (auth)/          # 认证相关页面组
│   │   │   ├── login/
│   │   │   └── register/
│   │   ├── (dashboard)/     # 主应用页面组
│   │   │   ├── projects/
│   │   │   ├── repositories/
│   │   │   └── settings/
│   │   ├── layout.tsx       # 根布局
│   │   ├── page.tsx         # 首页
│   │   └── error.tsx        # 错误页面
│   ├── components/           # 复用组件
│   │   ├── ui/              # UI基础组件（Shadcn/ui）
│   │   ├── layout/          # 布局组件
│   │   ├── forms/           # 表单组件
│   │   └── features/        # 功能组件
│   ├── lib/                  # 工具库
│   │   ├── api/             # API客户端
│   │   ├── auth/            # 认证工具
│   │   ├── utils/           # 通用工具
│   │   └── validations/     # Zod验证Schema
│   ├── hooks/                # 自定义Hooks
│   ├── stores/               # Zustand状态管理
│   ├── types/                # TypeScript类型定义
│   └── styles/               # 全局样式
├── public/                   # 静态资源
├── tests/                    # 测试文件
│   ├── unit/
│   ├── integration/
│   └── e2e/
├── next.config.js
├── tailwind.config.js
├── tsconfig.json
└── package.json
```

### 3.2 前端架构分层

```mermaid
graph TB
    subgraph "展示层 Presentation Layer"
        Pages[页面组件<br/>App Router Pages]
        Layouts[布局组件<br/>Layouts]
    end

    subgraph "组件层 Component Layer"
        Features[业务组件<br/>Feature Components]
        UI[UI组件<br/>Shadcn/ui]
    end

    subgraph "业务逻辑层 Business Logic Layer"
        Hooks[自定义Hooks]
        Stores[Zustand Stores]
        Validations[Zod Validations]
    end

    subgraph "数据层 Data Layer"
        APIClient[TanStack Query]
        HTTPClient[Axios/Fetch]
    end

    subgraph "工具层 Utility Layer"
        Utils[工具函数]
        Types[TS类型定义]
    end

    Pages --> Layouts
    Pages --> Features
    Features --> UI
    Features --> Hooks
    Features --> Stores

    Hooks --> APIClient
    Hooks --> Validations
    Stores --> APIClient

    APIClient --> HTTPClient
    HTTPClient --> Backend[后端API]

    Features --> Utils
    Hooks --> Utils
    Utils --> Types
```

### 3.3 前端关键设计模式

#### 3.3.1 页面渲染策略

- **静态页面（SSG）：** 首页、文档页面
- **服务端渲染（SSR）：** 项目列表、仓库详情（SEO优化）
- **客户端渲染（CSR）：** 用户设置、代码编辑器
- **增量静态再生（ISR）：** 公开项目页面（revalidate: 60s）

#### 3.3.2 数据获取模式

```typescript
// 使用TanStack Query进行数据获取
import { useQuery } from '@tanstack/react-query'

export function useProjects() {
  return useQuery({
    queryKey: ['projects'],
    queryFn: () => api.projects.getAll(),
    staleTime: 5 * 60 * 1000, // 5分钟
    cacheTime: 10 * 60 * 1000, // 10分钟
  })
}
```

#### 3.3.3 状态管理模式

```typescript
// Zustand Store示例
import { create } from 'zustand'

interface AuthStore {
  user: User | null
  token: string | null
  setUser: (user: User) => void
  setToken: (token: string) => void
  logout: () => void
}

export const useAuthStore = create<AuthStore>((set) => ({
  user: null,
  token: null,
  setUser: (user) => set({ user }),
  setToken: (token) => set({ token }),
  logout: () => set({ user: null, token: null }),
}))
```

---

## 4. 后端架构设计

### 4.1 后端目录结构

```
backend/
├── src/
│   ├── auth/                 # 认证模块
│   │   ├── auth.controller.ts
│   │   ├── auth.service.ts
│   │   ├── auth.module.ts
│   │   ├── guards/          # 认证守卫
│   │   ├── strategies/      # Passport策略
│   │   └── dto/             # 数据传输对象
│   ├── users/                # 用户模块
│   │   ├── users.controller.ts
│   │   ├── users.service.ts
│   │   ├── users.module.ts
│   │   └── dto/
│   ├── projects/             # 项目模块
│   │   ├── projects.controller.ts
│   │   ├── projects.service.ts
│   │   ├── projects.module.ts
│   │   └── dto/
│   ├── repositories/         # 仓库模块
│   │   ├── repositories.controller.ts
│   │   ├── repositories.service.ts
│   │   ├── repositories.module.ts
│   │   └── dto/
│   ├── consensus/            # 共识模块（Raft）
│   │   ├── raft.service.ts
│   │   ├── raft-node.ts
│   │   ├── raft-log.ts
│   │   └── raft.module.ts
│   ├── common/               # 公共模块
│   │   ├── decorators/      # 装饰器
│   │   ├── filters/         # 异常过滤器
│   │   ├── guards/          # 守卫
│   │   ├── interceptors/    # 拦截器
│   │   ├── pipes/           # 管道
│   │   └── utils/           # 工具函数
│   ├── database/             # 数据库配置
│   │   ├── prisma.service.ts
│   │   └── migrations/
│   ├── config/               # 配置
│   │   ├── app.config.ts
│   │   ├── database.config.ts
│   │   └── jwt.config.ts
│   ├── app.module.ts         # 根模块
│   └── main.ts               # 入口文件
├── prisma/
│   └── schema.prisma         # Prisma Schema
├── test/                     # 测试文件
│   ├── unit/
│   ├── integration/
│   └── e2e/
├── nest-cli.json
├── tsconfig.json
└── package.json
```

### 4.2 后端架构分层

```mermaid
graph TB
    subgraph "控制器层 Controller Layer"
        Controllers[REST Controllers<br/>@Controller]
    end

    subgraph "服务层 Service Layer"
        Services[Business Services<br/>@Injectable]
    end

    subgraph "数据访问层 Data Access Layer"
        Repositories[Prisma Client<br/>Type-safe ORM]
    end

    subgraph "基础设施层 Infrastructure Layer"
        Guards[Guards<br/>认证授权]
        Interceptors[Interceptors<br/>日志/转换]
        Pipes[Pipes<br/>验证]
        Filters[Exception Filters<br/>错误处理]
    end

    subgraph "数据库层 Database Layer"
        PostgreSQL[(PostgreSQL)]
        Redis[(Redis)]
        MinIO[(MinIO)]
    end

    Request[HTTP Request] --> Guards
    Guards --> Pipes
    Pipes --> Controllers

    Controllers --> Services
    Services --> Repositories

    Repositories --> PostgreSQL
    Services --> Redis
    Services --> MinIO

    Controllers --> Interceptors
    Interceptors --> Filters
    Filters --> Response[HTTP Response]
```

### 4.3 NestJS模块设计

#### 4.3.1 模块依赖关系

```mermaid
graph LR
    AppModule[App Module]

    AppModule --> AuthModule[Auth Module]
    AppModule --> UsersModule[Users Module]
    AppModule --> ProjectsModule[Projects Module]
    AppModule --> RepositoriesModule[Repositories Module]
    AppModule --> ConsensusModule[Consensus Module]
    AppModule --> DatabaseModule[Database Module]
    AppModule --> ConfigModule[Config Module]

    AuthModule --> UsersModule
    AuthModule --> DatabaseModule

    ProjectsModule --> UsersModule
    ProjectsModule --> DatabaseModule

    RepositoriesModule --> ProjectsModule
    RepositoriesModule --> DatabaseModule
    RepositoriesModule --> StorageModule[Storage Module]

    ConsensusModule --> DatabaseModule
    ConsensusModule --> ProjectsModule
    ConsensusModule --> RepositoriesModule
```

#### 4.3.2 依赖注入模式

```typescript
// Service示例 - 使用依赖注入
@Injectable()
export class ProjectsService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly usersService: UsersService,
    @Inject(CACHE_MANAGER) private cacheManager: Cache,
  ) {}

  async createProject(userId: string, dto: CreateProjectDto): Promise<Project> {
    // 验证用户存在
    const user = await this.usersService.findById(userId)
    if (!user) throw new NotFoundException('User not found')

    // 创建项目
    const project = await this.prisma.project.create({
      data: {
        name: dto.name,
        description: dto.description,
        visibility: dto.visibility,
        ownerId: userId,
      },
    })

    // 清除缓存
    await this.cacheManager.del(`user:${userId}:projects`)

    return project
  }
}
```

### 4.4 API接口设计原则

#### 4.4.1 RESTful API规范

| HTTP方法 | 路径 | 描述 | 示例 |
|----------|------|------|------|
| GET | /api/v1/resources | 获取资源列表 | GET /api/v1/projects |
| GET | /api/v1/resources/:id | 获取单个资源 | GET /api/v1/projects/123 |
| POST | /api/v1/resources | 创建资源 | POST /api/v1/projects |
| PUT | /api/v1/resources/:id | 完整更新资源 | PUT /api/v1/projects/123 |
| PATCH | /api/v1/resources/:id | 部分更新资源 | PATCH /api/v1/projects/123 |
| DELETE | /api/v1/resources/:id | 删除资源 | DELETE /api/v1/projects/123 |

#### 4.4.2 统一响应格式

```typescript
// 成功响应
{
  "success": true,
  "data": {
    "id": "123",
    "name": "My Project"
  },
  "meta": {
    "timestamp": "2025-10-10T12:00:00Z",
    "requestId": "req-abc123"
  }
}

// 分页响应
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "total": 100,
    "totalPages": 5
  }
}

// 错误响应
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Invalid credentials",
    "details": null
  },
  "meta": {
    "timestamp": "2025-10-10T12:00:00Z",
    "requestId": "req-abc123"
  }
}
```

---

## 5. 数据库架构设计

### 5.1 数据库选型

- **主数据库：** PostgreSQL 16（关系数据、事务支持）
- **缓存层：** Redis 7（会话、热点数据）
- **对象存储：** MinIO（代码文件、大文件）

### 5.2 数据库架构

```mermaid
graph TB
    subgraph "应用层"
        App[NestJS Application]
    end

    subgraph "ORM层"
        Prisma[Prisma Client]
    end

    subgraph "数据库集群"
        Master[PostgreSQL Master<br/>读写]
        Replica1[PostgreSQL Replica 1<br/>只读]
        Replica2[PostgreSQL Replica 2<br/>只读]
    end

    subgraph "缓存层"
        RedisCache[Redis Cache<br/>热点数据缓存]
        RedisSession[Redis Session<br/>会话存储]
    end

    subgraph "对象存储"
        MinIOCluster[MinIO Cluster<br/>文件存储]
    end

    App --> Prisma
    Prisma --> Master
    Prisma --> Replica1
    Prisma --> Replica2

    App --> RedisCache
    App --> RedisSession
    App --> MinIOCluster

    Master -.复制.-> Replica1
    Master -.复制.-> Replica2
```

### 5.3 Prisma Schema设计概要

详细的数据库设计见《数据库设计文档.md》

```prisma
// 用户模型
model User {
  id            String    @id @default(cuid())
  username      String    @unique
  email         String    @unique
  passwordHash  String
  avatar        String?
  bio           String?
  role          UserRole  @default(DEVELOPER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  ownedProjects  Project[]  @relation("ProjectOwner")
  projectMembers ProjectMember[]
  commits        Commit[]
}

// 项目模型
model Project {
  id          String      @id @default(cuid())
  name        String
  description String?
  visibility  Visibility  @default(PRIVATE)
  ownerId     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  owner       User              @relation("ProjectOwner", fields: [ownerId], references: [id])
  repository  Repository?
  members     ProjectMember[]

  @@unique([ownerId, name])
}

// 仓库模型
model Repository {
  id            String   @id @default(cuid())
  projectId     String   @unique
  defaultBranch String   @default("main")
  storageUsed   BigInt   @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branches Branch[]
  commits  Commit[]
}
```

---

## 6. 分布式架构设计

### 6.1 Raft共识算法概述

Raft是一种易于理解的分布式共识算法，用于在多个节点间保持数据一致性。

**核心特性：**
- **Leader选举：** 集群中有且仅有一个Leader
- **日志复制：** Leader接收客户端请求，复制到Follower
- **安全性：** 已提交的日志不会丢失

### 6.2 Raft节点状态机

```mermaid
stateDiagram-v2
    [*] --> Follower
    Follower --> Candidate: Election timeout
    Candidate --> Leader: Receives majority votes
    Candidate --> Follower: Discovers current leader or new term
    Candidate --> Candidate: Election timeout, new election
    Leader --> Follower: Discovers server with higher term
    Leader --> [*]
    Follower --> [*]
    Candidate --> [*]
```

### 6.3 Raft架构设计

```mermaid
graph TB
    subgraph "Raft Cluster"
        Node1[Node 1<br/>Leader]
        Node2[Node 2<br/>Follower]
        Node3[Node 3<br/>Follower]
    end

    subgraph "Client Layer"
        Client[Application Client]
    end

    subgraph "Consensus Layer"
        RaftLog1[Raft Log]
        RaftLog2[Raft Log]
        RaftLog3[Raft Log]
    end

    subgraph "State Machine"
        SM1[State Machine<br/>PostgreSQL]
        SM2[State Machine<br/>PostgreSQL]
        SM3[State Machine<br/>PostgreSQL]
    end

    Client --> Node1
    Client -.-> Node2
    Client -.-> Node3

    Node1 --> RaftLog1
    Node2 --> RaftLog2
    Node3 --> RaftLog3

    Node1 -.复制日志.-> Node2
    Node1 -.复制日志.-> Node3

    RaftLog1 --> SM1
    RaftLog2 --> SM2
    RaftLog3 --> SM3
```

### 6.4 简化版Raft实现要点

详细设计见《分布式共识算法设计方案.md》

**简化点：**
1. 不实现日志压缩（Snapshot）
2. 不实现成员变更（Fixed Cluster）
3. 只保证关键数据的一致性（项目、仓库元数据）

**实现重点：**
1. **Leader选举：**
   - 选举超时：150-300ms随机
   - 投票规则：一任期内只投一票

2. **日志复制：**
   - Leader接收写请求
   - 并行复制到所有Follower
   - 大多数确认后提交

3. **故障恢复：**
   - 心跳检测（100ms间隔）
   - Leader故障自动重新选举
   - 日志修复机制

---

## 7. API设计

### 7.1 API版本管理

- **URL版本：** `/api/v1/...`
- **向后兼容：** v1稳定后不做breaking changes
- **弃用策略：** 新版本发布6个月后可弃用旧版本

### 7.2 核心API端点

详细API文档通过Swagger自动生成。

#### 7.2.1 认证API

| 端点 | 方法 | 描述 | 认证 |
|------|------|------|------|
| `/api/v1/auth/register` | POST | 用户注册 | 否 |
| `/api/v1/auth/login` | POST | 用户登录 | 否 |
| `/api/v1/auth/logout` | POST | 用户登出 | 是 |
| `/api/v1/auth/refresh` | POST | 刷新Token | 是 |
| `/api/v1/auth/me` | GET | 获取当前用户信息 | 是 |

#### 7.2.2 项目API

| 端点 | 方法 | 描述 | 认证 |
|------|------|------|------|
| `/api/v1/projects` | GET | 获取项目列表 | 是 |
| `/api/v1/projects` | POST | 创建项目 | 是 |
| `/api/v1/projects/:id` | GET | 获取项目详情 | 是 |
| `/api/v1/projects/:id` | PATCH | 更新项目 | 是 |
| `/api/v1/projects/:id` | DELETE | 删除项目 | 是 |
| `/api/v1/projects/:id/members` | GET | 获取项目成员 | 是 |
| `/api/v1/projects/:id/members` | POST | 邀请成员 | 是 |
| `/api/v1/projects/:id/members/:userId` | DELETE | 移除成员 | 是 |

#### 7.2.3 仓库API

| 端点 | 方法 | 描述 | 认证 |
|------|------|------|------|
| `/api/v1/repositories/:id/files` | GET | 获取文件列表 | 是 |
| `/api/v1/repositories/:id/files` | POST | 上传文件 | 是 |
| `/api/v1/repositories/:id/files/:path` | GET | 获取文件内容 | 是 |
| `/api/v1/repositories/:id/commits` | GET | 获取提交历史 | 是 |
| `/api/v1/repositories/:id/commits` | POST | 创建提交 | 是 |
| `/api/v1/repositories/:id/branches` | GET | 获取分支列表 | 是 |
| `/api/v1/repositories/:id/branches` | POST | 创建分支 | 是 |

### 7.3 API认证流程

```mermaid
sequenceDiagram
    participant Client
    participant Gateway as API Gateway
    participant AuthService
    participant Redis
    participant Resource as Resource Service

    Client->>Gateway: POST /auth/login<br/>{username, password}
    Gateway->>AuthService: 验证凭据
    AuthService->>AuthService: 验证密码Hash
    AuthService->>AuthService: 生成JWT Token
    AuthService->>Redis: 存储Session
    AuthService-->>Gateway: {token, refreshToken}
    Gateway-->>Client: 200 OK<br/>{token}

    Note over Client: 后续请求携带Token

    Client->>Gateway: GET /projects<br/>Authorization: Bearer {token}
    Gateway->>Gateway: 验证JWT签名
    Gateway->>Redis: 检查Token有效性
    Redis-->>Gateway: Valid
    Gateway->>Resource: 请求资源（附带用户ID）
    Resource->>Resource: 业务逻辑处理
    Resource-->>Gateway: 返回数据
    Gateway-->>Client: 200 OK<br/>{data}
```

---

## 8. 安全架构

### 8.1 安全层次

```mermaid
graph TB
    subgraph "网络安全层"
        HTTPS[HTTPS/TLS 1.3]
        Firewall[防火墙规则]
        DDoS[DDoS防护]
    end

    subgraph "应用安全层"
        JWT[JWT认证]
        RBAC[RBAC权限控制]
        InputVal[输入验证]
        XSS[XSS防护]
        CSRF[CSRF防护]
    end

    subgraph "数据安全层"
        Encryption[数据加密]
        Hashing[密码Hash]
        Backup[数据备份]
    end

    subgraph "基础设施安全层"
        SecretMgmt[密钥管理]
        Audit[审计日志]
        Monitoring[安全监控]
    end

    Client[客户端] --> HTTPS
    HTTPS --> Firewall
    Firewall --> JWT
    JWT --> RBAC
    RBAC --> InputVal

    InputVal --> Encryption
    Encryption --> Database[(数据库)]
```

### 8.2 认证与授权

#### 8.2.1 JWT Token结构

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id",
    "username": "john_doe",
    "role": "DEVELOPER",
    "iat": 1728547200,
    "exp": 1729152000
  },
  "signature": "..."
}
```

#### 8.2.2 RBAC权限矩阵

| 操作 | Owner | Member | Viewer | Public |
|------|-------|--------|--------|--------|
| 查看公开项目 | ✅ | ✅ | ✅ | ✅ |
| 查看私有项目 | ✅ | ✅ | ✅ | ❌ |
| 创建项目 | ✅ | N/A | N/A | ❌ |
| 编辑项目 | ✅ | ❌ | ❌ | ❌ |
| 删除项目 | ✅ | ❌ | ❌ | ❌ |
| 上传代码 | ✅ | ✅ | ❌ | ❌ |
| 下载代码 | ✅ | ✅ | ✅ | 公开✅ |
| 管理成员 | ✅ | ❌ | ❌ | ❌ |

### 8.3 安全最佳实践

1. **密码安全：**
   - Bcrypt加密（salt rounds: 12）
   - 密码强度验证
   - 登录失败锁定（5次/10分钟）

2. **Token安全：**
   - JWT签名验证
   - Token过期时间（7天）
   - Refresh Token轮换
   - Token黑名单（登出时）

3. **输入验证：**
   - 所有输入使用Zod/class-validator验证
   - SQL注入防护（使用Prisma ORM）
   - XSS防护（输出编码）
   - CSRF Token验证

4. **传输安全：**
   - 强制HTTPS（HSTS Header）
   - TLS 1.3
   - 安全Headers（Helmet.js）

5. **数据安全：**
   - 敏感数据加密存储
   - 定期数据备份
   - 日志脱敏

---

## 9. 部署架构

### 9.1 Kubernetes部署架构

```mermaid
graph TB
    subgraph "Ingress Layer"
        Ingress[Nginx Ingress<br/>SSL Termination]
    end

    subgraph "Frontend Namespace"
        FrontPod1[Next.js Pod 1]
        FrontPod2[Next.js Pod 2]
        FrontService[Frontend Service<br/>LoadBalancer]
    end

    subgraph "Backend Namespace"
        BackPod1[NestJS Pod 1]
        BackPod2[NestJS Pod 2]
        BackPod3[NestJS Pod 3]
        BackService[Backend Service<br/>LoadBalancer]
    end

    subgraph "Data Layer"
        PostgreSQLPrimary[PostgreSQL Primary<br/>StatefulSet]
        PostgreSQLReplica[PostgreSQL Replica<br/>StatefulSet]
        RedisCluster[Redis Cluster<br/>StatefulSet]
        MinIOCluster[MinIO Cluster<br/>StatefulSet]
    end

    subgraph "Persistent Storage"
        PV1[Persistent Volume 1]
        PV2[Persistent Volume 2]
        PV3[Persistent Volume 3]
    end

    Internet[Internet] --> Ingress
    Ingress --> FrontService
    Ingress --> BackService

    FrontService --> FrontPod1
    FrontService --> FrontPod2

    BackService --> BackPod1
    BackService --> BackPod2
    BackService --> BackPod3

    BackPod1 --> PostgreSQLPrimary
    BackPod1 --> PostgreSQLReplica
    BackPod1 --> RedisCluster
    BackPod1 --> MinIOCluster

    PostgreSQLPrimary --> PV1
    RedisCluster --> PV2
    MinIOCluster --> PV3
```

### 9.2 Docker Compose本地开发

```yaml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:4000
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "4000:4000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/devplatform
      - REDIS_URL=redis://redis:6379
      - MINIO_ENDPOINT=minio:9000
    depends_on:
      - postgres
      - redis
      - minio

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=devplatform
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

volumes:
  postgres_data:
  minio_data:
```

### 9.3 CI/CD流程

```mermaid
graph LR
    Dev[开发者] -->|git push| GitHub[GitHub]
    GitHub -->|webhook| Actions[GitHub Actions]

    Actions --> Build[构建和测试]
    Build --> Lint[Lint检查]
    Lint --> UnitTest[单元测试]
    UnitTest --> IntegrationTest[集成测试]
    IntegrationTest --> E2ETest[E2E测试]

    E2ETest --> BuildImage[构建Docker镜像]
    BuildImage --> PushRegistry[推送到Registry]

    PushRegistry --> DeployStaging[部署到Staging]
    DeployStaging --> SmokeTest[冒烟测试]

    SmokeTest -->|Manual Approval| DeployProd[部署到生产]
    DeployProd --> HealthCheck[健康检查]
```

---

## 10. UML设计图

### 10.1 用例图

```mermaid
graph TB
    Developer((开发者))
    Member((项目成员))
    Viewer((访客))
    Admin((管理员))

    UC1[注册登录]
    UC2[创建项目]
    UC3[管理项目]
    UC4[上传代码]
    UC5[浏览代码]
    UC6[管理成员]
    UC7[创建分支]
    UC8[查看历史]
    UC9[系统管理]

    Developer --> UC1
    Developer --> UC2
    Developer --> UC3
    Developer --> UC4
    Developer --> UC5
    Developer --> UC6
    Developer --> UC7
    Developer --> UC8

    Member --> UC1
    Member --> UC4
    Member --> UC5
    Member --> UC8

    Viewer --> UC1
    Viewer --> UC5

    Admin --> UC9
```

### 10.2 核心类图

```mermaid
classDiagram
    class User {
        +String id
        +String username
        +String email
        +String passwordHash
        +String avatar
        +UserRole role
        +DateTime createdAt
        +register()
        +login()
        +updateProfile()
    }

    class Project {
        +String id
        +String name
        +String description
        +Visibility visibility
        +String ownerId
        +DateTime createdAt
        +create()
        +update()
        +delete()
        +addMember()
    }

    class Repository {
        +String id
        +String projectId
        +String defaultBranch
        +BigInt storageUsed
        +init()
        +createBranch()
        +uploadFile()
    }

    class Branch {
        +String id
        +String repositoryId
        +String name
        +String commitId
        +create()
        +checkout()
    }

    class Commit {
        +String id
        +String repositoryId
        +String authorId
        +String message
        +String hash
        +DateTime createdAt
        +create()
        +getHistory()
    }

    class File {
        +String id
        +String commitId
        +String path
        +String content
        +Int size
        +read()
        +write()
    }

    class ProjectMember {
        +String id
        +String projectId
        +String userId
        +MemberRole role
        +invite()
        +remove()
    }

    User "1" --> "*" Project : owns
    User "1" --> "*" ProjectMember : participates
    Project "1" --> "1" Repository : has
    Project "1" --> "*" ProjectMember : has
    Repository "1" --> "*" Branch : contains
    Repository "1" --> "*" Commit : contains
    Branch "1" --> "1" Commit : points to
    Commit "1" --> "*" File : contains
    Commit "*" --> "1" User : authored by
```

### 10.3 序列图 - 用户登录

```mermaid
sequenceDiagram
    actor User
    participant Frontend
    participant Gateway
    participant AuthService
    participant Database
    participant Redis

    User->>Frontend: 输入用户名和密码
    Frontend->>Frontend: 前端验证
    Frontend->>Gateway: POST /api/v1/auth/login
    Gateway->>AuthService: 转发请求

    AuthService->>Database: 查询用户
    Database-->>AuthService: 返回用户信息

    AuthService->>AuthService: 验证密码（Bcrypt compare）

    alt 密码正确
        AuthService->>AuthService: 生成JWT Token
        AuthService->>Redis: 存储Session
        Redis-->>AuthService: OK
        AuthService-->>Gateway: 200 {token, user}
        Gateway-->>Frontend: 200 {token, user}
        Frontend->>Frontend: 存储Token到localStorage
        Frontend-->>User: 跳转到Dashboard
    else 密码错误
        AuthService-->>Gateway: 401 Invalid credentials
        Gateway-->>Frontend: 401 Error
        Frontend-->>User: 显示错误信息
    end
```

### 10.4 序列图 - 创建项目和上传代码

```mermaid
sequenceDiagram
    actor User
    participant Frontend
    participant ProjectService
    participant RepoService
    participant RaftService
    participant Database
    participant MinIO

    User->>Frontend: 点击创建项目
    Frontend->>ProjectService: POST /api/v1/projects<br/>{name, description}

    ProjectService->>RaftService: 请求写入（强一致性）
    RaftService->>RaftService: Leader处理请求
    RaftService->>RaftService: 日志复制到大多数节点
    RaftService-->>ProjectService: 确认提交

    ProjectService->>Database: 创建Project记录
    ProjectService->>RepoService: 初始化Repository
    RepoService->>Database: 创建Repository记录
    RepoService->>Database: 创建默认Branch（main）

    Database-->>ProjectService: 返回Project
    ProjectService-->>Frontend: 201 Created
    Frontend-->>User: 显示项目页面

    User->>Frontend: 上传代码文件
    Frontend->>RepoService: POST /api/v1/repositories/:id/files<br/>FormData(files)

    RepoService->>RaftService: 请求写入文件元数据
    RaftService-->>RepoService: 确认

    RepoService->>MinIO: 存储文件内容
    MinIO-->>RepoService: 返回文件URL

    RepoService->>Database: 创建Commit和File记录
    Database-->>RepoService: OK

    RepoService-->>Frontend: 200 OK
    Frontend-->>User: 显示上传成功
```

### 10.5 组件图

```mermaid
graph TB
    subgraph "Frontend Layer"
        NextJS[Next.js Application]
        ReactComponents[React Components]
        StateManagement[Zustand Stores]
    end

    subgraph "API Layer"
        APIGateway[API Gateway]
        RESTful[RESTful Endpoints]
    end

    subgraph "Business Logic Layer"
        AuthModule[Auth Module]
        UserModule[User Module]
        ProjectModule[Project Module]
        RepoModule[Repository Module]
    end

    subgraph "Consensus Layer"
        RaftLeader[Raft Leader]
        RaftFollower1[Raft Follower 1]
        RaftFollower2[Raft Follower 2]
    end

    subgraph "Data Layer"
        PrismaORM[Prisma ORM]
        PostgreSQL[(PostgreSQL)]
        RedisCache[(Redis)]
        MinIOStorage[(MinIO)]
    end

    NextJS --> ReactComponents
    ReactComponents --> StateManagement
    StateManagement --> APIGateway

    APIGateway --> RESTful
    RESTful --> AuthModule
    RESTful --> UserModule
    RESTful --> ProjectModule
    RESTful --> RepoModule

    ProjectModule --> RaftLeader
    RepoModule --> RaftLeader
    RaftLeader -.复制.-> RaftFollower1
    RaftLeader -.复制.-> RaftFollower2

    AuthModule --> PrismaORM
    UserModule --> PrismaORM
    ProjectModule --> PrismaORM
    RepoModule --> PrismaORM

    PrismaORM --> PostgreSQL
    AuthModule --> RedisCache
    RepoModule --> MinIOStorage
```

### 10.6 部署图

```mermaid
graph TB
    subgraph "用户设备"
        Browser[Web Browser]
    end

    subgraph "CDN"
        CloudFlare[CloudFlare CDN]
    end

    subgraph "K8s Cluster - Frontend"
        FrontendPod1[Next.js Pod 1]
        FrontendPod2[Next.js Pod 2]
    end

    subgraph "K8s Cluster - Backend"
        BackendPod1[NestJS Pod 1<br/>Raft Leader]
        BackendPod2[NestJS Pod 2<br/>Raft Follower]
        BackendPod3[NestJS Pod 3<br/>Raft Follower]
    end

    subgraph "Database Cluster"
        DBMaster[PostgreSQL Primary]
        DBReplica1[PostgreSQL Replica 1]
        DBReplica2[PostgreSQL Replica 2]
    end

    subgraph "Storage & Cache"
        RedisCluster[Redis Cluster<br/>3 Nodes]
        MinIOCluster[MinIO Cluster<br/>4 Nodes]
    end

    subgraph "Monitoring"
        Prometheus[Prometheus]
        Grafana[Grafana]
        ELK[ELK Stack]
    end

    Browser --> CloudFlare
    CloudFlare --> FrontendPod1
    CloudFlare --> FrontendPod2

    FrontendPod1 --> BackendPod1
    FrontendPod2 --> BackendPod2

    BackendPod1 --> DBMaster
    BackendPod2 --> DBReplica1
    BackendPod3 --> DBReplica2

    BackendPod1 --> RedisCluster
    BackendPod1 --> MinIOCluster

    BackendPod1 -.-> Prometheus
    BackendPod1 -.-> ELK
    Prometheus --> Grafana
```

---

## 11. 性能优化策略

### 11.1 前端性能优化

1. **代码分割（Code Splitting）**
   - 路由级别分割（Next.js自动）
   - 组件级按需加载（React.lazy）
   - 第三方库按需引入

2. **图片优化**
   - Next.js Image组件自动优化
   - WebP格式优先
   - 响应式图片（srcset）
   - 懒加载（Intersection Observer）

3. **缓存策略**
   - 静态资源缓存（CDN）
   - API响应缓存（TanStack Query）
   - Service Worker缓存（PWA）

4. **渲染优化**
   - 服务端渲染（SSR）首屏
   - 静态生成（SSG）营销页
   - 增量静态再生（ISR）项目页

### 11.2 后端性能优化

1. **数据库优化**
   - 索引优化（复合索引）
   - 查询优化（N+1问题解决）
   - 连接池管理
   - 读写分离

2. **缓存策略**
   - Redis缓存热点数据
   - 缓存失效策略（TTL + 主动失效）
   - 缓存预热
   - 布隆过滤器防缓存穿透

3. **API优化**
   - 响应压缩（gzip/brotli）
   - 分页查询
   - GraphQL按需查询
   - 批量操作API

4. **异步处理**
   - 消息队列（Bull）
   - 后台任务处理
   - Webhooks异步通知

---

## 12. 可扩展性设计

### 12.1 水平扩展能力

- **无状态服务：** 所有服务设计为无状态，便于横向扩展
- **负载均衡：** 支持动态增减节点
- **数据库扩展：** 读写分离 + 分片
- **对象存储扩展：** MinIO集群模式

### 12.2 未来扩展点

1. **功能扩展：**
   - Issue和Bug追踪系统
   - Pull Request和代码审查
   - CI/CD Pipeline
   - Wiki和文档系统

2. **性能扩展：**
   - 消息队列（Kafka/RabbitMQ）
   - 搜索引擎（Elasticsearch）
   - 图数据库（关系图谱）
   - 实时通信（WebSocket）

3. **区域扩展：**
   - 多区域部署
   - 全球CDN
   - 数据本地化

---

## 13. 架构决策记录（ADR）

### ADR-001: 选择Next.js作为前端框架

**日期：** 2025-10-10
**状态：** 已采纳

**背景：**
需要选择一个现代化的React框架来构建前端应用。

**决策：**
选择Next.js 15作为前端框架。

**理由：**
- 内置SSR/SSG支持，SEO友好
- App Router提供更好的路由管理
- React 19 Server Components支持
- 优秀的性能和开发体验
- 社区活跃，生态成熟

**后果：**
- 学习曲线相对较陡
- 需要理解SSR/CSR混合模式
- 部署稍复杂（需Node.js环境）

---

### ADR-002: 选择NestJS作为后端框架

**日期：** 2025-10-10
**状态：** 已采纳

**背景：**
需要选择一个企业级的Node.js后端框架。

**决策：**
选择NestJS作为后端框架。

**理由：**
- 模块化架构，易于维护和扩展
- 依赖注入，测试友好
- TypeScript原生支持
- 与前端技术栈统一（TypeScript）
- 完善的文档和最佳实践

**后果：**
- 相比Express更重量级
- 需要理解依赖注入等概念
- 初始项目配置较多

---

### ADR-003: 使用Prisma作为ORM

**日期：** 2025-10-10
**状态：** 已采纳

**背景：**
需要选择一个类型安全的ORM工具。

**决策：**
使用Prisma作为ORM。

**理由：**
- 类型安全，自动生成TypeScript类型
- 声明式Schema，易于维护
- 自动化数据库迁移
- 出色的开发体验（Prisma Studio）
- 性能优异

**后果：**
- 相对较新的工具，社区相对小
- 某些复杂查询可能需要Raw SQL
- Schema变更需要重新生成

---

### ADR-004: 实现简化版Raft算法

**日期：** 2025-10-10
**状态：** 已采纳

**背景：**
需要实现分布式共识算法保证数据一致性。

**决策：**
实现简化版的Raft算法。

**理由：**
- Raft相比Paxos更易理解和实现
- 满足学术研究需求
- 为MVP提供足够的一致性保证
- 简化版减少开发复杂度

**后果：**
- 不支持动态成员变更
- 不支持日志压缩
- 性能可能不如成熟方案（如etcd）
- 后期可能需要迁移到成熟方案

---

## 14. 附录

### 14.1 参考文献

1. "Building Microservices" by Sam Newman
2. "Designing Data-Intensive Applications" by Martin Kleppmann
3. "In Search of an Understandable Consensus Algorithm (Extended Version)" by Diego Ongaro and John Ousterhout
4. Next.js Official Documentation - https://nextjs.org/docs
5. NestJS Official Documentation - https://docs.nestjs.com
6. Prisma Documentation - https://www.prisma.io/docs
7. Raft Consensus Algorithm - https://raft.github.io

### 14.2 术语缩写

- **SSR:** Server-Side Rendering（服务端渲染）
- **SSG:** Static Site Generation（静态站点生成）
- **ISR:** Incremental Static Regeneration（增量静态再生）
- **ORM:** Object-Relational Mapping（对象关系映射）
- **JWT:** JSON Web Token
- **RBAC:** Role-Based Access Control（基于角色的访问控制）
- **CDN:** Content Delivery Network（内容分发网络）
- **ADR:** Architecture Decision Record（架构决策记录）

---

**文档结束**
