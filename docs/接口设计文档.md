# 接口设计文档

**项目名称：** 基于云计算的开发协作平台（Flotilla）
**版本：** v2.0（基于实现状态更新）
**编写日期：** 2025-10-15
**最后更新：** 2025-12-22
**编写人：** JIA
**API Base URL：** `http://localhost:4000/api`

---

> **实现状态说明**: ✅ 已实现 | ⚠️ 部分实现 | ❌ 未实现
>
> 本文档已根据实际控制器实现更新，当前后端包含 **22个API控制器** 和 **100+个端点**。

---

## 1. 接口概述

### 1.1 设计原则

本API遵循RESTful设计规范，采用前后端分离架构，所有接口返回JSON格式数据。

**核心原则：**

- ✅ **资源导向：** URL表示资源，HTTP方法表示操作
- ✅ **无状态：** 使用JWT token进行认证，服务器不保存会话
- ✅ **统一响应：** 所有接口返回统一的响应格式
- ✅ **错误处理：** 使用标准HTTP状态码和自定义错误信息
- ✅ **版本控制：** 通过URL路径进行版本管理（未来）

### 1.2 认证机制

**JWT Token认证：**

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Token生命周期：**

- Access Token有效期：7天
- Refresh Token有效期：30天

### 1.3 通用响应格式

#### 成功响应

```json
{
  "success": true,
  "data": {
    // 返回的数据对象
  }
}
```

#### 错误响应

```json
{
  "success": false,
  "error": "错误信息描述",
  "statusCode": 400,
  "timestamp": "2025-10-15T08:00:00.000Z",
  "path": "/api/projects"
}
```

### 1.4 HTTP状态码

| 状态码                    | 含义       | 使用场景           |
| ------------------------- | ---------- | ------------------ |
| 200 OK                    | 成功       | GET/PUT/DELETE成功 |
| 201 Created               | 已创建     | POST创建资源成功   |
| 400 Bad Request           | 请求错误   | 参数验证失败       |
| 401 Unauthorized          | 未认证     | Token缺失或失效    |
| 403 Forbidden             | 无权限     | 权限不足           |
| 404 Not Found             | 未找到     | 资源不存在         |
| 409 Conflict              | 冲突       | 资源已存在         |
| 500 Internal Server Error | 服务器错误 | 内部异常           |

---

## 2. 认证模块 API

### 2.1 用户注册

**接口描述：** 新用户注册账号

**请求：**

```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "Test123456"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 验证规则 |
|------|------|------|------|----------|
| username | string | 是 | 用户名 | 3-20字符，仅字母数字下划线 |
| email | string | 是 | 邮箱 | 有效邮箱格式 |
| password | string | 是 | 密码 | 最少8位，包含大小写字母和数字 |

**成功响应：**

```json
{
  "id": "clxxx...",
  "username": "testuser",
  "email": "test@example.com",
  "role": "USER",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "createdAt": "2025-10-15T08:00:00.000Z"
}
```

**错误响应：**

```json
{
  "statusCode": 409,
  "message": "Username already exists",
  "error": "Conflict"
}
```

---

### 2.2 用户登录

**接口描述：** 用户登录获取token

**请求：**

```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "Test123456"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名或邮箱 |
| password | string | 是 | 密码 |

**成功响应：**

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "clxxx...",
    "username": "testuser",
    "email": "test@example.com",
    "role": "USER"
  }
}
```

---

### 2.3 刷新Token

**接口描述：** 使用refresh token获取新的access token

**请求：**

```http
POST /api/auth/refresh
Content-Type: application/json

{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**成功响应：**

```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

---

### 2.4 获取当前用户

**接口描述：** 获取当前登录用户信息

**请求：**

```http
GET /api/auth/me
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "id": "clxxx...",
  "username": "testuser",
  "email": "test@example.com",
  "role": "USER",
  "avatar": "https://minio.example.com/avatars/xxx.jpg",
  "bio": "个人简介",
  "createdAt": "2025-10-15T08:00:00.000Z",
  "updatedAt": "2025-10-15T08:00:00.000Z"
}
```

---

## 3. 用户模块 API

### 3.1 获取用户列表

**接口描述：** 获取所有用户列表（管理员）

**请求：**

```http
GET /api/users?page=1&limit=20&search=test
Authorization: Bearer <token>
```

**查询参数：**
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| page | number | 否 | 1 | 页码 |
| limit | number | 否 | 20 | 每页数量 |
| search | string | 否 | - | 搜索关键词 |

**成功响应：**

```json
{
  "data": [
    {
      "id": "clxxx...",
      "username": "user1",
      "email": "user1@example.com",
      "role": "USER",
      "createdAt": "2025-10-15T08:00:00.000Z"
    }
  ],
  "total": 100,
  "page": 1,
  "limit": 20
}
```

---

### 3.2 获取用户详情

**接口描述：** 获取指定用户信息

**请求：**

```http
GET /api/users/:id
Authorization: Bearer <token>
```

**路径参数：**
| 参数 | 类型 | 说明 |
|------|------|------|
| id | string | 用户ID |

**成功响应：** 同2.4

---

### 3.3 更新用户信息

**接口描述：** 更新当前用户信息

**请求：**

```http
PUT /api/users/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "bio": "更新后的个人简介",
  "avatar": "新头像URL"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| bio | string | 否 | 个人简介 |
| avatar | string | 否 | 头像URL |

---

### 3.4 修改密码

**接口描述：** 修改当前用户密码

**请求：**

```http
PATCH /api/users/:id/password
Authorization: Bearer <token>
Content-Type: application/json

{
  "oldPassword": "OldPass123456",
  "newPassword": "NewPass123456"
}
```

---

## 4. 项目模块 API

### 4.1 创建项目

**接口描述：** 创建新项目

**请求：**

```http
POST /api/projects
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "my-project",
  "description": "项目描述",
  "visibility": "PUBLIC"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| name | string | 是 | 项目名称 | 2-50字符 |
| description | string | 否 | 项目描述 | 最多500字符 |
| visibility | enum | 是 | 可见性 | PUBLIC / PRIVATE |

**成功响应：**

```json
{
  "id": "clxxx...",
  "name": "my-project",
  "description": "项目描述",
  "visibility": "PUBLIC",
  "ownerId": "clxxx...",
  "owner": {
    "id": "clxxx...",
    "username": "testuser",
    "email": "test@example.com"
  },
  "createdAt": "2025-10-15T08:00:00.000Z",
  "updatedAt": "2025-10-15T08:00:00.000Z"
}
```

---

### 4.2 获取项目列表

**接口描述：** 获取当前用户的项目列表

**请求：**

```http
GET /api/projects?page=1&limit=20&search=test&visibility=PUBLIC
Authorization: Bearer <token>
```

**查询参数：**
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| page | number | 否 | 1 | 页码 |
| limit | number | 否 | 20 | 每页数量 |
| search | string | 否 | - | 搜索关键词 |
| visibility | enum | 否 | - | PUBLIC / PRIVATE |

**成功响应：**

```json
{
  "data": [
    {
      "id": "clxxx...",
      "name": "my-project",
      "description": "项目描述",
      "visibility": "PUBLIC",
      "owner": {
        "username": "testuser"
      },
      "membersCount": 3,
      "createdAt": "2025-10-15T08:00:00.000Z"
    }
  ],
  "total": 10,
  "page": 1,
  "limit": 20
}
```

---

### 4.3 获取项目详情

**接口描述：** 获取项目详细信息

**请求：**

```http
GET /api/projects/:id
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "id": "clxxx...",
  "name": "my-project",
  "description": "项目描述",
  "visibility": "PUBLIC",
  "owner": {
    "id": "clxxx...",
    "username": "testuser"
  },
  "members": [
    {
      "id": "clxxx...",
      "userId": "clxxx...",
      "user": {
        "username": "member1"
      },
      "role": "MEMBER",
      "joinedAt": "2025-10-15T08:00:00.000Z"
    }
  ],
  "repository": {
    "id": "clxxx...",
    "defaultBranch": "main",
    "branchesCount": 2,
    "commitsCount": 15
  },
  "createdAt": "2025-10-15T08:00:00.000Z",
  "updatedAt": "2025-10-15T08:00:00.000Z"
}
```

---

### 4.4 更新项目

**接口描述：** 更新项目信息（仅Owner）

**请求：**

```http
PUT /api/projects/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "new-project-name",
  "description": "新描述",
  "visibility": "PRIVATE"
}
```

---

### 4.5 删除项目

**接口描述：** 删除项目（仅Owner）

**请求：**

```http
DELETE /api/projects/:id
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "message": "Project deleted successfully"
}
```

---

### 4.6 添加项目成员

**接口描述：** 邀请用户加入项目（仅Owner）

**请求：**

```http
POST /api/projects/:id/members
Authorization: Bearer <token>
Content-Type: application/json

{
  "userId": "clxxx...",
  "role": "MEMBER"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| userId | string | 是 | 用户ID | - |
| role | enum | 是 | 角色 | OWNER / MAINTAINER / MEMBER / VIEWER |

---

### 4.7 移除项目成员

**接口描述：** 移除项目成员（仅Owner）

**请求：**

```http
DELETE /api/projects/:id/members/:userId
Authorization: Bearer <token>
```

---

### 4.8 更新成员角色

**接口描述：** 修改成员角色（仅Owner）

**请求：**

```http
PUT /api/projects/:id/members/:userId/role
Authorization: Bearer <token>
Content-Type: application/json

{
  "role": "MEMBER"
}
```

---

## 5. 文件模块 API

### 5.1 上传文件

**接口描述：** 上传代码文件到MinIO

**请求：**

```http
POST /api/files/upload
Authorization: Bearer <token>
Content-Type: multipart/form-data

{
  file: [binary data]
  projectId: "clxxx..."
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | File | 是 | 文件对象 |
| projectId | string | 是 | 项目ID |

**成功响应：**

```json
{
  "id": "clxxx...",
  "filename": "app.ts",
  "mimeType": "text/typescript",
  "size": 2048,
  "path": "projects/clxxx.../app.ts",
  "url": "http://minio:9000/cloud-dev/projects/clxxx.../app.ts",
  "projectId": "clxxx...",
  "uploadedById": "clxxx...",
  "createdAt": "2025-10-15T08:00:00.000Z"
}
```

---

### 5.2 获取文件内容

**接口描述：** 获取文件文本内容

**请求：**

```http
GET /api/files/:id/content
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "content": "import { Injectable } from '@nestjs/common'..."
}
```

---

### 5.3 下载文件

**接口描述：** 下载文件

**请求：**

```http
GET /api/files/:id/download
Authorization: Bearer <token>
```

**成功响应：** 文件二进制流

---

## 6. 仓库模块 API

### 6.1 创建仓库

**接口描述：** 为项目创建Git仓库

**请求：**

```http
POST /api/repositories
Authorization: Bearer <token>
Content-Type: application/json

{
  "projectId": "clxxx...",
  "defaultBranch": "main"
}
```

---

### 6.2 获取仓库信息

**接口描述：** 获取项目仓库信息

**请求：**

```http
GET /api/repositories?projectId=clxxx...
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "id": "clxxx...",
  "projectId": "clxxx...",
  "defaultBranch": "main",
  "branches": [
    {
      "id": "clxxx...",
      "name": "main",
      "commitId": "clxxx...",
      "createdAt": "2025-10-15T08:00:00.000Z"
    }
  ],
  "createdAt": "2025-10-15T08:00:00.000Z"
}
```

---

### 6.3 创建分支

**接口描述：** 创建新分支

**请求：**

```http
POST /api/repositories/branches
Authorization: Bearer <token>
Content-Type: application/json

{
  "repositoryId": "clxxx...",
  "name": "feature-xxx",
  "fromBranch": "main"
}
```

---

### 6.4 获取分支列表

**接口描述：** 获取仓库所有分支

**请求：**

```http
GET /api/repositories/branches?repositoryId=clxxx...
Authorization: Bearer <token>
```

---

### 6.5 上传文件到分支

**接口描述：** 上传文件到指定分支

**请求：**

```http
POST /api/repositories/branches/:branchId/files
Authorization: Bearer <token>
Content-Type: multipart/form-data

{
  file: [binary data]
  path: "src/app.ts"
  message: "Add app.ts"
}
```

---

### 6.6 获取分支文件列表

**接口描述：** 获取分支文件树

**请求：**

```http
GET /api/repositories/branches/:branchId/files?path=src
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "files": [
    {
      "id": "clxxx...",
      "filename": "app.ts",
      "path": "src/app.ts",
      "size": 2048,
      "mimeType": "text/typescript",
      "createdAt": "2025-10-15T08:00:00.000Z"
    }
  ],
  "path": "src"
}
```

---

### 6.7 下载分支文件

**接口描述：** 下载分支中的文件

**请求：**

```http
GET /api/repositories/branches/:branchId/files/download?path=src/app.ts
Authorization: Bearer <token>
```

---

### 6.8 创建提交

**接口描述：** 创建提交记录

**请求：**

```http
POST /api/repositories/commits
Authorization: Bearer <token>
Content-Type: application/json

{
  "repositoryId": "clxxx...",
  "branchId": "clxxx...",
  "message": "feat: add new feature",
  "fileIds": ["clxxx...", "clxxx..."]
}
```

---

### 6.9 获取提交历史

**接口描述：** 获取分支提交历史

**请求：**

```http
GET /api/repositories/branches/:branchId/commits?page=1&limit=20
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "data": [
    {
      "id": "clxxx...",
      "message": "feat: add new feature",
      "hash": "a1b2c3d4...",
      "author": {
        "username": "testuser"
      },
      "filesCount": 3,
      "createdAt": "2025-10-15T08:00:00.000Z"
    }
  ],
  "total": 50,
  "page": 1,
  "limit": 20
}
```

---

## 7. 管理员模块 API

### 7.1 获取系统统计

**接口描述：** 获取系统整体统计信息（仅管理员）

**请求：**

```http
GET /api/admin/stats
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "users": {
    "total": 100,
    "active": 85,
    "inactive": 15,
    "superAdmins": 2,
    "admins": 5,
    "regularUsers": 93
  },
  "projects": {
    "total": 50,
    "public": 30,
    "private": 20
  },
  "commits": {
    "total": 1500
  },
  "recent": {
    "users": [...],
    "projects": [...]
  }
}
```

---

### 7.2 获取所有用户

**接口描述：** 管理员查看所有用户（仅管理员）

**请求：**

```http
GET /api/admin/users?page=1&limit=20&role=USER
Authorization: Bearer <token>
```

---

### 7.3 更新用户角色

**接口描述：** 修改用户角色（仅超级管理员）

**请求：**

```http
PATCH /api/admin/users/:id/role
Authorization: Bearer <token>
Content-Type: application/json

{
  "role": "ADMIN"
}
```

---

## 8. Raft集群模块 API

### 8.1 获取集群状态

**接口描述：** 获取Raft集群当前状态

**请求：**

```http
GET /api/raft-cluster/status
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "success": true,
  "data": {
    "nodeId": "node-1",
    "status": "running",
    "isLeader": true,
    "currentTerm": 5,
    "clusterSize": 3,
    "nodesState": [
      {
        "nodeId": "node-1",
        "state": "LEADER",
        "currentTerm": 5,
        "logLength": 120,
        "lastApplied": 118
      },
      {
        "nodeId": "node-2",
        "state": "FOLLOWER",
        "currentTerm": 5,
        "logLength": 120,
        "lastApplied": 118
      },
      {
        "nodeId": "node-3",
        "state": "FOLLOWER",
        "currentTerm": 5,
        "logLength": 120,
        "lastApplied": 118
      }
    ]
  }
}
```

---

### 8.2 启动集群

**接口描述：** 启动Raft集群

**请求：**

```http
POST /api/raft-cluster/start
Authorization: Bearer <token>
```

---

### 8.3 停止集群

**接口描述：** 停止Raft集群

**请求：**

```http
POST /api/raft-cluster/stop
Authorization: Bearer <token>
```

---

### 8.4 重启集群

**接口描述：** 重启Raft集群

**请求：**

```http
POST /api/raft-cluster/restart
Authorization: Bearer <token>
```

---

### 8.5 获取集群性能指标

**接口描述：** 获取集群性能指标

**请求：**

```http
GET /api/raft-cluster/metrics
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "success": true,
  "data": {
    "totalCommands": 5420,
    "commandsPerSecond": 15.3,
    "averageResponseTime": 12.5,
    "leaderElections": 3,
    "uptime": 86400
  }
}
```

---

### 8.6 获取集群配置

**接口描述：** 获取集群配置信息

**请求：**

```http
GET /api/raft-cluster/config
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "success": true,
  "data": {
    "settings": {
      "nodeId": "node-1",
      "nodes": ["node-1", "node-2", "node-3"],
      "ports": {
        "node-1": 4001,
        "node-2": 4002,
        "node-3": 4003
      },
      "electionTimeoutMin": 150,
      "electionTimeoutMax": 300,
      "heartbeatInterval": 50,
      "rpcTimeout": 5000,
      "autoStart": true
    },
    "validation": {
      "valid": true,
      "errors": []
    }
  }
}
```

---

### 8.7 执行分布式命令

**接口描述：** 通过Raft提交分布式命令

**请求：**

```http
POST /api/raft-cluster/execute
Authorization: Bearer <token>
Content-Type: application/json

{
  "type": "CREATE_PROJECT",
  "payload": {
    "name": "distributed-project",
    "description": "通过Raft创建的项目"
  }
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| type | enum | 是 | 命令类型 | CREATE_PROJECT / GIT_COMMIT / GIT_BRANCH |
| payload | object | 是 | 命令参数 | 根据type不同 |

**成功响应：**

```json
{
  "success": true,
  "data": {
    "commandId": "cmd-xxx",
    "status": "COMMITTED",
    "term": 5,
    "index": 121,
    "result": {
      "id": "clxxx...",
      "name": "distributed-project"
    }
  }
}
```

---

## 9. 组织模块 API ✅

### 9.1 创建组织

**接口描述：** 创建新组织

**请求：**

```http
POST /api/organizations
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "My Organization",
  "slug": "my-org",
  "description": "组织描述",
  "website": "https://example.com",
  "location": "Shanghai, China"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 组织名称（2-100字符） |
| slug | string | 是 | URL标识（3-50字符，唯一） |
| description | string | 否 | 组织描述 |
| website | string | 否 | 组织网站 |
| location | string | 否 | 地理位置 |

**成功响应：**

```json
{
  "id": "clxxx...",
  "name": "My Organization",
  "slug": "my-org",
  "description": "组织描述",
  "website": "https://example.com",
  "location": "Shanghai, China",
  "isPersonal": false,
  "maxProjects": 1000,
  "maxMembers": 1000,
  "storageQuota": 107374182400,
  "createdAt": "2025-12-22T08:00:00.000Z"
}
```

---

### 9.2 获取我的组织列表

**接口描述：** 获取当前用户所属的所有组织

**请求：**

```http
GET /api/organizations
Authorization: Bearer <token>
```

**成功响应：**

```json
[
  {
    "id": "clxxx...",
    "name": "My Organization",
    "slug": "my-org",
    "role": "OWNER",
    "memberCount": 5,
    "projectCount": 10
  }
]
```

---

### 9.3 获取组织详情

**接口描述：** 根据slug获取组织详情

**请求：**

```http
GET /api/organizations/:slug
Authorization: Bearer <token>
```

**成功响应：** 同9.1响应格式

---

### 9.4 更新组织

**接口描述：** 更新组织信息（需要ADMIN权限）

**请求：**

```http
PATCH /api/organizations/:slug
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Updated Name",
  "description": "新描述"
}
```

---

### 9.5 删除组织

**接口描述：** 软删除组织（需要OWNER权限）

**请求：**

```http
DELETE /api/organizations/:slug
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "message": "Organization deleted successfully"
}
```

---

### 9.6 获取组织成员

**接口描述：** 获取组织成员列表

**请求：**

```http
GET /api/organizations/:slug/members
Authorization: Bearer <token>
```

**成功响应：**

```json
[
  {
    "userId": "clxxx...",
    "username": "member1",
    "email": "member1@example.com",
    "role": "ADMIN",
    "joinedAt": "2025-12-22T08:00:00.000Z"
  }
]
```

---

### 9.7 添加组织成员

**接口描述：** 邀请用户加入组织（需要ADMIN权限）

**请求：**

```http
POST /api/organizations/:slug/members
Authorization: Bearer <token>
Content-Type: application/json

{
  "userId": "clxxx...",
  "role": "MEMBER"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| userId | string | 是 | 用户ID | - |
| role | enum | 是 | 组织角色 | OWNER / ADMIN / MEMBER |

---

### 9.8 更新成员角色

**接口描述：** 修改组织成员角色

**请求：**

```http
PATCH /api/organizations/:slug/members/:userId
Authorization: Bearer <token>
Content-Type: application/json

{
  "role": "ADMIN"
}
```

---

### 9.9 移除组织成员

**接口描述：** 移除组织成员

**请求：**

```http
DELETE /api/organizations/:slug/members/:userId
Authorization: Bearer <token>
```

---

## 10. 团队模块 API ✅

### 10.1 创建团队

**接口描述：** 在组织内创建团队（需要组织ADMIN权限）

**请求：**

```http
POST /api/organizations/:organizationSlug/teams
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Backend Team",
  "slug": "backend",
  "description": "后端开发团队"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 团队名称（2-100字符） |
| slug | string | 是 | URL标识（2-50字符） |
| description | string | 否 | 团队描述 |

---

### 10.2 获取我的团队列表

**接口描述：** 获取当前用户在组织中所属的团队

**请求：**

```http
GET /api/organizations/:organizationSlug/teams
Authorization: Bearer <token>
```

**成功响应：**

```json
[
  {
    "id": "clxxx...",
    "name": "Backend Team",
    "slug": "backend",
    "description": "后端开发团队",
    "role": "MAINTAINER",
    "memberCount": 8
  }
]
```

---

### 10.3 获取团队详情

**接口描述：** 获取团队详细信息

**请求：**

```http
GET /api/organizations/:organizationSlug/teams/:teamSlug
Authorization: Bearer <token>
```

---

### 10.4 更新团队

**接口描述：** 更新团队信息（需要MAINTAINER权限）

**请求：**

```http
PATCH /api/organizations/:organizationSlug/teams/:teamSlug
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "Updated Team Name",
  "description": "更新后的描述"
}
```

---

### 10.5 删除团队

**接口描述：** 删除团队

**请求：**

```http
DELETE /api/organizations/:organizationSlug/teams/:teamSlug
Authorization: Bearer <token>
```

---

### 10.6 获取团队成员

**接口描述：** 获取团队成员列表

**请求：**

```http
GET /api/organizations/:organizationSlug/teams/:teamSlug/members
Authorization: Bearer <token>
```

---

### 10.7 添加团队成员

**接口描述：** 添加成员到团队

**请求：**

```http
POST /api/organizations/:organizationSlug/teams/:teamSlug/members
Authorization: Bearer <token>
Content-Type: application/json

{
  "userId": "clxxx...",
  "role": "MEMBER"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| userId | string | 是 | 用户ID | - |
| role | enum | 是 | 团队角色 | MAINTAINER / MEMBER |

---

### 10.8 更新团队成员角色

**接口描述：** 修改团队成员角色

**请求：**

```http
PATCH /api/organizations/:organizationSlug/teams/:teamSlug/members/:userId
Authorization: Bearer <token>
Content-Type: application/json

{
  "role": "MAINTAINER"
}
```

---

### 10.9 移除团队成员

**接口描述：** 移除团队成员

**请求：**

```http
DELETE /api/organizations/:organizationSlug/teams/:teamSlug/members/:userId
Authorization: Bearer <token>
```

---

### 10.10 获取团队项目权限

**接口描述：** 获取团队被授予的项目权限列表

**请求：**

```http
GET /api/organizations/:organizationSlug/teams/:teamSlug/permissions
Authorization: Bearer <token>
```

**成功响应：**

```json
[
  {
    "projectId": "clxxx...",
    "projectName": "my-project",
    "role": "MAINTAINER"
  }
]
```

---

### 10.11 分配项目权限

**接口描述：** 为团队分配项目权限

**请求：**

```http
POST /api/organizations/:organizationSlug/teams/:teamSlug/permissions
Authorization: Bearer <token>
Content-Type: application/json

{
  "projectId": "clxxx...",
  "role": "MEMBER"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| projectId | string | 是 | 项目ID | - |
| role | enum | 是 | 项目角色 | MAINTAINER / MEMBER / VIEWER |

---

### 10.12 更新项目权限

**接口描述：** 更新团队对项目的权限

**请求：**

```http
PATCH /api/organizations/:organizationSlug/teams/:teamSlug/permissions/:projectId
Authorization: Bearer <token>
Content-Type: application/json

{
  "role": "MAINTAINER"
}
```

---

### 10.13 撤销项目权限

**接口描述：** 撤销团队对项目的权限

**请求：**

```http
DELETE /api/organizations/:organizationSlug/teams/:teamSlug/permissions/:projectId
Authorization: Bearer <token>
```

---

## 11. Issue追踪模块 API ✅

### 11.1 创建Issue

**接口描述：** 创建新Issue（需要MEMBER权限）

**请求：**

```http
POST /api/projects/:projectId/issues
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "Bug: 登录页面无法提交",
  "body": "详细描述...",
  "labelIds": ["clxxx..."],
  "assigneeIds": ["clxxx..."],
  "milestoneId": "clxxx..."
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| title | string | 是 | Issue标题（最多500字符） |
| body | string | 否 | 内容（Markdown格式） |
| labelIds | string[] | 否 | 标签ID数组 |
| assigneeIds | string[] | 否 | 被分配人ID数组 |
| milestoneId | string | 否 | 里程碑ID |

**成功响应：**

```json
{
  "id": "clxxx...",
  "number": 1,
  "title": "Bug: 登录页面无法提交",
  "body": "详细描述...",
  "state": "OPEN",
  "author": {
    "id": "clxxx...",
    "username": "reporter"
  },
  "labels": [...],
  "assignees": [...],
  "milestone": {...},
  "createdAt": "2025-12-22T08:00:00.000Z"
}
```

---

### 11.2 获取Issue列表

**接口描述：** 获取项目Issue列表（需要VIEWER权限）

**请求：**

```http
GET /api/projects/:projectId/issues?state=OPEN&page=1&limit=20
Authorization: Bearer <token>
```

**查询参数：**
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| state | enum | 否 | all | OPEN / CLOSED / all |
| page | number | 否 | 1 | 页码 |
| limit | number | 否 | 20 | 每页数量 |

---

### 11.3 获取Issue详情

**接口描述：** 根据编号获取Issue详情

**请求：**

```http
GET /api/projects/:projectId/issues/:number
Authorization: Bearer <token>
```

---

### 11.4 更新Issue

**接口描述：** 更新Issue信息（需要MEMBER权限）

**请求：**

```http
PATCH /api/projects/:projectId/issues/:number
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "更新后的标题",
  "body": "更新后的内容"
}
```

---

### 11.5 关闭Issue

**接口描述：** 关闭Issue（需要MEMBER权限）

**请求：**

```http
POST /api/projects/:projectId/issues/:number/close
Authorization: Bearer <token>
```

---

### 11.6 重新打开Issue

**接口描述：** 重新打开已关闭的Issue（需要MEMBER权限）

**请求：**

```http
POST /api/projects/:projectId/issues/:number/reopen
Authorization: Bearer <token>
```

---

### 11.7 删除Issue

**接口描述：** 删除Issue（需要MAINTAINER权限）

**请求：**

```http
DELETE /api/projects/:projectId/issues/:number
Authorization: Bearer <token>
```

---

### 11.8 Issue评论API

**添加评论：**

```http
POST /api/projects/:projectId/issues/:number/comments
Content-Type: application/json

{
  "body": "评论内容（支持Markdown）"
}
```

**获取评论列表：**

```http
GET /api/projects/:projectId/issues/:number/comments
```

**更新评论：**

```http
PATCH /api/issues/comments/:commentId
```

**删除评论：**

```http
DELETE /api/issues/comments/:commentId
```

---

### 11.9 标签管理API

**创建标签：**

```http
POST /api/projects/:projectId/labels
Content-Type: application/json

{
  "name": "bug",
  "color": "#FF0000",
  "description": "Bug类Issue"
}
```

**获取标签列表：**

```http
GET /api/projects/:projectId/labels
```

**更新标签：**

```http
PATCH /api/labels/:labelId
```

**删除标签：**

```http
DELETE /api/labels/:labelId
```

---

### 11.10 里程碑管理API

**创建里程碑：**

```http
POST /api/projects/:projectId/milestones
Content-Type: application/json

{
  "title": "v1.0.0",
  "description": "第一个正式版本",
  "dueDate": "2025-12-31T23:59:59.000Z"
}
```

**获取里程碑列表：**

```http
GET /api/projects/:projectId/milestones
```

**更新里程碑：**

```http
PATCH /api/milestones/:milestoneId
```

**关闭里程碑：**

```http
POST /api/milestones/:milestoneId/close
```

**删除里程碑：**

```http
DELETE /api/milestones/:milestoneId
```

---

## 12. Pull Request模块 API ✅

### 12.1 创建Pull Request

**接口描述：** 创建新的Pull Request

**请求：**

```http
POST /api/pull-requests
Authorization: Bearer <token>
Content-Type: application/json

{
  "projectId": "clxxx...",
  "title": "feat: 添加用户认证功能",
  "body": "## 变更说明\n- 添加登录功能\n- 添加注册功能",
  "sourceBranch": "feature/auth",
  "targetBranch": "main"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| projectId | string | 是 | 项目ID |
| title | string | 是 | PR标题 |
| body | string | 否 | PR描述（Markdown） |
| sourceBranch | string | 是 | 源分支 |
| targetBranch | string | 是 | 目标分支 |

**成功响应：**

```json
{
  "id": "clxxx...",
  "number": 1,
  "title": "feat: 添加用户认证功能",
  "body": "...",
  "state": "OPEN",
  "sourceBranch": "feature/auth",
  "targetBranch": "main",
  "author": {...},
  "createdAt": "2025-12-22T08:00:00.000Z"
}
```

---

### 12.2 获取PR列表

**接口描述：** 获取Pull Request列表

**请求：**

```http
GET /api/pull-requests?projectId=clxxx...&state=OPEN&page=1&limit=20
Authorization: Bearer <token>
```

**查询参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| projectId | string | 是 | 项目ID |
| state | enum | 否 | OPEN / MERGED / CLOSED / all |
| page | number | 否 | 页码 |
| limit | number | 否 | 每页数量 |

---

### 12.3 获取PR详情

**接口描述：** 根据ID获取PR详情

**请求：**

```http
GET /api/pull-requests/:id
Authorization: Bearer <token>
```

---

### 12.4 根据编号获取PR

**接口描述：** 根据项目ID和编号获取PR

**请求：**

```http
GET /api/pull-requests/project/:projectId/number/:number
Authorization: Bearer <token>
```

---

### 12.5 更新PR

**接口描述：** 更新PR信息（仅作者）

**请求：**

```http
PATCH /api/pull-requests/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "更新后的标题",
  "body": "更新后的描述"
}
```

---

### 12.6 关闭PR

**接口描述：** 关闭Pull Request（不合并）

**请求：**

```http
POST /api/pull-requests/:id/close
Authorization: Bearer <token>
```

---

### 12.7 合并PR

**接口描述：** 合并Pull Request

**请求：**

```http
POST /api/pull-requests/:id/merge
Authorization: Bearer <token>
Content-Type: application/json

{
  "mergeStrategy": "SQUASH",
  "deleteBranch": true
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| mergeStrategy | enum | 否 | 合并策略 | MERGE / SQUASH / REBASE |
| deleteBranch | boolean | 否 | 合并后删除源分支 | true / false |

**成功响应：**

```json
{
  "success": true,
  "mergeCommit": "abc123...",
  "message": "Pull request merged successfully"
}
```

---

### 12.8 添加Review

**接口描述：** 提交代码审查意见

**请求：**

```http
POST /api/pull-requests/:id/reviews
Authorization: Bearer <token>
Content-Type: application/json

{
  "body": "代码整体不错，有几个小建议...",
  "state": "APPROVED"
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 说明 | 可选值 |
|------|------|------|------|--------|
| body | string | 否 | 审查意见 | - |
| state | enum | 是 | 审查状态 | APPROVED / CHANGES_REQUESTED / COMMENTED |

---

### 12.9 获取Reviews

**接口描述：** 获取PR的所有审查记录

**请求：**

```http
GET /api/pull-requests/:id/reviews
Authorization: Bearer <token>
```

---

### 12.10 添加PR评论

**接口描述：** 添加行级代码评论

**请求：**

```http
POST /api/pull-requests/:id/comments
Authorization: Bearer <token>
Content-Type: application/json

{
  "body": "这里可以优化一下",
  "path": "src/auth/auth.service.ts",
  "line": 42
}
```

---

### 12.11 获取PR评论

**接口描述：** 获取PR的所有评论

**请求：**

```http
GET /api/pull-requests/:id/comments
Authorization: Bearer <token>
```

---

### 12.12 获取PR Diff

**接口描述：** 获取PR的代码差异及行内评论

**请求：**

```http
GET /api/pull-requests/:id/diff
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "files": [
    {
      "path": "src/auth/auth.service.ts",
      "additions": 45,
      "deletions": 12,
      "diff": "@@ -1,5 +1,10 @@...",
      "comments": [...]
    }
  ],
  "stats": {
    "additions": 120,
    "deletions": 30,
    "filesChanged": 5
  }
}
```

---

### 12.13 获取Review Summary

**接口描述：** 获取PR的审查统计摘要

**请求：**

```http
GET /api/pull-requests/:id/review-summary
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "totalReviews": 3,
  "approved": 2,
  "changesRequested": 0,
  "commented": 1,
  "requiredReviews": 2,
  "isApproved": true
}
```

---

### 12.14 检查合并状态

**接口描述：** 检查PR是否可以合并

**请求：**

```http
GET /api/pull-requests/:id/merge-status
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "canMerge": true,
  "reason": null,
  "conflicts": false,
  "requiredReviews": 2,
  "currentApprovals": 2,
  "branchProtectionPassed": true
}
```

---

## 13. 代码搜索模块 API ✅

### 13.1 全局代码搜索

**接口描述：** 全局代码搜索（公开，无需认证）

**请求：**

```http
GET /api/search?q=UserService&projectId=clxxx...&language=typescript&page=1&limit=20
```

**查询参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| q | string | 是 | 搜索关键词 |
| projectId | string | 否 | 限定项目范围 |
| language | string | 否 | 编程语言过滤 |
| page | number | 否 | 页码 |
| limit | number | 否 | 每页数量 |

**成功响应：**

```json
{
  "results": [
    {
      "fileId": "clxxx...",
      "path": "src/users/users.service.ts",
      "projectId": "clxxx...",
      "projectName": "flotilla-backend",
      "language": "typescript",
      "matchedLines": [
        {
          "lineNumber": 15,
          "content": "export class UserService {",
          "highlights": [[13, 24]]
        }
      ]
    }
  ],
  "total": 42,
  "page": 1,
  "limit": 20
}
```

---

### 13.2 项目内搜索

**接口描述：** 在指定项目内搜索代码

**请求：**

```http
GET /api/search/projects/:projectId?q=createUser
Authorization: Bearer <token>
```

---

### 13.3 触发项目重索引

**接口描述：** 手动触发项目代码重索引

**请求：**

```http
POST /api/search/reindex/:projectId
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "message": "Reindex task started",
  "taskId": "task-xxx",
  "estimatedTime": 30
}
```

---

### 13.4 获取索引状态

**接口描述：** 获取项目索引统计

**请求：**

```http
GET /api/search/status/:projectId
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "projectId": "clxxx...",
  "indexed": 150,
  "pending": 5,
  "failed": 2,
  "lastIndexedAt": "2025-12-22T08:00:00.000Z"
}
```

---

### 13.5 删除项目索引 ⚠️

**接口描述：** 删除项目的搜索索引（未完全实现）

**请求：**

```http
DELETE /api/search/indexes/:projectId
Authorization: Bearer <token>
```

> ⚠️ 此接口当前返回 "Not implemented yet - Task 1.7"

---

## 14. 通知模块 API ✅

### 14.1 获取通知列表

**接口描述：** 获取当前用户的通知列表

**请求：**

```http
GET /api/notifications?read=false&page=1&limit=20
Authorization: Bearer <token>
```

**查询参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| read | boolean | 否 | 过滤已读/未读 |
| page | number | 否 | 页码 |
| limit | number | 否 | 每页数量 |

**成功响应：**

```json
{
  "data": [
    {
      "id": "clxxx...",
      "type": "PR_CREATED",
      "title": "新的Pull Request",
      "body": "user1 创建了 PR #15",
      "read": false,
      "link": "/projects/xxx/pull-requests/15",
      "metadata": {...},
      "createdAt": "2025-12-22T08:00:00.000Z"
    }
  ],
  "total": 50,
  "unreadCount": 12
}
```

---

### 14.2 获取通知详情

**接口描述：** 获取单条通知详情

**请求：**

```http
GET /api/notifications/:id
Authorization: Bearer <token>
```

---

### 14.3 标记为已读

**接口描述：** 标记单条通知为已读

**请求：**

```http
PATCH /api/notifications/:id/read
Authorization: Bearer <token>
```

---

### 14.4 标记全部已读

**接口描述：** 标记所有通知为已读

**请求：**

```http
POST /api/notifications/read-all
Authorization: Bearer <token>
```

---

### 14.5 删除通知

**接口描述：** 删除单条通知

**请求：**

```http
DELETE /api/notifications/:id
Authorization: Bearer <token>
```

---

### 14.6 获取通知偏好

**接口描述：** 获取当前用户的通知偏好设置

**请求：**

```http
GET /api/notifications/preferences/me
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "emailEnabled": true,
  "webEnabled": true,
  "prCreated": true,
  "prMerged": true,
  "prReviewed": true,
  "issueMentioned": true,
  "issueAssigned": true
}
```

---

### 14.7 更新通知偏好

**接口描述：** 更新通知偏好设置

**请求：**

```http
PATCH /api/notifications/preferences/me
Authorization: Bearer <token>
Content-Type: application/json

{
  "emailEnabled": false,
  "prCreated": true
}
```

---

### 14.8 通知类型枚举

| 类型            | 说明               |
| --------------- | ------------------ |
| PR_CREATED      | Pull Request创建   |
| PR_MERGED       | Pull Request合并   |
| PR_CLOSED       | Pull Request关闭   |
| PR_REVIEWED     | Pull Request被审查 |
| PR_COMMENT      | Pull Request被评论 |
| ISSUE_CREATED   | Issue创建          |
| ISSUE_CLOSED    | Issue关闭          |
| ISSUE_MENTIONED | Issue被@提及       |
| ISSUE_ASSIGNED  | Issue被分配        |
| ISSUE_COMMENT   | Issue被评论        |
| SYSTEM          | 系统通知           |

---

## 15. 分支保护模块 API ✅

### 15.1 创建分支保护规则

**接口描述：** 为项目创建分支保护规则

**请求：**

```http
POST /api/projects/:projectId/branch-protection
Authorization: Bearer <token>
Content-Type: application/json

{
  "branchPattern": "main",
  "requirePullRequest": true,
  "requiredApprovingReviews": 2,
  "dismissStaleReviews": true,
  "allowForcePushes": false,
  "allowDeletions": false
}
```

**请求参数：**
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| branchPattern | string | 是 | - | 分支名称模式 |
| requirePullRequest | boolean | 否 | true | 必须通过PR |
| requiredApprovingReviews | number | 否 | 1 | 最少审批数 |
| dismissStaleReviews | boolean | 否 | false | 新提交作废旧审查 |
| allowForcePushes | boolean | 否 | false | 允许强制推送 |
| allowDeletions | boolean | 否 | false | 允许删除分支 |

---

### 15.2 获取项目的保护规则

**接口描述：** 获取项目的所有分支保护规则（公开接口，用于pre-receive hook）

**请求：**

```http
GET /api/projects/:projectId/branch-protection
```

**成功响应：**

```json
[
  {
    "id": "clxxx...",
    "branchPattern": "main",
    "requirePullRequest": true,
    "requiredApprovingReviews": 2,
    "dismissStaleReviews": true,
    "allowForcePushes": false,
    "allowDeletions": false,
    "createdAt": "2025-12-22T08:00:00.000Z"
  }
]
```

---

### 15.3 获取规则详情

**接口描述：** 根据ID获取保护规则

**请求：**

```http
GET /api/branch-protection/:id
Authorization: Bearer <token>
```

---

### 15.4 更新保护规则

**接口描述：** 更新分支保护规则

**请求：**

```http
PATCH /api/branch-protection/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "requiredApprovingReviews": 3
}
```

---

### 15.5 删除保护规则

**接口描述：** 删除分支保护规则

**请求：**

```http
DELETE /api/branch-protection/:id
Authorization: Bearer <token>
```

---

## 16. 审计日志模块 API ✅

### 16.1 获取我的审计日志

**接口描述：** 获取当前用户的操作日志

**请求：**

```http
GET /api/audit/my-logs?page=1&limit=20&action=CREATE
Authorization: Bearer <token>
```

**查询参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| action | enum | 否 | 操作类型过滤 |
| entityType | enum | 否 | 实体类型过滤 |
| startDate | string | 否 | 开始日期 |
| endDate | string | 否 | 结束日期 |
| page | number | 否 | 页码 |
| limit | number | 否 | 每页数量 |

**成功响应：**

```json
{
  "data": [
    {
      "id": "clxxx...",
      "action": "CREATE",
      "entityType": "PROJECT",
      "entityId": "clxxx...",
      "description": "Created project 'my-project'",
      "ipAddress": "192.168.1.1",
      "userAgent": "Mozilla/5.0...",
      "success": true,
      "createdAt": "2025-12-22T08:00:00.000Z"
    }
  ],
  "total": 100
}
```

---

### 16.2 获取用户审计日志（管理员）

**接口描述：** 查询指定用户的审计日志（需要SUPER_ADMIN权限）

**请求：**

```http
GET /api/audit/user-logs?userId=clxxx...&page=1&limit=20
Authorization: Bearer <token>
```

---

### 16.3 获取实体审计日志（管理员）

**接口描述：** 查询指定实体的审计日志（需要SUPER_ADMIN权限）

**请求：**

```http
GET /api/audit/entity-logs?entityType=PROJECT&entityId=clxxx...
Authorization: Bearer <token>
```

---

### 16.4 获取失败操作日志（管理员）

**接口描述：** 查询所有失败的操作日志（需要SUPER_ADMIN权限）

**请求：**

```http
GET /api/audit/failed-logs?page=1&limit=20
Authorization: Bearer <token>
```

---

### 16.5 获取用户活动统计（管理员）

**接口描述：** 获取用户活动统计信息（需要SUPER_ADMIN权限）

**请求：**

```http
GET /api/audit/user-stats?userId=clxxx...&days=30
Authorization: Bearer <token>
```

**成功响应：**

```json
{
  "userId": "clxxx...",
  "username": "testuser",
  "period": 30,
  "stats": {
    "totalActions": 150,
    "byAction": {
      "CREATE": 45,
      "UPDATE": 80,
      "DELETE": 10,
      "LOGIN": 15
    },
    "byEntityType": {
      "PROJECT": 30,
      "ISSUE": 50,
      "PR": 40
    },
    "failedActions": 3
  }
}
```

---

### 16.6 导出审计日志（管理员）

**接口描述：** 导出审计日志为CSV格式（需要SUPER_ADMIN权限）

**请求：**

```http
GET /api/audit/export?startDate=2025-12-01&endDate=2025-12-22
Authorization: Bearer <token>
```

**成功响应：** CSV文件下载

---

### 16.7 审计操作类型枚举

| Action            | 说明     |
| ----------------- | -------- |
| CREATE            | 创建操作 |
| UPDATE            | 更新操作 |
| DELETE            | 删除操作 |
| LOGIN             | 登录     |
| LOGOUT            | 登出     |
| LOGIN_FAILED      | 登录失败 |
| PASSWORD_CHANGE   | 密码修改 |
| PASSWORD_RESET    | 密码重置 |
| EMAIL_VERIFIED    | 邮箱验证 |
| PERMISSION_CHANGE | 权限变更 |

### 16.8 审计实体类型枚举

| EntityType   | 说明         |
| ------------ | ------------ |
| USER         | 用户         |
| PROJECT      | 项目         |
| REPOSITORY   | 仓库         |
| ISSUE        | Issue        |
| PR           | Pull Request |
| ORGANIZATION | 组织         |
| TEAM         | 团队         |
| BRANCH       | 分支         |
| FILE         | 文件         |

---

## 17. 错误代码说明

### 17.1 通用错误

| 错误代码        | HTTP状态码 | 说明              |
| --------------- | ---------- | ----------------- |
| INVALID_REQUEST | 400        | 请求参数无效      |
| UNAUTHORIZED    | 401        | 未认证或token无效 |
| FORBIDDEN       | 403        | 权限不足          |
| NOT_FOUND       | 404        | 资源不存在        |
| CONFLICT        | 409        | 资源冲突          |
| INTERNAL_ERROR  | 500        | 服务器内部错误    |

### 17.2 业务错误

| 错误代码                 | 说明           |
| ------------------------ | -------------- |
| USERNAME_EXISTS          | 用户名已存在   |
| EMAIL_EXISTS             | 邮箱已存在     |
| INVALID_CREDENTIALS      | 凭据无效       |
| PROJECT_NAME_EXISTS      | 项目名已存在   |
| INSUFFICIENT_PERMISSIONS | 权限不足       |
| FILE_TOO_LARGE           | 文件过大       |
| BRANCH_NOT_FOUND         | 分支不存在     |
| RAFT_CLUSTER_NOT_RUNNING | Raft集群未运行 |

---

## 18. 接口调用示例

### 18.1 完整用户流程示例

#### Step 1: 注册

```bash
curl -X POST http://localhost:4000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "Test123456"
  }'
```

#### Step 2: 登录获取Token

```bash
curl -X POST http://localhost:4000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "Test123456"
  }'
```

#### Step 3: 创建项目

```bash
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

curl -X POST http://localhost:4000/api/projects \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "my-first-project",
    "description": "我的第一个项目",
    "visibility": "PUBLIC"
  }'
```

#### Step 4: 上传文件

```bash
curl -X POST http://localhost:4000/api/files/upload \
  -H "Authorization: Bearer $TOKEN" \
  -F "file=@./app.ts" \
  -F "projectId=clxxx..."
```

### 18.2 TypeScript SDK示例

```typescript
// api.ts
import axios from 'axios'

const API_URL = 'http://localhost:4000/api'

class ApiClient {
  private token: string | null = null

  setToken(token: string) {
    this.token = token
  }

  async register(data: { username: string; email: string; password: string }) {
    const response = await axios.post(`${API_URL}/auth/register`, data)
    this.token = response.data.token
    return response.data
  }

  async login(username: string, password: string) {
    const response = await axios.post(`${API_URL}/auth/login`, { username, password })
    this.token = response.data.token
    return response.data
  }

  async getProjects(params?: { page?: number; limit?: number }) {
    const response = await axios.get(`${API_URL}/projects`, {
      headers: { Authorization: `Bearer ${this.token}` },
      params,
    })
    return response.data
  }

  async createProject(data: {
    name: string
    description?: string
    visibility: 'PUBLIC' | 'PRIVATE'
  }) {
    const response = await axios.post(`${API_URL}/projects`, data, {
      headers: { Authorization: `Bearer ${this.token}` },
    })
    return response.data
  }

  async uploadFile(file: File, projectId: string) {
    const formData = new FormData()
    formData.append('file', file)
    formData.append('projectId', projectId)

    const response = await axios.post(`${API_URL}/files/upload`, formData, {
      headers: {
        Authorization: `Bearer ${this.token}`,
        'Content-Type': 'multipart/form-data',
      },
    })
    return response.data
  }
}

export const api = new ApiClient()
```

---

## 19. 性能指标

### 19.1 响应时间目标

| 接口类型 | 目标响应时间 | P95    | P99    |
| -------- | ------------ | ------ | ------ |
| 认证接口 | <150ms       | <200ms | <300ms |
| 查询接口 | <100ms       | <150ms | <200ms |
| 创建接口 | <200ms       | <300ms | <400ms |
| 文件上传 | <10s (10MB)  | <15s   | <20s   |
| Raft命令 | <50ms        | <100ms | <150ms |

### 19.2 并发能力

- 支持100+并发用户
- 支持1000+ QPS
- Raft集群支持80+ commands/sec

---

## 20. 版本历史

| 版本 | 日期       | 变更内容                                                                                                                                                                                                                                                                                              |
| ---- | ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| v1.0 | 2025-10-15 | 初始版本，完整API定义                                                                                                                                                                                                                                                                                 |
| v2.0 | 2025-12-22 | 根据实现状态全面更新：<br>- 新增Organizations/Teams API（组织与团队权限）<br>- 新增Issues/Pull Requests API（代码协作）<br>- 新增Search/Notifications API（搜索与通知）<br>- 新增Branch Protection/Audit API（安全与审计）<br>- 更新项目成员角色（添加MAINTAINER）<br>- 总计新增8个API模块，70+个端点 |

---

## 21. 附录

### 21.1 Swagger文档

在线API文档：`http://localhost:4000/api/docs`

### 21.2 Postman集合

导出的Postman集合可用于快速测试所有接口。

### 21.3 联系方式

技术支持：jia@example.com

---

**文档结束**
