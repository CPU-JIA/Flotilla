flowchart TD
    A[事件触发] --> B{事件类型}

    B -->|Issue相关| C[Issue事件处理]
    B -->|PR相关| D[PR事件处理]
    B -->|提交相关| E[Commit事件处理]
    B -->|系统相关| F[系统事件处理]

    C --> C1{具体操作}
    C1 -->|创建| C2[通知项目成员]
    C1 -->|评论| C3[通知Issue作者和参与者]
    C1 -->|分配| C4[通知被分配人]
    C1 -->|提及| C5[通知被提及用户]

    D --> D1{具体操作}
    D1 -->|创建| D2[通知项目维护者]
    D1 -->|审查| D3[通知PR作者]
    D1 -->|合并| D4[通知PR参与者]
    D1 -->|评论| D5[通知PR作者和审查者]

    C2 --> G[收集接收者]
    C3 --> G
    C4 --> G
    C5 --> G
    D2 --> G
    D3 --> G
    D4 --> G
    D5 --> G

    G --> H[查询通知偏好]
    H --> I{偏好设置}

    I -->|启用站内通知| J[创建Notification记录]
    I -->|启用邮件通知| K[加入邮件队列]
    I -->|启用WebSocket| L[实时推送]
    I -->|禁用| M[跳过]

    J --> N[存储到PostgreSQL]
    K --> O[发送邮件]
    L --> P[WebSocket广播]

    N --> Q[记录发送状态]
    O --> Q
    P --> Q
    Q --> R[结束]
