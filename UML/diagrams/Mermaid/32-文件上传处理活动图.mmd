flowchart TD
    A[开始上传] --> B{文件验证}

    B -->|大小超限| C[返回错误 文件过大]
    B -->|类型不允许| D[返回错误 不支持的文件类型]
    B -->|验证通过| E[计算文件Hash]

    E --> F{检查重复}
    F -->|已存在相同文件| G[返回已有文件引用]
    F -->|新文件| H{文件大小判断}

    H -->|小于5MB| I[单次上传]
    H -->|大于5MB| J[分片上传]

    I --> K[上传到MinIO]

    J --> J1[分割文件为chunks]
    J1 --> J2[并行上传chunks]
    J2 --> J3{所有chunks上传成功}
    J3 -->|否| J4[重试失败的chunks]
    J4 --> J3
    J3 -->|是| J5[合并chunks]
    J5 --> K

    K --> L{上传成功}
    L -->|否| M[返回错误 上传失败]
    L -->|是| N[创建File记录]

    N --> O[更新Repository存储统计]
    O --> P[触发搜索索引]
    P --> Q[发送Webhook事件]
    Q --> R[返回文件信息]

    C --> Z[结束]
    D --> Z
    G --> Z
    M --> Z
    R --> Z
