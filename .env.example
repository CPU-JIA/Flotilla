# ========================================
# Flotilla Environment Variables Template
# ========================================
# ⚠️ IMPORTANT: This is a template file. Copy to .env and fill in real values.
# ⚠️ NEVER commit .env files with real credentials to Git!
#
# Usage:
#   1. Copy this file: cp .env.example .env
#   2. Fill in all values with your actual credentials
#   3. Generate strong secrets using: openssl rand -base64 32
# ========================================

# ========================================
# Database Configuration
# ========================================
# PostgreSQL connection string with connection pool parameters
# Format: postgresql://USERNAME:PASSWORD@HOST:PORT/DATABASE_NAME?param1=value1&param2=value2
#
# Recommended connection pool settings for production:
#   connection_limit=20-50  (number of concurrent connections)
#   pool_timeout=10         (seconds to wait for connection)
#   statement_cache_size=100 (prepared statement cache size)
#
DATABASE_URL="postgresql://USERNAME:PASSWORD@HOST:PORT/DATABASE_NAME?connection_limit=25&pool_timeout=10&statement_cache_size=100"
# Example: postgresql://flotilla:STRONG_PASSWORD_HERE@localhost:5434/flotilla_prod?connection_limit=25&pool_timeout=10
#
# Development (no connection pool params needed):
# DATABASE_URL="postgresql://flotilla:PASSWORD@localhost:5434/flotilla_dev"

# Optional: Database replica for read scaling
DATABASE_REPLICA_URL="postgresql://USERNAME:PASSWORD@HOST:PORT/DATABASE_NAME"

# ========================================
# Redis Configuration
# ========================================
REDIS_URL="redis://:REDIS_PASSWORD@HOST:PORT"
# Example: redis://:STRONG_REDIS_PASSWORD@localhost:6380

# ========================================
# MinIO (S3-Compatible Object Storage)
# ========================================
MINIO_ENDPOINT="localhost"
MINIO_PORT="9000"
MINIO_ACCESS_KEY="YOUR_MINIO_ACCESS_KEY"
MINIO_SECRET_KEY="YOUR_MINIO_SECRET_KEY"
MINIO_USE_SSL="false"  # Set to "true" in production with HTTPS
MINIO_BUCKET_NAME="flotilla-storage"

# ========================================
# MeiliSearch (Full-Text Search Engine)
# ========================================
MEILI_HOST="http://localhost:7700"
# ⚠️ Generate strong key (min 16 chars): openssl rand -base64 24
MEILI_MASTER_KEY="YOUR_MEILISEARCH_MASTER_KEY_MIN_16_CHARS"
MEILI_INDEX_PREFIX="flotilla_"

# ========================================
# JWT (JSON Web Token) Configuration
# ========================================
# ⚠️ CRITICAL SECURITY: Generate strong secrets using: openssl rand -base64 43
# ⚠️ SECURITY REQUIREMENT (CWE-326): HS256 requires 256-bit keys (43+ characters in Base64)
# ⚠️ NEVER use default or weak secrets in production
#
# Generate strong secrets:
#   openssl rand -base64 43   # For JWT_SECRET (HS256 requires 256 bits)
#   openssl rand -base64 43   # For JWT_REFRESH_SECRET
#
# Security Requirements:
#   - Minimum length: 43 characters (Base64-encoded 256-bit key)
#   - Minimum entropy: 4.0 bits/character (recommended: ≥ 4.5)
#   - MUST be different for JWT_SECRET and JWT_REFRESH_SECRET
#   - Use cryptographically secure random generation
#
JWT_SECRET="YOUR_JWT_SECRET_256_BITS_MIN_43_CHARS_BASE64"
JWT_REFRESH_SECRET="YOUR_JWT_REFRESH_SECRET_256_BITS_MIN_43_CHARS_BASE64"
JWT_EXPIRATION="7d"
JWT_REFRESH_EXPIRATION="30d"

# ========================================# Two-Factor Authentication (2FA/TOTP)# ========================================# ⚠️ CRITICAL SECURITY: Encryption key for storing TOTP secrets and recovery codes# ⚠️ Generate strong key using: openssl rand -base64 32# ⚠️ Minimum length: 32 characters# ⚠️ NEVER change this key after 2FA is enabled - users will lose access!## Generate encryption key:#   openssl rand -base64 32  # For TWO_FACTOR_ENCRYPTION_KEY (AES-256-GCM)#TWO_FACTOR_ENCRYPTION_KEY="YOUR_2FA_ENCRYPTION_KEY_MIN_32_CHARS_BASE64"
# ========================================
# Application Configuration
# ========================================
NODE_ENV="development"  # Options: development | production | test
PORT="4000"

# Frontend & Website URLs (comma-separated for multiple origins)
FRONTEND_URL="http://localhost:3000"
WEBSITE_URL="http://localhost:3003"
# For production multi-domain support, use CORS_ALLOWED_ORIGINS:
# CORS_ALLOWED_ORIGINS="https://app.flotilla.com,https://www.flotilla.com,https://flotilla.com"

# ========================================
# Git Repository Storage
# ========================================
# Path where Git repositories are stored
# Development: Leave empty to use default {cwd}/repos
# Production: MUST set to persistent directory like /var/lib/flotilla/repos
# ⚠️ CRITICAL: Never use temporary directories - data will be lost!
GIT_STORAGE_PATH=""

# ========================================
# File Upload Security Configuration
# ========================================
# 文件上传安全配置（CWE-434防护）
#
# 安全特性：
#   - MIME类型魔数验证（防止文件伪装攻击）
#   - 文件类型白名单（图片、文档、代码、归档）
#   - 可执行文件黑名单（exe, dll, bat, sh等）
#   - 文件名路径遍历防护（../, C:\等）
#   - 文件大小限制
#
# 配置说明：
#   MAX_FILE_SIZE: 单文件最大大小（字节）
#   MAX_PROJECT_SIZE: 单项目总存储限制（字节）
#   MAX_FILENAME_LENGTH: 文件名最大长度（字符）
#   STRICT_MIME_CHECK: 是否启用严格MIME验证（true/false）
#   ALLOW_ARCHIVES: 是否允许上传压缩文件（zip, tar等）
#
MAX_FILE_SIZE="104857600"  # 100MB (100 * 1024 * 1024)
MAX_PROJECT_SIZE="1073741824"  # 1GB (1024 * 1024 * 1024)
MAX_FILENAME_LENGTH="255"
STRICT_MIME_CHECK="true"
ALLOW_ARCHIVES="true"  # ⚠️ 归档文件可能包含恶意内容，建议病毒扫描

# ========================================
# Raft Consensus Configuration
# ========================================
# Raft分布式共识算法配置
# 用于在分布式环境中保证Git操作的一致性
#
# 推荐配置（基于Raft论文）：
#   - 选举超时：150-450ms（增加随机范围防止活锁）
#   - 心跳间隔：100ms（应小于选举超时最小值）
#   - 心跳/选举超时比率：建议1/2到1/5之间
#
# ⚠️ 重要配置原则：
#   1. RAFT_HEARTBEAT_INTERVAL 必须小于 RAFT_ELECTION_TIMEOUT_MIN
#   2. 选举超时范围应足够大（建议>=300ms）防止选举活锁
#   3. 心跳间隔太小会增加网络负载，太大会延迟故障检测
#   4. 生产环境建议根据网络延迟调整这些值
#
RAFT_NODE_ID="node1"
RAFT_NODES="node1,node2,node3"  # 集群节点列表（逗号分隔）
RAFT_BASE_PORT="8000"  # Raft RPC基础端口（每个节点递增）

# 选举超时（毫秒）
# 如果在此时间内未收到Leader心跳，节点将发起选举
# 修复：增加最大值从300ms到450ms，提供更大随机范围
RAFT_ELECTION_TIMEOUT_MIN="150"  # 最小值：150ms
RAFT_ELECTION_TIMEOUT_MAX="450"  # 最大值：450ms（修复：原300ms）

# 心跳间隔（毫秒）
# Leader向Followers发送心跳的间隔
# 修复：从50ms改为100ms，减少网络负载，更符合Raft论文建议
RAFT_HEARTBEAT_INTERVAL="100"  # 修复：原50ms

# RPC超时（毫秒）
RAFT_RPC_TIMEOUT="100"

# 数据持久化目录
RAFT_DATA_DIR="./data/raft"

# 是否自动启动Raft集群
RAFT_AUTO_START="false"

# ========================================
# Bootstrap Admin Configuration
# ========================================
# If set, user registering with this email will automatically become SUPER_ADMIN
# If not set in PRODUCTION, registration will fail (security feature)
# 如果设置，使用此邮箱注册的用户将自动成为超级管理员
# ⚠️ PRODUCTION: Must be set, otherwise admin creation will fail
INITIAL_ADMIN_EMAIL="admin@your-domain.com"

# ========================================
# OAuth/SSO Configuration
# ========================================
# GitHub OAuth Configuration
# Create OAuth App: https://github.com/settings/developers
# 1. Click "New OAuth App"
# 2. Homepage URL: http://localhost:3000 (or your domain)
# 3. Authorization callback URL: http://localhost:4000/auth/oauth/github/callback
GITHUB_CLIENT_ID="YOUR_GITHUB_CLIENT_ID"
GITHUB_CLIENT_SECRET="YOUR_GITHUB_CLIENT_SECRET"
GITHUB_CALLBACK_URL="http://localhost:4000/auth/oauth/github/callback"

# Google OAuth Configuration
# Create OAuth credentials: https://console.cloud.google.com/apis/credentials
# 1. Create OAuth 2.0 Client ID
# 2. Application type: Web application
# 3. Authorized redirect URIs: http://localhost:4000/auth/oauth/google/callback
GOOGLE_CLIENT_ID="YOUR_GOOGLE_CLIENT_ID"
GOOGLE_CLIENT_SECRET="YOUR_GOOGLE_CLIENT_SECRET"
GOOGLE_CALLBACK_URL="http://localhost:4000/auth/oauth/google/callback"

# Enterprise SAML SSO (预留配置)
SAML_ENTRY_POINT=""
SAML_ISSUER=""
SAML_CERT=""
SAML_CALLBACK_URL="http://localhost:4000/auth/oauth/saml/callback"

# ========================================
# Webhook Configuration
# ========================================
# Webhook secret for signature verification (HMAC-SHA256)
# ⚠️ Generate strong secret using: openssl rand -base64 32
# ⚠️ This secret is used to verify webhooks from external CI/CD systems
#
# Generate secret:
#   openssl rand -base64 32  # For WEBHOOK_SECRET
#
WEBHOOK_SECRET="YOUR_WEBHOOK_SECRET_MIN_32_CHARS_BASE64"

# ========================================
# Email Configuration (SMTP)
# ========================================
# Recommended providers:
#   - Brevo (https://www.brevo.com/) - Free tier: 9000 emails/month
#   - SendGrid (https://sendgrid.com/) - Free tier: 100 emails/day
#   - Mailgun (https://www.mailgun.com/) - Free tier: 5000 emails/month
#
# For Brevo:
#   1. Sign up at https://www.brevo.com/
#   2. Go to: Settings > SMTP & API > SMTP
#   3. Copy your SMTP credentials
SMTP_HOST="smtp.your-provider.com"
SMTP_PORT="587"  # Use 587 for STARTTLS, 465 for SSL/TLS
# SMTP_SECURE should be empty for port 587 (STARTTLS), "true" only for port 465 (SSL)
SMTP_SECURE=""
SMTP_USER="your-smtp-username@domain.com"
SMTP_PASS="YOUR_SMTP_PASSWORD_OR_API_KEY"
SMTP_FROM_EMAIL="noreply@your-domain.com"
SMTP_FROM_NAME="Flotilla Team"

# ========================================
# Security Notes
# ========================================
# 1. JWT密钥要求至少43个字符（256位Base64编码）- 符合HS256安全标准（CWE-326）
# 2. 密码要求至少12个字符，包含大小写、数字、特殊字符（CWE-521）
# 3. ALL passwords/secrets should be cryptographically secure
# 4. Use environment-specific secrets (dev, staging, prod)
# 5. Rotate secrets regularly (every 90 days recommended)
# 6. Never commit .env files to version control
# 7. Use secret management tools in production (Vault, AWS Secrets Manager, etc.)
# 8. Enable 2FA/MFA for all service accounts
#
# Generate strong secrets:
#   openssl rand -base64 43   # For JWT secrets (HS256 standard)
#   openssl rand -base64 32   # For most other secrets
#   openssl rand -base64 24   # For MeiliSearch (min 16 chars)
#   openssl rand -hex 32      # For hex-encoded secrets
# ========================================
