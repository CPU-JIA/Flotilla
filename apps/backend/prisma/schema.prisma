generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                     @id @default(cuid())
  username               String                     @unique @db.VarChar(50)
  email                  String                     @unique @db.VarChar(255)
  passwordHash           String                     @db.VarChar(255)
  avatar                 String?                    @db.VarChar(500)
  bio                    String?
  role                   UserRole                   @default(USER)
  isActive               Boolean                    @default(true)
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  emailVerified          Boolean                    @default(false)
  emailVerifyToken       String?                    @unique @db.VarChar(255)
  emailVerifyExpires     DateTime?
  passwordResetToken     String?                    @unique @db.VarChar(255)
  passwordResetExpires   DateTime?
  tokenVersion           Int                        @default(0)
  apiTokens              ApiToken[]
  auditLogs              AuditLog[]                 @relation("AuditLogUser")
  collaborationSessions  CollaborationParticipant[]
  commits                Commit[]
  dataExportRequests     DataExportRequest[]
  assignedIssues         IssueAssignee[]            @relation("IssueAssignees")
  issueComments          IssueComment[]             @relation("IssueCommentAuthor")
  issueEvents            IssueEvent[]               @relation("IssueEventActor")
  authoredIssues         Issue[]                    @relation("IssueAuthor")
  notificationPreference NotificationPreference?
  notifications          Notification[]
  oauthAccounts          OAuthAccount[]
  organizationMembers    OrganizationMember[]
  passwordHistories      PasswordHistory[]
  assignedPRs            PRAssignee[]               @relation("PRAssignees")
  prComments             PRComment[]
  prEvents               PREvent[]
  prReviews              PRReview[]
  uploadedFiles          ProjectFile[]
  projectMembers         ProjectMember[]
  ownedProjects          Project[]                  @relation("ProjectOwner")
  authoredPRs            PullRequest[]              @relation("PRAuthor")
  mergedPRs              PullRequest[]              @relation("PRMerger")
  teamMembers            TeamMember[]
  twoFactorAuth          TwoFactorAuth?
  sessions               UserSession[]
  createdWikiPages       WikiPage[]                 @relation("WikiPageCreator")
  editedWikiPages        WikiPage[]                 @relation("WikiPageEditor")
  editedWikiPageHistory  WikiPageHistory[]          @relation("WikiPageHistoryEditor")

  @@index([email])
  @@index([username])
  @@index([role, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–ç”¨æˆ·åˆ—è¡¨æŒ‰è§’è‰²è¿‡æ»¤ (WHERE role + ORDER BY createdAt)
  @@map("users")
}

model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String   @db.VarChar(255)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_histories")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  ipAddress    String   @db.VarChar(45)
  userAgent    String
  device       String?  @db.VarChar(100)
  browser      String?  @db.VarChar(100)
  os           String?  @db.VarChar(100)
  location     String?  @db.VarChar(200)
  tokenVersion Int
  isActive     Boolean  @default(true)
  lastUsedAt   DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@map("user_sessions")
}

model Organization {
  id           String               @id @default(cuid())
  name         String               @db.VarChar(100)
  slug         String               @unique @db.VarChar(100)
  description  String?
  avatar       String?              @db.VarChar(500)
  website      String?              @db.VarChar(500)
  maxProjects  Int                  @default(1000)
  maxMembers   Int                  @default(1000)
  storageQuota BigInt               @default(107374182400)
  storageUsed  BigInt               @default(0)
  isPersonal   Boolean              @default(false)
  deletedAt    DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  members      OrganizationMember[]
  projects     Project[]
  teams        Team[]

  @@index([slug])
  @@index([deletedAt])
  @@index([createdAt])
  @@index([deletedAt, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–ç”¨æˆ·ç»„ç»‡åˆ—è¡¨æŸ¥è¯¢ (WHERE deletedAt + ORDER BY createdAt)
  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole      @default(MEMBER)
  joinedAt       DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([role])
  @@index([userId, role]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–é…é¢æ£€æŸ¥ (WHERE userId + role)
  @@index([organizationId, role, joinedAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–ç»„ç»‡æˆå‘˜åˆ—è¡¨æ’åº (WHERE organizationId + ORDER BY role, joinedAt)
  @@map("organization_members")
}

model Team {
  id                 String                  @id @default(cuid())
  organizationId     String
  name               String                  @db.VarChar(100)
  slug               String                  @db.VarChar(100)
  description        String?
  avatar             String?                 @db.VarChar(500)
  maxMembers         Int                     @default(100)
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  members            TeamMember[]
  projectPermissions TeamProjectPermission[]
  organization       Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([slug])
  @@map("teams")
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     TeamRole @default(MEMBER)
  joinedAt DateTime @default(now())
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([role])
  @@index([teamId, role, joinedAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–å›¢é˜Ÿæˆå‘˜åˆ—è¡¨æ’åº (WHERE teamId + ORDER BY role, joinedAt)
  @@map("team_members")
}

model TeamProjectPermission {
  id        String     @id @default(cuid())
  teamId    String
  projectId String
  role      MemberRole
  createdAt DateTime   @default(now())
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, projectId])
  @@index([projectId])
  @@index([teamId, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–å›¢é˜Ÿé¡¹ç›®æƒé™åˆ—è¡¨ (WHERE teamId + ORDER BY createdAt)
  @@map("team_project_permissions")
}

model Project {
  id                     String                  @id @default(cuid())
  name                   String                  @db.VarChar(100)
  description            String?
  visibility             ProjectVisibility       @default(PRIVATE)
  ownerId                String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  organizationId         String?
  archivedAt             DateTime?
  defaultBranch          String?                 @default("main") @db.VarChar(100)
  isArchived             Boolean                 @default(false)
  allowSelfMerge         Boolean                 @default(true)
  requireApprovals       Int                     @default(1)
  requireReviewFromOwner Boolean                 @default(false)

  // ğŸ”’ ECP-A1é˜²å¾¡ç¼–ç¨‹: åŸå­è®¡æ•°å™¨é˜²æ­¢å¹¶å‘ç«æ€
  nextIssueNumber        Int                     @default(1)
  nextPRNumber           Int                     @default(1)
  branchProtectionRules  BranchProtectionRule[]
  collaborationSessions  CollaborationSession[]
  issues                 Issue[]
  labels                 Label[]
  milestones             Milestone[]
  pipelines              Pipeline[]
  projectFiles           ProjectFile[]
  members                ProjectMember[]
  organization           Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner                  User                    @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  pullRequests           PullRequest[]
  repository             Repository?
  searchMetadata         SearchMetadata[]
  teamPermissions        TeamProjectPermission[]
  webhooks               Webhook[]
  wikiPages              WikiPage[]

  @@unique([ownerId, name])
  @@unique([organizationId, name])
  @@index([visibility])
  @@map("projects")
}

model ProjectMember {
  id        String     @id @default(cuid())
  projectId String
  userId    String
  role      MemberRole @default(MEMBER)
  joinedAt  DateTime   @default(now())
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([projectId, joinedAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–æˆå‘˜åˆ—è¡¨æ’åº (WHERE projectId + ORDER BY joinedAt)
  @@map("project_members")
}

model Repository {
  id             String           @id @default(cuid())
  projectId      String           @unique
  defaultBranch  String           @default("main") @db.VarChar(100)
  storageUsed    BigInt           @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  branches       Branch[]
  commits        Commit[]
  files          File[]
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  searchMetadata SearchMetadata[]

  @@index([projectId])
  @@map("repositories")
}

model Branch {
  id           String     @id @default(cuid())
  repositoryId String
  name         String     @db.VarChar(100)
  commitId     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  commit       Commit?    @relation("BranchCommit", fields: [commitId], references: [id])
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  commits      Commit[]   @relation("BranchCommits")
  files        File[]

  @@unique([repositoryId, name])
  @@index([commitId])
  @@map("branches")
}

model Commit {
  id           String     @id @default(cuid())
  repositoryId String
  branchId     String
  authorId     String
  message      String
  hash         String     @default(cuid()) @db.VarChar(64)
  parentHash   String?    @db.VarChar(64)
  createdAt    DateTime   @default(now())
  branchHeads  Branch[]   @relation("BranchCommit")
  author       User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  branch       Branch     @relation("BranchCommits", fields: [branchId], references: [id], onDelete: Cascade)
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  files        File[]

  @@index([repositoryId])
  @@index([branchId])
  @@index([authorId])
  @@index([hash])
  @@index([createdAt])
  @@map("commits")
}

model File {
  id             String          @id @default(cuid())
  repositoryId   String
  branchId       String
  commitId       String?
  path           String          @db.VarChar(500)
  objectName     String          @db.VarChar(1000)
  size           Int
  mimeType       String          @db.VarChar(100)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  branch         Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  commit         Commit?         @relation(fields: [commitId], references: [id])
  repository     Repository      @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  searchMetadata SearchMetadata?

  @@unique([repositoryId, branchId, path])
  @@index([branchId])
  @@index([commitId])
  @@index([path])
  @@map("files")
}

model SearchMetadata {
  id            String      @id @default(cuid())
  fileId        String      @unique
  projectId     String
  repositoryId  String
  status        IndexStatus @default(PENDING)
  indexedAt     DateTime?
  failureReason String?
  retryCount    Int         @default(0)
  lastCommitId  String?     @db.VarChar(64)
  contentHash   String?     @db.VarChar(64)
  symbolCount   Int         @default(0)
  lineCount     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  file          File        @relation(fields: [fileId], references: [id], onDelete: Cascade)
  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository    Repository  @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([repositoryId])
  @@index([status])
  @@index([indexedAt])
  @@index([projectId, status, indexedAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–ç´¢å¼•çŠ¶æ€æŸ¥è¯¢ (WHERE projectId + status + ORDER BY indexedAt)
  @@map("search_metadata")
}

model RaftLog {
  id        String   @id @default(cuid())
  index     Int      @unique
  term      Int
  command   String
  timestamp BigInt
  createdAt DateTime @default(now())

  @@index([index])
  @@index([term])
  @@index([createdAt])
  @@map("raft_logs")
}

model RaftState {
  id          String        @id @default(cuid())
  nodeId      String        @unique @db.VarChar(50)
  currentTerm Int           @default(0)
  votedFor    String?       @db.VarChar(50)
  state       RaftNodeState @default(FOLLOWER)
  leaderId    String?       @db.VarChar(50)
  commitIndex Int           @default(0)
  lastApplied Int           @default(0)
  updatedAt   DateTime      @updatedAt

  @@index([nodeId])
  @@map("raft_state")
}

model ProjectFile {
  id         String   @id @default(cuid())
  projectId  String
  name       String   @db.VarChar(255)
  path       String   @db.VarChar(1000)
  size       Int
  mimeType   String   @db.VarChar(100)
  type       String   @db.VarChar(10)
  folder     String?  @db.VarChar(500)
  uploadedBy String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader   User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([uploadedBy])
  @@index([folder])
  @@index([type])
  @@map("project_files")
}

model Issue {
  id          String          @id @default(cuid())
  projectId   String
  number      Int
  title       String          @db.VarChar(500)
  body        String?
  state       IssueState      @default(OPEN)
  authorId    String
  milestoneId String?
  closedAt    DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  assignees   IssueAssignee[]
  comments    IssueComment[]
  events      IssueEvent[]
  labels      IssueLabel[]
  author      User            @relation("IssueAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  milestone   Milestone?      @relation(fields: [milestoneId], references: [id])
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, number])
  @@index([authorId])
  @@index([state])
  @@index([milestoneId])
  @@index([createdAt])
  @@index([projectId, state, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ– Issue åˆ—è¡¨æŸ¥è¯¢ (WHERE projectId + state + ORDER BY createdAt)
  @@map("issues")
}

model Label {
  id          String       @id @default(cuid())
  projectId   String
  name        String       @db.VarChar(50)
  color       String       @db.VarChar(7)
  description String?      @db.VarChar(200)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  issueLabels IssueLabel[]
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@map("labels")
}

model IssueLabel {
  id        String   @id @default(cuid())
  issueId   String
  labelId   String
  createdAt DateTime @default(now())
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  label     Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([issueId, labelId])
  @@index([labelId])
  @@index([issueId])
  @@map("issue_labels")
}

model Milestone {
  id          String         @id @default(cuid())
  projectId   String
  title       String         @db.VarChar(200)
  description String?
  dueDate     DateTime?
  state       MilestoneState @default(OPEN)
  closedAt    DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  issues      Issue[]
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, title])
  @@index([state])
  @@index([dueDate])
  @@map("milestones")
}

model IssueComment {
  id        String   @id @default(cuid())
  issueId   String
  authorId  String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation("IssueCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([authorId])
  @@index([createdAt])
  @@map("issue_comments")
}

model IssueAssignee {
  id         String   @id @default(cuid())
  issueId    String
  userId     String
  assignedAt DateTime @default(now())
  issue      Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user       User     @relation("IssueAssignees", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([issueId, userId])
  @@index([userId])
  @@index([issueId])
  @@map("issue_assignees")
}

model IssueEvent {
  id        String   @id @default(cuid())
  issueId   String
  actorId   String
  event     String   @db.VarChar(50)
  metadata  Json?
  createdAt DateTime @default(now())
  actor     User     @relation("IssueEventActor", fields: [actorId], references: [id], onDelete: Cascade)
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([actorId])
  @@index([event])
  @@index([createdAt])
  @@map("issue_events")
}

model PullRequest {
  id            String         @id @default(cuid())
  projectId     String
  number        Int
  title         String         @db.VarChar(500)
  body          String?
  sourceBranch  String         @db.VarChar(100)
  targetBranch  String         @db.VarChar(100)
  state         PRState        @default(OPEN)
  authorId      String
  mergedAt      DateTime?
  mergedBy      String?
  mergeCommit   String?        @db.VarChar(64)
  closedAt      DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  mergeStrategy MergeStrategy?
  assignees     PRAssignee[]
  comments      PRComment[]
  events        PREvent[]
  reviews       PRReview[]
  author        User           @relation("PRAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  merger        User?          @relation("PRMerger", fields: [mergedBy], references: [id])
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, number])
  @@index([projectId])
  @@index([authorId])
  @@index([state])
  @@index([createdAt])
  @@index([projectId, state, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ– PR åˆ—è¡¨æŸ¥è¯¢ (WHERE projectId + state + ORDER BY createdAt)
  @@map("pull_requests")
}

model PRAssignee {
  id            String      @id @default(cuid())
  pullRequestId String
  userId        String
  assignedAt    DateTime    @default(now())
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  user          User        @relation("PRAssignees", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pullRequestId, userId])
  @@index([userId])
  @@index([pullRequestId])
  @@map("pr_assignees")
}

model PRReview {
  id            String      @id @default(cuid())
  pullRequestId String
  reviewerId    String
  state         ReviewState
  body          String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  reviewer      User        @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([reviewerId])
  @@index([state])
  @@map("pr_reviews")
}

model PRComment {
  id            String      @id @default(cuid())
  pullRequestId String
  authorId      String
  body          String
  filePath      String?     @db.VarChar(500)
  lineNumber    Int?
  commitHash    String?     @db.VarChar(64)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  author        User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([authorId])
  @@index([createdAt])
  @@index([pullRequestId, filePath, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ– PR diff è¡Œå†…è¯„è®ºæŸ¥è¯¢ (WHERE pullRequestId + filePath + ORDER BY createdAt)
  @@map("pr_comments")
}

model PREvent {
  id            String      @id @default(cuid())
  pullRequestId String
  actorId       String
  event         String      @db.VarChar(50)
  metadata      Json?
  createdAt     DateTime    @default(now())
  actor         User        @relation(fields: [actorId], references: [id], onDelete: Cascade)
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([actorId])
  @@index([event])
  @@index([createdAt])
  @@map("pr_events")
}

/// *
///  * é€šçŸ¥è¡¨
///  * å­˜å‚¨æ‰€æœ‰ç”¨æˆ·é€šçŸ¥è®°å½•
///  * ECP-C3: Performance Awareness - æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
///  * - userId: æŒ‰ç”¨æˆ·æŸ¥è¯¢æœªè¯»é€šçŸ¥
///  * - read: å¿«é€Ÿè¿‡æ»¤å·²è¯»/æœªè¯»
///  * - createdAt: æ—¶é—´æ’åº
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String           @db.VarChar(200)
  body      String?
  read      Boolean          @default(false)
  link      String?          @db.VarChar(500)
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([userId, read, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–é€šçŸ¥åˆ—è¡¨æŸ¥è¯¢ (WHERE userId + read + ORDER BY createdAt)
  @@map("notifications")
}

/// *
///  * é€šçŸ¥åå¥½è®¾ç½®è¡¨
///  * ç”¨æˆ·å¯è‡ªå®šä¹‰æ¥æ”¶å“ªäº›ç±»å‹çš„é€šçŸ¥
///  * ECP-A1: SOLID - å•ä¸€èŒè´£åŸåˆ™
///  * - æ¯ä¸ªç”¨æˆ·ä¸€æ¡é…ç½®è®°å½•ï¼ˆ1:1å…³ç³»ï¼‰
model NotificationPreference {
  id                 String   @id @default(cuid())
  userId             String   @unique
  prCreated          Boolean  @default(true)
  prMerged           Boolean  @default(true)
  prReviewed         Boolean  @default(true)
  prCommented        Boolean  @default(true)
  issueMentioned     Boolean  @default(true)
  issueAssigned      Boolean  @default(true)
  issueCommented     Boolean  @default(true)
  emailNotifications Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

/// *
///  * åˆ†æ”¯ä¿æŠ¤è§„åˆ™è¡¨
///  * ä¸ºé¡¹ç›®çš„ç‰¹å®šåˆ†æ”¯é…ç½®ä¿æŠ¤ç­–ç•¥ï¼Œé˜²æ­¢æœªç»å®¡æ ¸çš„ä»£ç åˆå¹¶
///  * MVPåŠŸèƒ½ï¼š
///  * - è¦æ±‚PRå®¡æ ¸æ‰èƒ½åˆå¹¶
///  * - è®¾ç½®æœ€å°‘å®¡æ ¸äººæ•°
///  * - ç¦æ­¢ç›´æ¥æ¨é€åˆ°ä¿æŠ¤åˆ†æ”¯
///  * åç»­æ‰©å±•ï¼š
///  * - åˆ†æ”¯æ¨¡å¼åŒ¹é…ï¼ˆé€šé…ç¬¦æ”¯æŒï¼‰
///  * - CI/CDçŠ¶æ€æ£€æŸ¥é›†æˆ
///  * - Code Ownerå®¡æŸ¥è¦æ±‚
model BranchProtectionRule {
  id                       String   @id @default(cuid())
  projectId                String
  branchPattern            String   @db.VarChar(100)
  requirePullRequest       Boolean  @default(true)
  requiredApprovingReviews Int      @default(1)
  dismissStaleReviews      Boolean  @default(false)
  requireCodeOwnerReview   Boolean  @default(false)
  allowForcePushes         Boolean  @default(false)
  allowDeletions           Boolean  @default(false)
  requireStatusChecks      Boolean  @default(false)
  requiredStatusChecks     String[]
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  project                  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, branchPattern])
  @@index([projectId])
  @@map("branch_protection_rules")
}

/// *
///  * å®‰å…¨å®¡è®¡æ—¥å¿—è¡¨
///  * Phase 4: è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œå’Œå®‰å…¨äº‹ä»¶ï¼Œç”¨äºåˆè§„å®¡è®¡å’Œå®‰å…¨åˆ†æ
///  * æ ¸å¿ƒåŠŸèƒ½ï¼š
///  * - è®°å½•ç”¨æˆ·æ“ä½œï¼ˆç™»å½•ã€æƒé™å˜æ›´ã€æ•æ„Ÿæ•°æ®è®¿é—®ï¼‰
///  * - è®°å½•èµ„æºå˜æ›´ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰
///  * - è®°å½•å®¡è®¡è¿½è¸ªï¼ˆè°ã€ä»€ä¹ˆæ—¶é—´ã€åšäº†ä»€ä¹ˆã€ç»“æœå¦‚ä½•ï¼‰
///  * - æ”¯æŒ IP åœ°å€å’Œ User-Agent è¿½è¸ª
///  * åˆè§„è¦æ±‚ï¼š
///  * - SOC2: å®¡è®¡æ—¥å¿—ä¿ç•™è‡³å°‘90å¤©
///  * - ISO27001: è®°å½•å®‰å…¨ç›¸å…³äº‹ä»¶
///  * - GDPR: è®°å½•ä¸ªäººæ•°æ®è®¿é—®
model AuditLog {
  id          String          @id @default(cuid())
  entityId    String?         @db.VarChar(100)
  userId      String?         @db.VarChar(100)
  username    String?         @db.VarChar(50)
  ipAddress   String?         @db.VarChar(45)
  userAgent   String?
  description String
  metadata    Json?
  success     Boolean         @default(true)
  errorMsg    String?
  createdAt   DateTime        @default(now())
  action      AuditAction     @default(ACCESS)
  entityType  AuditEntityType
  user        User?           @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–ç”¨æˆ·å®¡è®¡æ—¥å¿—æŸ¥è¯¢ (WHERE userId + ORDER BY createdAt)
  @@index([entityType, entityId, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–å®ä½“å®¡è®¡æ—¥å¿—æŸ¥è¯¢ (WHERE entityType + entityId + ORDER BY createdAt)
  @@index([success, createdAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ–å¤±è´¥æ—¥å¿—æŸ¥è¯¢ (WHERE success + ORDER BY createdAt)
  @@index([createdAt]) // ğŸ”’ ECP-C3: å•åˆ—ç´¢å¼•ä¼˜åŒ–æ—¥å¿—æ¸…ç†å’Œå¯¼å‡º (WHERE createdAt + ORDER BY)
  @@map("audit_logs")
}

/// *
///  * API Token è¡¨
///  * ç”¨æˆ·å¯åˆ›å»ºå¤šä¸ª API ä»¤ç‰Œç”¨äºç¨‹åºåŒ–è®¿é—® API
///  * æ ¸å¿ƒåŠŸèƒ½ï¼š
///  * - æ”¯æŒå¤šä¸ªä»¤ç‰Œï¼ˆæ¯ä¸ªä»¤ç‰Œæœ‰ç‹¬ç«‹åç§°ï¼‰
///  * - ä½œç”¨åŸŸæ§åˆ¶ï¼ˆread, write, adminï¼‰
///  * - å¯é€‰è¿‡æœŸæ—¶é—´
///  * - SHA256 å“ˆå¸Œå­˜å‚¨ï¼ˆå®‰å…¨æ€§ï¼‰
///  * - ä»¤ç‰Œåªåœ¨åˆ›å»ºæ—¶æ˜¾ç¤ºä¸€æ¬¡
///  * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - ä»¤ç‰Œå“ˆå¸Œå­˜å‚¨ï¼Œä¸å¯é€†
///  * ECP-C2: ç³»ç»ŸåŒ–é”™è¯¯å¤„ç† - è¿‡æœŸéªŒè¯ã€ä½œç”¨åŸŸéªŒè¯
model ApiToken {
  id          String    @id @default(cuid())
  userId      String
  name        String    @db.VarChar(100)
  tokenHash   String    @unique @db.VarChar(64)
  tokenPrefix String    @db.VarChar(8)
  scopes      String[]
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([userId, createdAt(sort: Desc)])
  @@map("api_tokens")
}

/// *
///  * Newsletter è®¢é˜…è€…è¡¨
///  * ç”¨äºè¥é”€ç½‘ç«™çš„Newsletterè®¢é˜…åŠŸèƒ½
///  * æ ¸å¿ƒåŠŸèƒ½ï¼š
///  * - é‚®ç®±è®¢é˜…
///  * - åŒé‡ç¡®è®¤ï¼ˆå‘é€ç¡®è®¤é‚®ä»¶ï¼‰
///  * - å–æ¶ˆè®¢é˜…
///  * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - é‚®ç®±å”¯ä¸€æ€§ã€ç¡®è®¤tokenå®‰å…¨
model NewsletterSubscriber {
  id           String    @id @default(cuid())
  email        String    @unique @db.VarChar(255)
  confirmToken String    @unique @db.VarChar(64)
  confirmed    Boolean   @default(false)
  confirmedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("newsletter_subscribers")
}

/// *
///  * Wiki é¡µé¢æ¨¡å‹
///  * æ”¯æŒå±‚çº§ç»“æ„ã€ç‰ˆæœ¬å†å²ã€Markdown å†…å®¹
///  * ECP-A1: SOLID - æ¸…æ™°çš„æ•°æ®æ¨¡å‹ç»“æ„
///  * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - slug å”¯ä¸€æ€§çº¦æŸ
model WikiPage {
  id             String            @id @default(cuid())
  projectId      String
  slug           String            @db.VarChar(200)
  title          String            @db.VarChar(500)
  content        String
  parentId       String?
  order          Int               @default(0)
  createdById    String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  lastEditedById String
  history        WikiPageHistory[]
  createdBy      User              @relation("WikiPageCreator", fields: [createdById], references: [id])
  lastEditedBy   User              @relation("WikiPageEditor", fields: [lastEditedById], references: [id])
  project        Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([parentId])
  @@map("wiki_pages")
}

/// *
///  * Wiki é¡µé¢å†å²è®°å½•æ¨¡å‹
///  * ä¿å­˜æ¯æ¬¡ç¼–è¾‘çš„å†å²ç‰ˆæœ¬
///  * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - å®Œæ•´çš„ç‰ˆæœ¬è¿½æº¯
model WikiPageHistory {
  id         String   @id(map: "wiki_page_histories_pkey") @default(cuid())
  pageId     String
  title      String   @db.VarChar(500)
  content    String
  editedById String
  editedAt   DateTime @default(now())
  message    String?  @db.VarChar(500)
  version    Int      @default(1)
  editedBy   User     @relation("WikiPageHistoryEditor", fields: [editedById], references: [id])
  page       WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade, map: "wiki_page_histories_pageId_fkey")

  @@map("wiki_page_history")
}

/// *
///  * OAuth è´¦æˆ·å…³è”è¡¨
///  * æ”¯æŒç¬¬ä¸‰æ–¹ OAuth ç™»å½•ï¼ˆGitHubã€Google ç­‰ï¼‰
///  * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - ä»¤ç‰ŒåŠ å¯†å­˜å‚¨
model OAuthAccount {
  id           String    @id @default(cuid())
  userId       String
  provider     String    @db.VarChar(50)
  providerId   String    @db.VarChar(255)
  email        String?   @db.VarChar(255)
  displayName  String?   @db.VarChar(255)
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  scope        String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider])
  @@index([email])
  @@map("oauth_accounts")
}

/// *
///  * Pipeline é…ç½®è¡¨
///  * å®šä¹‰ CI/CD æµæ°´çº¿é…ç½®
model Pipeline {
  id        String        @id @default(cuid())
  projectId String
  name      String        @db.VarChar(100)
  config    Json
  triggers  String[]
  active    Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  runs      PipelineRun[]
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@index([projectId])
  @@index([active])
  @@map("pipelines")
}

/// *
///  * Pipeline è¿è¡Œè®°å½•è¡¨
///  * è®°å½•æ¯æ¬¡æµæ°´çº¿æ‰§è¡Œæƒ…å†µ
model PipelineRun {
  id         String         @id @default(cuid())
  pipelineId String
  commitSha  String         @db.VarChar(64)
  branch     String         @db.VarChar(100)
  status     PipelineStatus @default(PENDING)
  startedAt  DateTime       @default(now())
  finishedAt DateTime?
  duration   Int?
  logs       String?
  metadata   Json?
  pipeline   Pipeline       @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@index([pipelineId])
  @@index([status])
  @@index([commitSha])
  @@index([startedAt])
  @@index([pipelineId, startedAt(sort: Desc)])
  @@map("pipeline_runs")
}

/// *
///  * Webhook é…ç½®è¡¨
///  * æ”¯æŒäº‹ä»¶æ¨é€åˆ°å¤–éƒ¨ URL
model Webhook {
  id         String            @id @default(cuid())
  projectId  String
  url        String            @db.VarChar(500)
  secret     String            @db.VarChar(255) // å·²å¼ƒç”¨ï¼šä»…ç”¨äºå‘åå…¼å®¹ï¼Œæ–°åˆ›å»ºçš„webhookä½¿ç”¨secretHash
  secretHash String?           @db.VarChar(255) // SHA256å“ˆå¸Œå€¼ï¼Œç”¨äºå®‰å…¨éªŒè¯
  events     String[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  active     Boolean           @default(true)
  deliveries WebhookDelivery[]
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("webhooks")
}

/// *
///  * Webhook æŠ•é€’è®°å½•è¡¨
///  * è®°å½•æ¯æ¬¡ Webhook å‘é€ç»“æœ
model WebhookDelivery {
  id             String   @id @default(cuid())
  webhookId      String
  event          String   @db.VarChar(100)
  payload        Json
  statusCode     Int?
  response       Json?
  success        Boolean  @default(false)
  deliveredAt    DateTime @default(now())
  requestHeaders Json?
  retryCount     Int      @default(0)
  webhook        Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([webhookId, deliveredAt]) // ğŸ”’ ECP-C3: å¤åˆç´¢å¼•ä¼˜åŒ– Webhook æŠ•é€’å†å²æŸ¥è¯¢ (WHERE webhookId + ORDER BY deliveredAt)
  @@map("webhook_deliveries")
}

/// *
///  * ä¸¤æ­¥éªŒè¯é…ç½®è¡¨
///  * æ”¯æŒTOTPï¼ˆTime-based One-Time Passwordï¼‰
model TwoFactorAuth {
  id            String    @id @default(cuid())
  userId        String    @unique
  secret        String    @db.VarChar(255)
  recoveryCodes String[]
  enabled       Boolean   @default(false)
  verifiedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("two_factor_auth")
}

/// *
///  * åä½œä¼šè¯è¡¨
///  * ç®¡ç†å®æ—¶åä½œç¼–è¾‘ä¼šè¯
model CollaborationSession {
  id           String                     @id @default(cuid())
  documentType String                     @db.VarChar(20)
  documentId   String                     @db.VarChar(500)
  projectId    String
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  participants CollaborationParticipant[]
  project      Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("collaboration_sessions")
}

/// *
///  * åä½œå‚ä¸è€…è¡¨
///  * è®°å½•æ¯ä¸ªä¼šè¯çš„å‚ä¸ç”¨æˆ·
model CollaborationParticipant {
  id           String               @id @default(cuid())
  sessionId    String
  userId       String
  color        String               @db.VarChar(20)
  joinedAt     DateTime             @default(now())
  lastActiveAt DateTime             @default(now())
  session      CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("collaboration_participants")
}

/// *
///  * æ•°æ®å¯¼å‡ºè¯·æ±‚è¡¨
///  * æ”¯æŒ GDPR åˆè§„çš„ç”¨æˆ·æ•°æ®å¯¼å‡ºåŠŸèƒ½
model DataExportRequest {
  id          String           @id @default(cuid())
  userId      String
  filePath    String?          @db.VarChar(500)
  fileSize    Int?
  expiresAt   DateTime?
  completedAt DateTime?
  errorMsg    String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  format      DataExportFormat @default(JSON)
  status      DataExportStatus @default(PENDING)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("data_export_requests")
}

enum UserRole {
  USER
  SUPER_ADMIN
}

enum ProjectVisibility {
  PUBLIC
  PRIVATE
}

enum MemberRole {
  OWNER
  MAINTAINER
  MEMBER
  VIEWER
}

enum RaftNodeState {
  FOLLOWER
  CANDIDATE
  LEADER
}

enum IssueState {
  OPEN
  CLOSED
}

enum MilestoneState {
  OPEN
  CLOSED
}

enum PRState {
  OPEN
  MERGED
  CLOSED
}

enum ReviewState {
  APPROVED
  CHANGES_REQUESTED
  COMMENTED
}

enum MergeStrategy {
  MERGE
  SQUASH
  REBASE
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum TeamRole {
  MAINTAINER
  MEMBER
}

enum IndexStatus {
  PENDING
  INDEXING
  INDEXED
  FAILED
  OUTDATED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ACCESS
  DOWNLOAD
  UPLOAD
  GRANT
  REVOKE
  APPROVE
  REJECT
  LOGIN_FAILED
  PERMISSION_DENIED
  UNAUTHORIZED_ACCESS
}

enum AuditEntityType {
  USER
  PROJECT
  REPOSITORY
  FILE
  ISSUE
  PULL_REQUEST
  ORGANIZATION
  TEAM
  BRANCH_PROTECTION
  SETTINGS
}

/// *
///  * é€šçŸ¥ç±»å‹æšä¸¾
///  * æ”¯æŒçš„é€šçŸ¥åœºæ™¯ï¼š
///  * - Pull Requestç›¸å…³ï¼šåˆ›å»ºã€åˆå¹¶ã€å…³é—­ã€å®¡æŸ¥ã€è¯„è®º
///  * - Issueç›¸å…³ï¼šæåŠã€åˆ†é…ã€è¯„è®º
enum NotificationType {
  PR_CREATED
  PR_MERGED
  PR_CLOSED
  PR_REVIEWED
  PR_COMMENTED
  ISSUE_MENTIONED
  ISSUE_ASSIGNED
  ISSUE_COMMENTED
}

enum PipelineStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILURE
  CANCELLED
}

/// *
///  * æ•°æ®å¯¼å‡ºæ ¼å¼æšä¸¾
enum DataExportFormat {
  JSON
  CSV
}

/// *
///  * æ•°æ®å¯¼å‡ºçŠ¶æ€æšä¸¾
enum DataExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}
