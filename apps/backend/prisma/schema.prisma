// Prisma Schema for Cloud Dev Platform
// åŸºäºäº‘è®¡ç®—çš„å¼€å‘åä½œå¹³å°

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// æšä¸¾å®šä¹‰
// ============================================

enum UserRole {
  USER // æ™®é€šç”¨æˆ·
  SUPER_ADMIN // è¶…çº§ç®¡ç†å‘˜
}

enum ProjectVisibility {
  PUBLIC // å…¬å¼€
  PRIVATE // ç§æœ‰
}

enum MemberRole {
  OWNER // æ‰€æœ‰è€…
  MAINTAINER // ç»´æŠ¤è€…ï¼ˆå¯ç®¡ç†é¡¹ç›®è®¾ç½®ã€å®¡æ ¸PRï¼‰
  MEMBER // æˆå‘˜ï¼ˆå¯è¯»å†™ä»£ç ï¼‰
  VIEWER // æŸ¥çœ‹è€…ï¼ˆåªè¯»ï¼‰
}

enum RaftNodeState {
  FOLLOWER // è·Ÿéšè€…
  CANDIDATE // å€™é€‰äºº
  LEADER // é¢†å¯¼è€…
}

enum IssueState {
  OPEN // å¼€æ”¾çŠ¶æ€
  CLOSED // å·²å…³é—­
}

enum MilestoneState {
  OPEN // è¿›è¡Œä¸­
  CLOSED // å·²å®Œæˆ
}

enum PRState {
  OPEN // å¼€æ”¾çŠ¶æ€
  MERGED // å·²åˆå¹¶
  CLOSED // å·²å…³é—­
}

enum ReviewState {
  APPROVED // æ‰¹å‡†
  CHANGES_REQUESTED // è¯·æ±‚ä¿®æ”¹
  COMMENTED // ä»…è¯„è®º
}

enum MergeStrategy {
  MERGE // æ ‡å‡†merge commit (ä¿ç•™å®Œæ•´å†å²)
  SQUASH // Squash merge (å‹ç¼©æˆå•ä¸ªcommit)
  REBASE // Rebase merge (çº¿æ€§å†å²)
}

enum OrgRole {
  OWNER // ç»„ç»‡æ‰€æœ‰è€…ï¼ˆæœ€é«˜æƒé™ï¼‰
  ADMIN // ç»„ç»‡ç®¡ç†å‘˜ï¼ˆå¯ç®¡ç†æˆå‘˜å’Œè®¾ç½®ï¼‰
  MEMBER // ç»„ç»‡æˆå‘˜ï¼ˆåŸºç¡€æƒé™ï¼‰
}

enum TeamRole {
  MAINTAINER // å›¢é˜Ÿç»´æŠ¤è€…ï¼ˆå¯ç®¡ç†å›¢é˜Ÿå’Œåˆ†é…æƒé™ï¼‰
  MEMBER // å›¢é˜Ÿæˆå‘˜ï¼ˆç»§æ‰¿å›¢é˜Ÿæƒé™ï¼‰
}

enum IndexStatus {
  PENDING // ç­‰å¾…ç´¢å¼•
  INDEXING // ç´¢å¼•ä¸­
  INDEXED // å·²ç´¢å¼•
  FAILED // ç´¢å¼•å¤±è´¥
  OUTDATED // å·²è¿‡æœŸï¼ˆæ–‡ä»¶æœ‰æ–°æäº¤ï¼‰
}

enum AuditAction {
  CREATE // åˆ›å»º
  UPDATE // æ›´æ–°
  DELETE // åˆ é™¤
  LOGIN // ç™»å½•
  LOGOUT // ç™»å‡º
  ACCESS // è®¿é—®
  DOWNLOAD // ä¸‹è½½
  UPLOAD // ä¸Šä¼ 
  GRANT // æˆæƒ
  REVOKE // æ’¤é”€
  APPROVE // æ‰¹å‡†
  REJECT // æ‹’ç»
}

enum AuditEntityType {
  USER // ç”¨æˆ·
  PROJECT // é¡¹ç›®
  REPOSITORY // ä»“åº“
  FILE // æ–‡ä»¶
  ISSUE // Issue
  PULL_REQUEST // Pull Request
  ORGANIZATION // ç»„ç»‡
  TEAM // å›¢é˜Ÿ
  BRANCH_PROTECTION // åˆ†æ”¯ä¿æŠ¤
  SETTINGS // è®¾ç½®
}

// ============================================
// ç”¨æˆ·æ¨¡å—
// ============================================

model User {
  id           String   @id @default(cuid())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @db.VarChar(255)
  avatar       String?  @db.VarChar(500)
  bio          String?  @db.Text
  role         UserRole @default(USER)
  isActive     Boolean  @default(true) // è´¦æˆ·æ˜¯å¦æ¿€æ´»ï¼ˆå°ç¦åŠŸèƒ½ï¼‰

  // é‚®ç®±éªŒè¯å­—æ®µ
  emailVerified      Boolean   @default(false) // é‚®ç®±æ˜¯å¦å·²éªŒè¯
  emailVerifyToken   String?   @unique @db.VarChar(255) // é‚®ç®±éªŒè¯token
  emailVerifyExpires DateTime? // éªŒè¯tokenè¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰

  // å¯†ç é‡ç½®å­—æ®µ
  passwordResetToken   String?   @unique @db.VarChar(255) // å¯†ç é‡ç½®token
  passwordResetExpires DateTime? // é‡ç½®tokenè¿‡æœŸæ—¶é—´ï¼ˆ1å°æ—¶ï¼‰

  // ğŸ”’ SECURITY FIX: JWT Tokenç‰ˆæœ¬æ§åˆ¶ï¼ˆCWE-613: å¯†ç é‡ç½®åæ’¤é”€æ—§Tokenï¼‰
  tokenVersion Int @default(0) // Tokenç‰ˆæœ¬å·ï¼Œå¯†ç é‡ç½®/ç™»å‡ºæ—¶é€’å¢

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  ownedProjects          Project[]               @relation("ProjectOwner")
  projectMembers         ProjectMember[]
  commits                Commit[]
  uploadedFiles          ProjectFile[]
  organizationMembers    OrganizationMember[]
  teamMembers            TeamMember[]
  authoredIssues         Issue[]                 @relation("IssueAuthor")
  assignedIssues         IssueAssignee[]         @relation("IssueAssignees") // ğŸ”’ æ–°å¢
  issueComments          IssueComment[]          @relation("IssueCommentAuthor")
  issueEvents            IssueEvent[]            @relation("IssueEventActor")
  authoredPRs            PullRequest[]           @relation("PRAuthor")
  assignedPRs            PRAssignee[]            @relation("PRAssignees") // ğŸ”’ æ–°å¢
  mergedPRs              PullRequest[]           @relation("PRMerger")
  prReviews              PRReview[]
  prComments             PRComment[]
  prEvents               PREvent[]
  notifications          Notification[] // ç”¨æˆ·æ¥æ”¶çš„é€šçŸ¥
  notificationPreference NotificationPreference? // ç”¨æˆ·é€šçŸ¥åå¥½è®¾ç½®ï¼ˆ1:1å…³ç³»ï¼‰
  auditLogs              AuditLog[] // Phase 4: ç”¨æˆ·çš„å®¡è®¡æ—¥å¿—
  passwordHistories      PasswordHistory[] // ğŸ”’ å¯†ç å†å²è®°å½•ï¼ˆé˜²æ­¢é‡ç”¨æ—§å¯†ç ï¼‰
  sessions               UserSession[] // ğŸ”’ Phase 4: ç”¨æˆ·ä¼šè¯è®°å½•ï¼ˆè®¾å¤‡ç®¡ç†ï¼‰
  apiTokens              ApiToken[] // API ä»¤ç‰Œï¼ˆPersonal Access Tokenï¼‰
  createdWikiPages       WikiPage[]        @relation("WikiPageCreator") // åˆ›å»ºçš„ Wiki é¡µé¢
  editedWikiPages        WikiPage[]        @relation("WikiPageEditor") // æœ€åç¼–è¾‘çš„ Wiki é¡µé¢
  wikiPageEdits          WikiPageHistory[] @relation("WikiHistoryEditor") // Wiki ç¼–è¾‘å†å²
  oauthAccounts          OAuthAccount[] // OAuth è´¦æˆ·å…³è”
  twoFactorAuth          TwoFactorAuth? // ä¸¤æ­¥éªŒè¯é…ç½®
  collaborationSessions  CollaborationParticipant[] // å‚ä¸çš„åä½œä¼šè¯
  dataExportRequests     DataExportRequest[] // GDPR æ•°æ®å¯¼å‡ºè¯·æ±‚

  @@index([email])
  @@index([username])
  @@map("users")
}

// ğŸ”’ SECURITY FIX: å¯†ç å†å²è®°å½•è¡¨ï¼ˆé˜²æ­¢é‡ç”¨æ—§å¯†ç ï¼‰
// CWE-521: Weak Password Requirements
model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String   @db.VarChar(255)
  createdAt    DateTime @default(now())

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)]) // æŒ‰ç”¨æˆ·å’Œæ—¶é—´å€’åºç´¢å¼•ï¼ˆæŸ¥è¯¢æœ€è¿‘å¯†ç ï¼‰
  @@map("password_histories")
}

// ğŸ”’ Phase 4: ç”¨æˆ·ä¼šè¯è¡¨ï¼ˆè®¾å¤‡ç®¡ç†ã€å¼‚åœ°ç™»å½•æ£€æµ‹ï¼‰
// è®°å½•æ¯æ¬¡ç™»å½•çš„è®¾å¤‡ã€IPã€åœ°ç†ä½ç½®
model UserSession {
  id        String  @id @default(cuid())
  userId    String
  ipAddress String  @db.VarChar(45) // IPv4: 15å­—ç¬¦, IPv6: 45å­—ç¬¦
  userAgent String  @db.Text // æµè§ˆå™¨User-Agent
  device    String? @db.VarChar(100) // è®¾å¤‡ç±»å‹ï¼ˆè§£æè‡ªUser-Agentï¼‰
  browser   String? @db.VarChar(100) // æµè§ˆå™¨ç±»å‹
  os        String? @db.VarChar(100) // æ“ä½œç³»ç»Ÿ
  location  String? @db.VarChar(200) // åœ°ç†ä½ç½®ï¼ˆåŸå¸‚/å›½å®¶ï¼‰

  // Tokenç‰ˆæœ¬ï¼ˆç”¨äºæ’¤é”€ç‰¹å®šä¼šè¯ï¼‰
  tokenVersion Int

  // ä¼šè¯çŠ¶æ€
  isActive   Boolean  @default(true) // ä¼šè¯æ˜¯å¦æ¿€æ´»
  lastUsedAt DateTime @default(now()) // æœ€åæ´»è·ƒæ—¶é—´
  expiresAt  DateTime // Tokenè¿‡æœŸæ—¶é—´

  createdAt DateTime @default(now())

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive]) // æŸ¥è¯¢ç”¨æˆ·çš„æ´»è·ƒä¼šè¯
  @@index([userId, createdAt(sort: Desc)]) // æŸ¥è¯¢ç”¨æˆ·çš„å†å²ä¼šè¯
  @@index([expiresAt]) // å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯
  @@map("user_sessions")
}

// ============================================
// ç»„ç»‡ä¸å›¢é˜Ÿæ¨¡å—
// ============================================

model Organization {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  avatar      String? @db.VarChar(500)
  website     String? @db.VarChar(500)

  // èµ„æºé…é¢
  maxProjects  Int    @default(1000)
  maxMembers   Int    @default(1000)
  storageQuota BigInt @default(107374182400) // 100GB default
  storageUsed  BigInt @default(0)

  // ä¸ªäººç»„ç»‡æ ‡è¯†ï¼ˆç”¨äºæ•°æ®è¿ç§»æ—¶åŒºåˆ†ä¸ªäººé¡¹ç›®ç»„ç»‡ï¼‰
  isPersonal Boolean @default(false)

  // è½¯åˆ é™¤æ”¯æŒï¼ˆ30å¤©ä¿æŠ¤æœŸï¼‰
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // å…³ç³»
  members  OrganizationMember[]
  teams    Team[]
  projects Project[]

  @@index([slug])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("organizations")
}

model OrganizationMember {
  id             String  @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole @default(MEMBER)

  joinedAt DateTime @default(now())

  // å…³ç³»
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([role])
  // æ€§èƒ½ä¼˜åŒ–ç´¢å¼• - æå‡é«˜é¢‘æŸ¥è¯¢æ•ˆç‡
  @@index([organizationId, role]) // ä¼˜åŒ–æˆå‘˜è§’è‰²æŸ¥è¯¢ï¼ˆå¦‚ "ç»„ç»‡çš„æ‰€æœ‰ç®¡ç†å‘˜"ï¼‰
  @@map("organization_members")
}

model Team {
  id             String  @id @default(cuid())
  organizationId String
  name           String  @db.VarChar(100)
  slug           String  @db.VarChar(100)
  description    String? @db.Text
  avatar         String? @db.VarChar(500)

  // å›¢é˜Ÿæˆå‘˜é…é¢
  maxMembers Int @default(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  organization       Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members            TeamMember[]
  projectPermissions TeamProjectPermission[]

  @@unique([organizationId, slug])
  @@index([slug])
  @@map("teams")
}

model TeamMember {
  id     String   @id @default(cuid())
  teamId String
  userId String
  role   TeamRole @default(MEMBER)

  joinedAt DateTime @default(now())

  // å…³ç³»
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([role])
  @@map("team_members")
}

model TeamProjectPermission {
  id        String     @id @default(cuid())
  teamId    String
  projectId String
  role      MemberRole // å¤ç”¨é¡¹ç›®è§’è‰²ï¼šOWNER/MAINTAINER/MEMBER/VIEWER

  createdAt DateTime @default(now())

  // å…³ç³»
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([teamId, projectId])
  @@index([projectId])
  @@map("team_project_permissions")
}

// ============================================
// é¡¹ç›®æ¨¡å—
// ============================================

model Project {
  id             String            @id @default(cuid())
  name           String            @db.VarChar(100)
  description    String?           @db.Text
  visibility     ProjectVisibility @default(PRIVATE)
  ownerId        String
  organizationId String?

  // é¡¹ç›®è®¾ç½®åŠŸèƒ½å­—æ®µ
  defaultBranch String?   @default("main") @db.VarChar(100)
  isArchived    Boolean   @default(false)
  archivedAt    DateTime?

  // PR Approval Settings
  requireApprovals       Int     @default(1)
  allowSelfMerge         Boolean @default(true)
  requireReviewFromOwner Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  owner                 User                    @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  organization          Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  repository            Repository?
  members               ProjectMember[]
  projectFiles          ProjectFile[]
  teamPermissions       TeamProjectPermission[]
  issues                Issue[]
  labels                Label[]
  milestones            Milestone[]
  pullRequests          PullRequest[]
  branchProtectionRules BranchProtectionRule[]
  searchMetadata        SearchMetadata[] // Code Searchç´¢å¼•å…ƒæ•°æ®
  wikiPages             WikiPage[] // Wiki æ–‡æ¡£é¡µé¢
  pipelines             Pipeline[] // CI/CD æµæ°´çº¿
  webhooks              Webhook[] // Webhooks
  collaborationSessions CollaborationSession[] // åä½œä¼šè¯

  @@unique([ownerId, name])
  @@unique([organizationId, name])
  @@index([visibility])
  // æ€§èƒ½ä¼˜åŒ–ç´¢å¼• - æå‡é«˜é¢‘æŸ¥è¯¢æ•ˆç‡
  @@index([ownerId, visibility]) // ä¼˜åŒ–æ‰€æœ‰è€…çš„é¡¹ç›®æŸ¥è¯¢ï¼ˆå¦‚ "æˆ‘çš„å…¬å¼€é¡¹ç›®"ï¼‰
  @@index([visibility, updatedAt]) // ä¼˜åŒ–å…¬å¼€é¡¹ç›®åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ—¶é—´æ’åºï¼‰
  @@index([isArchived, updatedAt]) // ä¼˜åŒ–å½’æ¡£è¿‡æ»¤æŸ¥è¯¢ï¼ˆæ’é™¤å½’æ¡£é¡¹ç›®ï¼‰
  @@index([organizationId, visibility]) // ä¼˜åŒ–ç»„ç»‡é¡¹ç›®æŸ¥è¯¢ï¼ˆå¦‚ "ç»„ç»‡çš„å…¬å¼€é¡¹ç›®"ï¼‰
  @@map("projects")
}

model ProjectMember {
  id        String     @id @default(cuid())
  projectId String
  userId    String
  role      MemberRole @default(MEMBER)

  joinedAt DateTime @default(now())

  // å…³ç³»
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([projectId, role]) // ä¼˜åŒ–æŒ‰é¡¹ç›®å’Œè§’è‰²æŸ¥è¯¢ï¼ˆå¦‚ï¼šæŸ¥æ‰¾æ‰€æœ‰MAINTAINERï¼‰
  @@map("project_members")
}

// ============================================
// ä»“åº“æ¨¡å—
// ============================================

model Repository {
  id            String @id @default(cuid())
  projectId     String @unique
  defaultBranch String @default("main") @db.VarChar(100)
  storageUsed   BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branches       Branch[]
  commits        Commit[]
  files          File[]
  searchMetadata SearchMetadata[] // Code Searchç´¢å¼•å…ƒæ•°æ®

  @@index([projectId])
  @@map("repositories")
}

model Branch {
  id           String  @id @default(cuid())
  repositoryId String
  name         String  @db.VarChar(100)
  commitId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  commit     Commit?    @relation("BranchCommit", fields: [commitId], references: [id], onDelete: SetNull)
  commits    Commit[]   @relation("BranchCommits")
  files      File[]

  @@unique([repositoryId, name])
  @@index([commitId])
  @@map("branches")
}

model Commit {
  id           String  @id @default(cuid())
  repositoryId String
  branchId     String
  authorId     String
  message      String  @db.Text
  hash         String  @default(cuid()) @db.VarChar(64)
  parentHash   String? @db.VarChar(64)

  createdAt DateTime @default(now())

  // å…³ç³»
  repository  Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  branch      Branch     @relation("BranchCommits", fields: [branchId], references: [id], onDelete: Cascade)
  author      User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  files       File[]
  branchHeads Branch[]   @relation("BranchCommit")

  @@index([repositoryId])
  @@index([branchId])
  @@index([authorId])
  @@index([hash])
  @@index([createdAt])
  // æ€§èƒ½ä¼˜åŒ–ç´¢å¼• - æå‡é«˜é¢‘æŸ¥è¯¢æ•ˆç‡
  @@index([branchId, createdAt(sort: Desc)]) // ä¼˜åŒ–æäº¤å†å²æŸ¥è¯¢ï¼ˆåˆ†æ”¯çš„æäº¤è®°å½•é™åºæ’åˆ—ï¼‰
  @@index([repositoryId, createdAt]) // ä¼˜åŒ–ä»“åº“æäº¤ç»Ÿè®¡ï¼ˆå¦‚ "ä»“åº“çš„æœ€è¿‘æäº¤"ï¼‰
  @@map("commits")
}

model File {
  id           String  @id @default(cuid())
  repositoryId String
  branchId     String
  commitId     String?
  path         String  @db.VarChar(500)
  objectName   String  @db.VarChar(1000) // MinIOå¯¹è±¡åç§°
  size         Int
  mimeType     String  @db.VarChar(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  branch     Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  commit     Commit?    @relation(fields: [commitId], references: [id], onDelete: SetNull)

  // Code Searchç´¢å¼•å…ƒæ•°æ®ï¼ˆå¯é€‰å…³ç³»ï¼‰
  searchMetadata SearchMetadata?

  @@unique([repositoryId, branchId, path])
  @@index([branchId])
  @@index([commitId])
  @@index([path])
  // æ€§èƒ½ä¼˜åŒ–ç´¢å¼• - æå‡é«˜é¢‘æŸ¥è¯¢æ•ˆç‡
  @@index([repositoryId, branchId, createdAt]) // ä¼˜åŒ–æ–‡ä»¶æ—¶é—´çº¿æŸ¥è¯¢ï¼ˆå¦‚ "ä»“åº“ç‰¹å®šåˆ†æ”¯çš„æœ€è¿‘æ–‡ä»¶å˜æ›´"ï¼‰
  @@map("files")
}

// ============================================
// Code Search æ¨¡å—
// ============================================

model SearchMetadata {
  id           String @id @default(cuid())
  fileId       String @unique // å…³è”åˆ°Fileè¡¨
  projectId    String
  repositoryId String

  // ç´¢å¼•çŠ¶æ€
  status        IndexStatus @default(PENDING)
  indexedAt     DateTime? // ä¸Šæ¬¡ç´¢å¼•æ—¶é—´
  failureReason String?     @db.Text // å¤±è´¥åŸå› 
  retryCount    Int         @default(0) // é‡è¯•æ¬¡æ•°

  // æ–‡ä»¶å¿«ç…§ï¼ˆç”¨äºæ£€æµ‹å˜åŒ–ï¼‰
  lastCommitId String? @db.VarChar(64)
  contentHash  String? @db.VarChar(64) // SHA256 hash

  // ç´¢å¼•ç»Ÿè®¡
  symbolCount Int @default(0) // ä»£ç ç¬¦å·æ•°é‡
  lineCount   Int @default(0) // æ€»è¡Œæ•°

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  file       File       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([repositoryId])
  @@index([status])
  @@index([indexedAt])
  @@map("search_metadata")
}

// ============================================
// Raft åˆ†å¸ƒå¼å…±è¯†æ¨¡å—
// ============================================

model RaftLog {
  id        String @id @default(cuid())
  index     Int    @unique
  term      Int
  command   String @db.Text
  timestamp BigInt

  createdAt DateTime @default(now())

  @@index([index])
  @@index([term])
  @@index([createdAt])
  @@map("raft_logs")
}

model RaftState {
  id          String        @id @default(cuid())
  nodeId      String        @unique @db.VarChar(50)
  currentTerm Int           @default(0)
  votedFor    String?       @db.VarChar(50)
  state       RaftNodeState @default(FOLLOWER)
  leaderId    String?       @db.VarChar(50)
  commitIndex Int           @default(0)
  lastApplied Int           @default(0)

  updatedAt DateTime @updatedAt

  @@index([nodeId])
  @@map("raft_state")
}

// ============================================
// é¡¹ç›®æ–‡ä»¶ç®¡ç†æ¨¡å—
// ============================================

model ProjectFile {
  id         String  @id @default(cuid())
  projectId  String
  name       String  @db.VarChar(255)
  path       String  @db.VarChar(1000) // MinIOä¸­çš„å¯¹è±¡è·¯å¾„
  size       Int
  mimeType   String  @db.VarChar(100)
  type       String  @db.VarChar(10) // 'file' or 'folder'
  folder     String? @db.VarChar(500) // æ‰€å±æ–‡ä»¶å¤¹è·¯å¾„
  uploadedBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([uploadedBy])
  @@index([folder])
  @@index([type])
  @@map("project_files")
}

// ============================================
// Issue è¿½è¸ªç³»ç»Ÿæ¨¡å—
// ============================================

model Issue {
  id        String     @id @default(cuid())
  projectId String
  number    Int // é¡¹ç›®å†…å”¯ä¸€ç¼–å·ï¼ˆè‡ªå¢ï¼‰
  title     String     @db.VarChar(500)
  body      String?    @db.Text
  state     IssueState @default(OPEN)
  authorId  String

  // ğŸ”’ REFACTOR: ä½¿ç”¨å…³è”è¡¨æ›¿ä»£æ•°ç»„å­—æ®µï¼ˆç¬¦åˆå…³ç³»å‹æ•°æ®åº“èŒƒå¼ï¼‰
  // âŒ æ—§å®ç°: assigneeIds String[], labelIds String[]
  // âœ… æ–°å®ç°: assignees IssueAssignee[], labels IssueLabel[]
  milestoneId String?

  closedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // å…³ç³»
  project   Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author    User            @relation("IssueAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  milestone Milestone?      @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  assignees IssueAssignee[] // ğŸ”’ è¢«åˆ†é…äººå…³è”è¡¨
  labels    IssueLabel[] // ğŸ”’ æ ‡ç­¾å…³è”è¡¨
  comments  IssueComment[]
  events    IssueEvent[]

  @@unique([projectId, number])
  @@index([authorId])
  @@index([state])
  @@index([milestoneId])
  @@index([createdAt])
  // æ€§èƒ½ä¼˜åŒ–ç´¢å¼• - æå‡é«˜é¢‘æŸ¥è¯¢æ•ˆç‡
  @@index([projectId, state, createdAt]) // ä¼˜åŒ–çŠ¶æ€è¿‡æ»¤+æ—¶é—´æ’åºï¼ˆå¦‚ "é¡¹ç›®çš„å¼€æ”¾IssueæŒ‰æ—¶é—´æ’åº"ï¼‰
  @@index([projectId, milestoneId]) // ä¼˜åŒ–é‡Œç¨‹ç¢‘è¿‡æ»¤ï¼ˆå¦‚ "é¡¹ç›®çš„ç‰¹å®šé‡Œç¨‹ç¢‘ä¸‹çš„Issue"ï¼‰
  @@index([projectId, number]) // ä¼˜åŒ–æŒ‰ç¼–å·æŸ¥è¯¢ï¼ˆè¡¥å……uniqueç´¢å¼•ï¼Œæå‡ç‰¹å®šæŸ¥è¯¢åœºæ™¯ï¼‰
  @@map("issues")
}

model Label {
  id          String  @id @default(cuid())
  projectId   String
  name        String  @db.VarChar(50)
  color       String  @db.VarChar(7) // Hex color (#RRGGBB)
  description String? @db.VarChar(200)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issueLabels IssueLabel[] // ğŸ”’ æ ‡ç­¾å…³è”è¡¨

  @@unique([projectId, name])
  @@map("labels")
}

// ğŸ”’ REFACTOR: Issue æ ‡ç­¾å…³è”è¡¨ï¼ˆæ›¿ä»£ labelIds String[]ï¼‰
// ECP-A1: SOLID åŸåˆ™ - ç¬¦åˆå…³ç³»å‹æ•°æ®åº“è®¾è®¡èŒƒå¼
// ECP-C3: Performance Awareness - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Œæ¶ˆé™¤ N+1 æŸ¥è¯¢é£é™©
model IssueLabel {
  id        String   @id @default(cuid())
  issueId   String
  labelId   String
  createdAt DateTime @default(now())

  // å…³ç³»
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([issueId, labelId]) // é˜²æ­¢é‡å¤æ ‡ç­¾
  @@index([labelId]) // æŸ¥è¯¢æ ‡ç­¾çš„æ‰€æœ‰Issue
  @@index([issueId]) // æŸ¥è¯¢Issueçš„æ‰€æœ‰æ ‡ç­¾
  @@map("issue_labels")
}

model Milestone {
  id          String         @id @default(cuid())
  projectId   String
  title       String         @db.VarChar(200)
  description String?        @db.Text
  dueDate     DateTime?
  state       MilestoneState @default(OPEN)
  closedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues  Issue[]

  @@unique([projectId, title])
  @@index([state])
  @@index([dueDate])
  @@map("milestones")
}

model IssueComment {
  id       String @id @default(cuid())
  issueId  String
  authorId String
  body     String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  issue  Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author User  @relation("IssueCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([authorId])
  @@index([createdAt])
  @@map("issue_comments")
}

// ğŸ”’ REFACTOR: Issue è¢«åˆ†é…äººå…³è”è¡¨ï¼ˆæ›¿ä»£ assigneeIds String[]ï¼‰
// ECP-A1: SOLID åŸåˆ™ - ç¬¦åˆå…³ç³»å‹æ•°æ®åº“è®¾è®¡èŒƒå¼
model IssueAssignee {
  id         String   @id @default(cuid())
  issueId    String
  userId     String
  assignedAt DateTime @default(now())

  // å…³ç³»
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User  @relation("IssueAssignees", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([issueId, userId]) // é˜²æ­¢é‡å¤åˆ†é…
  @@index([userId]) // æŸ¥è¯¢ç”¨æˆ·è¢«åˆ†é…çš„æ‰€æœ‰Issue
  @@index([issueId]) // æŸ¥è¯¢Issueçš„æ‰€æœ‰è¢«åˆ†é…äºº
  @@map("issue_assignees")
}

model IssueEvent {
  id       String @id @default(cuid())
  issueId  String
  actorId  String
  event    String @db.VarChar(50) // äº‹ä»¶ç±»å‹ï¼šopened, closed, reopened, assigned, labeled, etc.
  metadata Json? // äº‹ä»¶ç›¸å…³å…ƒæ•°æ®

  createdAt DateTime @default(now())

  // å…³ç³»
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  actor User  @relation("IssueEventActor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([actorId])
  @@index([event])
  @@index([createdAt])
  @@map("issue_events")
}

// ============================================
// Pull Request ç³»ç»Ÿæ¨¡å—
// ============================================

model PullRequest {
  id           String  @id @default(cuid())
  projectId    String
  number       Int // é¡¹ç›®å†…å”¯ä¸€ç¼–å·ï¼ˆè‡ªå¢ï¼‰
  title        String  @db.VarChar(500)
  body         String? @db.Text
  sourceBranch String  @db.VarChar(100)
  targetBranch String  @db.VarChar(100)
  state        PRState @default(OPEN)
  authorId     String

  // åˆå¹¶ç›¸å…³
  mergedAt      DateTime?
  mergedBy      String?
  mergeCommit   String?        @db.VarChar(64) // åˆå¹¶åç”Ÿæˆçš„ commit hash
  mergeStrategy MergeStrategy? // ä½¿ç”¨çš„åˆå¹¶ç­–ç•¥

  closedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // å…³ç³»
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author    User         @relation("PRAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  merger    User?        @relation("PRMerger", fields: [mergedBy], references: [id], onDelete: SetNull)
  assignees PRAssignee[] // ğŸ”’ æ–°å¢: è¢«åˆ†é…äººå…³è”è¡¨
  reviews   PRReview[]
  comments  PRComment[]
  events    PREvent[]

  @@unique([projectId, number])
  @@index([projectId])
  @@index([authorId])
  @@index([state])
  @@index([createdAt])
  // æ€§èƒ½ä¼˜åŒ–ç´¢å¼• - æå‡é«˜é¢‘æŸ¥è¯¢æ•ˆç‡
  @@index([projectId, state, createdAt]) // ä¼˜åŒ–PRåˆ—è¡¨æŸ¥è¯¢ï¼ˆå¦‚ "é¡¹ç›®çš„å¼€æ”¾PRæŒ‰æ—¶é—´æ’åº"ï¼‰
  @@index([authorId, state]) // ä¼˜åŒ–ç”¨æˆ·PRæŸ¥è¯¢ï¼ˆå¦‚ "ç”¨æˆ·çš„å¼€æ”¾PR"ï¼‰
  @@index([projectId, number]) // ä¼˜åŒ–æŒ‰ç¼–å·æŸ¥è¯¢ï¼ˆè¡¥å……uniqueç´¢å¼•ï¼‰
  @@map("pull_requests")
}

// ğŸ”’ REFACTOR: PR è¢«åˆ†é…äººå…³è”è¡¨
// ECP-A1: SOLID åŸåˆ™ - ç¬¦åˆå…³ç³»å‹æ•°æ®åº“è®¾è®¡èŒƒå¼
model PRAssignee {
  id            String   @id @default(cuid())
  pullRequestId String
  userId        String
  assignedAt    DateTime @default(now())

  // å…³ç³»
  pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  user        User        @relation("PRAssignees", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pullRequestId, userId]) // é˜²æ­¢é‡å¤åˆ†é…
  @@index([userId]) // æŸ¥è¯¢ç”¨æˆ·è¢«åˆ†é…çš„æ‰€æœ‰PR
  @@index([pullRequestId]) // æŸ¥è¯¢PRçš„æ‰€æœ‰è¢«åˆ†é…äºº
  @@map("pr_assignees")
}

model PRReview {
  id            String      @id @default(cuid())
  pullRequestId String
  reviewerId    String
  state         ReviewState
  body          String?     @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  reviewer    User        @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([reviewerId])
  @@index([state])
  @@map("pr_reviews")
}

model PRComment {
  id            String  @id @default(cuid())
  pullRequestId String
  authorId      String
  body          String  @db.Text
  filePath      String? @db.VarChar(500) // For line-level comments
  lineNumber    Int? // For line-level comments
  commitHash    String? @db.VarChar(64) // é”å®šåˆ°ç‰¹å®š commitï¼Œé˜²æ­¢ diff å˜åŒ–åè¡Œå·é”™ä½

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  author      User        @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([authorId])
  @@index([createdAt])
  @@map("pr_comments")
}

model PREvent {
  id            String @id @default(cuid())
  pullRequestId String
  actorId       String
  event         String @db.VarChar(50) // äº‹ä»¶ç±»å‹ï¼šopened, closed, merged, reviewed, etc.
  metadata      Json? // äº‹ä»¶ç›¸å…³å…ƒæ•°æ®

  createdAt DateTime @default(now())

  // å…³ç³»
  pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  actor       User        @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([actorId])
  @@index([event])
  @@index([createdAt])
  @@map("pr_events")
}

// ============================================
// é€šçŸ¥ç³»ç»Ÿæ¨¡å—
// ============================================

/**
 * é€šçŸ¥ç±»å‹æšä¸¾
 * æ”¯æŒçš„é€šçŸ¥åœºæ™¯ï¼š
 * - Pull Requestç›¸å…³ï¼šåˆ›å»ºã€åˆå¹¶ã€å…³é—­ã€å®¡æŸ¥ã€è¯„è®º
 * - Issueç›¸å…³ï¼šæåŠã€åˆ†é…ã€è¯„è®º
 */
enum NotificationType {
  PR_CREATED // PRè¢«åˆ›å»º
  PR_MERGED // PRè¢«åˆå¹¶
  PR_CLOSED // PRè¢«å…³é—­
  PR_REVIEWED // PRè¢«å®¡æŸ¥
  PR_COMMENTED // PRè¢«è¯„è®º
  ISSUE_MENTIONED // åœ¨Issueä¸­è¢«æåŠ
  ISSUE_ASSIGNED // è¢«åˆ†é…åˆ°Issue
  ISSUE_COMMENTED // Issueè¢«è¯„è®º
}

/**
 * é€šçŸ¥è¡¨
 * å­˜å‚¨æ‰€æœ‰ç”¨æˆ·é€šçŸ¥è®°å½•
 * ECP-C3: Performance Awareness - æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
 * - userId: æŒ‰ç”¨æˆ·æŸ¥è¯¢æœªè¯»é€šçŸ¥
 * - read: å¿«é€Ÿè¿‡æ»¤å·²è¯»/æœªè¯»
 * - createdAt: æ—¶é—´æ’åº
 */
model Notification {
  id       String           @id @default(cuid())
  userId   String // é€šçŸ¥æ¥æ”¶è€…
  type     NotificationType // é€šçŸ¥ç±»å‹
  title    String           @db.VarChar(200) // é€šçŸ¥æ ‡é¢˜
  body     String?          @db.Text // é€šçŸ¥å†…å®¹ï¼ˆæ”¯æŒMarkdownï¼‰
  read     Boolean          @default(false) // æ˜¯å¦å·²è¯»
  link     String?          @db.VarChar(500) // ç›¸å…³èµ„æºé“¾æ¥ï¼ˆå¦‚PRè¯¦æƒ…é¡µï¼‰
  metadata Json? // é¢å¤–å…ƒæ•°æ®ï¼ˆPR IDã€Issue IDã€è¯„è®ºå†…å®¹ç­‰ï¼‰

  createdAt DateTime @default(now())

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  // æ€§èƒ½ä¼˜åŒ–ç´¢å¼• - æå‡é«˜é¢‘æŸ¥è¯¢æ•ˆç‡
  @@index([userId, read, createdAt]) // ä¼˜åŒ–æœªè¯»é€šçŸ¥æŸ¥è¯¢+æ—¶é—´æ’åºï¼ˆå¦‚ "ç”¨æˆ·çš„æœªè¯»é€šçŸ¥æŒ‰æ—¶é—´æ’åº"ï¼‰
  @@map("notifications")
}

/**
 * é€šçŸ¥åå¥½è®¾ç½®è¡¨
 * ç”¨æˆ·å¯è‡ªå®šä¹‰æ¥æ”¶å“ªäº›ç±»å‹çš„é€šçŸ¥
 * ECP-A1: SOLID - å•ä¸€èŒè´£åŸåˆ™
 * - æ¯ä¸ªç”¨æˆ·ä¸€æ¡é…ç½®è®°å½•ï¼ˆ1:1å…³ç³»ï¼‰
 */
model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique // ç”¨æˆ·IDï¼ˆå”¯ä¸€ï¼‰

  // PRé€šçŸ¥å¼€å…³
  prCreated   Boolean @default(true) // PRåˆ›å»ºé€šçŸ¥
  prMerged    Boolean @default(true) // PRåˆå¹¶é€šçŸ¥
  prReviewed  Boolean @default(true) // PRå®¡æŸ¥é€šçŸ¥
  prCommented Boolean @default(true) // PRè¯„è®ºé€šçŸ¥

  // Issueé€šçŸ¥å¼€å…³
  issueMentioned Boolean @default(true) // IssueæåŠé€šçŸ¥
  issueAssigned  Boolean @default(true) // Issueåˆ†é…é€šçŸ¥
  issueCommented Boolean @default(true) // Issueè¯„è®ºé€šçŸ¥

  // é‚®ä»¶é€šçŸ¥ï¼ˆæš‚æœªå®ç°ï¼Œé¢„ç•™å­—æ®µï¼‰
  emailNotifications Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ============================================
// åˆ†æ”¯ä¿æŠ¤è§„åˆ™æ¨¡å—
// ============================================

/**
 * åˆ†æ”¯ä¿æŠ¤è§„åˆ™è¡¨
 * ä¸ºé¡¹ç›®çš„ç‰¹å®šåˆ†æ”¯é…ç½®ä¿æŠ¤ç­–ç•¥ï¼Œé˜²æ­¢æœªç»å®¡æ ¸çš„ä»£ç åˆå¹¶
 * MVPåŠŸèƒ½ï¼š
 * - è¦æ±‚PRå®¡æ ¸æ‰èƒ½åˆå¹¶
 * - è®¾ç½®æœ€å°‘å®¡æ ¸äººæ•°
 * - ç¦æ­¢ç›´æ¥æ¨é€åˆ°ä¿æŠ¤åˆ†æ”¯
 * åç»­æ‰©å±•ï¼š
 * - åˆ†æ”¯æ¨¡å¼åŒ¹é…ï¼ˆé€šé…ç¬¦æ”¯æŒï¼‰
 * - CI/CDçŠ¶æ€æ£€æŸ¥é›†æˆ
 * - Code Ownerå®¡æŸ¥è¦æ±‚
 */
model BranchProtectionRule {
  id        String @id @default(cuid())
  projectId String

  // ä¿æŠ¤çš„åˆ†æ”¯åç§°ï¼ˆMVP: ç²¾ç¡®åŒ¹é…ï¼Œå¦‚ "main", "develop"ï¼‰
  branchPattern String @db.VarChar(100)

  // æ ¸å¿ƒä¿æŠ¤è§„åˆ™
  requirePullRequest       Boolean @default(true) // å¿…é¡»é€šè¿‡PRä¿®æ”¹ï¼ˆä¸èƒ½ç›´æ¥pushï¼‰
  requiredApprovingReviews Int     @default(1) // æœ€å°‘æ‰¹å‡†å®¡æ ¸æ•°é‡
  dismissStaleReviews      Boolean @default(false) // æ–°æäº¤åä½œåºŸæ—§å®¡æŸ¥
  requireCodeOwnerReview   Boolean @default(false) // è¦æ±‚Code Ownerå®¡æŸ¥

  // é«˜çº§ä¿æŠ¤é€‰é¡¹
  allowForcePushes Boolean @default(false) // å…è®¸å¼ºåˆ¶æ¨é€ï¼ˆå±é™©æ“ä½œï¼‰
  allowDeletions   Boolean @default(false) // å…è®¸åˆ é™¤ä¿æŠ¤åˆ†æ”¯

  // çŠ¶æ€æ£€æŸ¥ï¼ˆCI/CDé›†æˆï¼ŒPhase 2åŠŸèƒ½ï¼Œæš‚æ—¶ä¿ç•™å­—æ®µï¼‰
  requireStatusChecks  Boolean  @default(false) // è¦æ±‚çŠ¶æ€æ£€æŸ¥é€šè¿‡
  requiredStatusChecks String[] // å¿…é¡»é€šè¿‡çš„æ£€æŸ¥é¡¹ ["ci", "tests", "build"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, branchPattern]) // æ¯ä¸ªé¡¹ç›®çš„æ¯ä¸ªåˆ†æ”¯åªèƒ½æœ‰ä¸€æ¡ä¿æŠ¤è§„åˆ™
  @@index([projectId])
  @@map("branch_protection_rules")
}

// ============================================
// å®‰å…¨å®¡è®¡æ—¥å¿—æ¨¡å—
// ============================================

/**
 * å®‰å…¨å®¡è®¡æ—¥å¿—è¡¨
 * Phase 4: è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œå’Œå®‰å…¨äº‹ä»¶ï¼Œç”¨äºåˆè§„å®¡è®¡å’Œå®‰å…¨åˆ†æ
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - è®°å½•ç”¨æˆ·æ“ä½œï¼ˆç™»å½•ã€æƒé™å˜æ›´ã€æ•æ„Ÿæ•°æ®è®¿é—®ï¼‰
 * - è®°å½•èµ„æºå˜æ›´ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰
 * - è®°å½•å®¡è®¡è¿½è¸ªï¼ˆè°ã€ä»€ä¹ˆæ—¶é—´ã€åšäº†ä»€ä¹ˆã€ç»“æœå¦‚ä½•ï¼‰
 * - æ”¯æŒ IP åœ°å€å’Œ User-Agent è¿½è¸ª
 * åˆè§„è¦æ±‚ï¼š
 * - SOC2: å®¡è®¡æ—¥å¿—ä¿ç•™è‡³å°‘90å¤©
 * - ISO27001: è®°å½•å®‰å…¨ç›¸å…³äº‹ä»¶
 * - GDPR: è®°å½•ä¸ªäººæ•°æ®è®¿é—®
 */
model AuditLog {
  id String @id @default(cuid())

  // æ“ä½œä¿¡æ¯
  action     AuditAction     @default(ACCESS) // æ“ä½œç±»å‹
  entityType AuditEntityType // å®ä½“ç±»å‹
  entityId   String?         @db.VarChar(100) // å®ä½“ IDï¼ˆå¯é€‰ï¼Œå¦‚ç™»å½•æ“ä½œæ— å®ä½“ï¼‰

  // æ“ä½œè€…ä¿¡æ¯
  userId    String? @db.VarChar(100) // æ“ä½œç”¨æˆ· IDï¼ˆç³»ç»Ÿæ“ä½œå¯ä¸º nullï¼‰
  username  String? @db.VarChar(50) // æ“ä½œç”¨æˆ·åï¼ˆå†—ä½™ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
  ipAddress String? @db.VarChar(45) // IP åœ°å€ï¼ˆIPv4/IPv6ï¼‰
  userAgent String? @db.Text // User-Agent

  // æ“ä½œè¯¦æƒ…
  description String  @db.Text // æ“ä½œæè¿°ï¼ˆäººç±»å¯è¯»ï¼‰
  metadata    Json? // é¢å¤–å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
  success     Boolean @default(true) // æ“ä½œæ˜¯å¦æˆåŠŸ
  errorMsg    String? @db.Text // å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯

  // æ—¶é—´æˆ³
  createdAt DateTime @default(now())

  // å…³ç³»ï¼ˆå¯é€‰ï¼Œç”¨äºçº§è”åˆ é™¤ï¼‰
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // ç´¢å¼•ä¼˜åŒ–
  @@index([userId]) // æŒ‰ç”¨æˆ·æŸ¥è¯¢å®¡è®¡æ—¥å¿—
  @@index([action]) // æŒ‰æ“ä½œç±»å‹æŸ¥è¯¢
  @@index([entityType]) // æŒ‰å®ä½“ç±»å‹æŸ¥è¯¢
  @@index([createdAt]) // æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
  @@index([success]) // æŸ¥è¯¢å¤±è´¥æ“ä½œ
  @@index([userId, createdAt]) // å¤åˆç´¢å¼•ï¼šç”¨æˆ·çš„æ—¶é—´çº¿
  @@map("audit_logs")
}

// ============================================
// API Token æ¨¡å—ï¼ˆPersonal Access Tokenï¼‰
// ============================================

/**
 * API Token è¡¨
 * ç”¨æˆ·å¯åˆ›å»ºå¤šä¸ª API ä»¤ç‰Œç”¨äºç¨‹åºåŒ–è®¿é—® API
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - æ”¯æŒå¤šä¸ªä»¤ç‰Œï¼ˆæ¯ä¸ªä»¤ç‰Œæœ‰ç‹¬ç«‹åç§°ï¼‰
 * - ä½œç”¨åŸŸæ§åˆ¶ï¼ˆread, write, adminï¼‰
 * - å¯é€‰è¿‡æœŸæ—¶é—´
 * - SHA256 å“ˆå¸Œå­˜å‚¨ï¼ˆå®‰å…¨æ€§ï¼‰
 * - ä»¤ç‰Œåªåœ¨åˆ›å»ºæ—¶æ˜¾ç¤ºä¸€æ¬¡
 * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - ä»¤ç‰Œå“ˆå¸Œå­˜å‚¨ï¼Œä¸å¯é€†
 * ECP-C2: ç³»ç»ŸåŒ–é”™è¯¯å¤„ç† - è¿‡æœŸéªŒè¯ã€ä½œç”¨åŸŸéªŒè¯
 */
model ApiToken {
  id          String    @id @default(cuid())
  userId      String
  name        String    @db.VarChar(100) // ä»¤ç‰Œåç§°ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰
  tokenHash   String    @unique @db.VarChar(64) // SHA256 hash (64 hex chars)
  tokenPrefix String    @db.VarChar(8) // å‰8å­—ç¬¦ç”¨äºè¯†åˆ«
  scopes      String[] // ä½œç”¨åŸŸï¼š["read", "write", "admin"]
  expiresAt   DateTime? // å¯é€‰è¿‡æœŸæ—¶é—´
  lastUsedAt  DateTime? // æœ€åä½¿ç”¨æ—¶é—´
  createdAt   DateTime  @default(now())

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ä»¤ç‰Œ
  @@index([tokenHash]) // å¿«é€ŸéªŒè¯ä»¤ç‰Œ
  @@index([expiresAt]) // å®šæœŸæ¸…ç†è¿‡æœŸä»¤ç‰Œ
  @@index([userId, createdAt(sort: Desc)]) // ä¼˜åŒ–ç”¨æˆ·ä»¤ç‰Œåˆ—è¡¨æŸ¥è¯¢
  @@map("api_tokens")
}

// ============================================
// Newsletter æ¨¡å—
// ============================================

/**
 * Newsletter è®¢é˜…è€…è¡¨
 * ç”¨äºè¥é”€ç½‘ç«™çš„Newsletterè®¢é˜…åŠŸèƒ½
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - é‚®ç®±è®¢é˜…
 * - åŒé‡ç¡®è®¤ï¼ˆå‘é€ç¡®è®¤é‚®ä»¶ï¼‰
 * - å–æ¶ˆè®¢é˜…
 * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - é‚®ç®±å”¯ä¸€æ€§ã€ç¡®è®¤tokenå®‰å…¨
 */
model NewsletterSubscriber {
  id           String    @id @default(cuid())
  email        String    @unique @db.VarChar(255) // è®¢é˜…é‚®ç®±
  confirmToken String    @unique @db.VarChar(64) // ç¡®è®¤tokenï¼ˆSHA256ï¼‰
  confirmed    Boolean   @default(false) // æ˜¯å¦å·²ç¡®è®¤
  confirmedAt  DateTime? // ç¡®è®¤æ—¶é—´
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([email]) // å¿«é€ŸæŸ¥è¯¢é‚®ç®±
  @@index([confirmed]) // æŸ¥è¯¢å·²ç¡®è®¤/æœªç¡®è®¤è®¢é˜…
  @@index([createdAt(sort: Desc)]) // æŒ‰æ—¶é—´æ’åº
  @@map("newsletter_subscribers")
}

// ============================================
// Wiki æ–‡æ¡£æ¨¡å—
// ============================================

/**
 * Wiki é¡µé¢æ¨¡å‹
 * æ”¯æŒå±‚çº§ç»“æ„ã€ç‰ˆæœ¬å†å²ã€Markdown å†…å®¹
 * ECP-A1: SOLID - æ¸…æ™°çš„æ•°æ®æ¨¡å‹ç»“æ„
 * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - slug å”¯ä¸€æ€§çº¦æŸ
 */
model WikiPage {
  id    String @id @default(cuid())
  slug  String @db.VarChar(200) // URL å‹å¥½æ ‡è¯†ç¬¦
  title String @db.VarChar(500) // é¡µé¢æ ‡é¢˜
  content String @db.Text // Markdown å†…å®¹
  order Int    @default(0) // åŒçº§æ’åº

  // æ‰€å±é¡¹ç›®
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // å±‚çº§ç»“æ„ï¼ˆè‡ªå¼•ç”¨ï¼‰
  parentId String?
  parent   WikiPage?  @relation("WikiPageHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children WikiPage[] @relation("WikiPageHierarchy")

  // ä½œè€…å’Œç¼–è¾‘è€…
  createdById    String
  createdBy      User   @relation("WikiPageCreator", fields: [createdById], references: [id], onDelete: Restrict)
  lastEditedById String
  lastEditedBy   User   @relation("WikiPageEditor", fields: [lastEditedById], references: [id], onDelete: Restrict)

  // æ—¶é—´æˆ³
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ç‰ˆæœ¬å†å²
  history WikiPageHistory[]

  @@unique([projectId, slug]) // é¡¹ç›®å†… slug å”¯ä¸€
  @@index([projectId]) // æŒ‰é¡¹ç›®æŸ¥è¯¢
  @@index([parentId]) // æ ‘å½¢ç»“æ„æŸ¥è¯¢
  @@index([order]) // æ’åºæŸ¥è¯¢
  @@map("wiki_pages")
}

/**
 * Wiki é¡µé¢å†å²è®°å½•æ¨¡å‹
 * ä¿å­˜æ¯æ¬¡ç¼–è¾‘çš„å†å²ç‰ˆæœ¬
 * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - å®Œæ•´çš„ç‰ˆæœ¬è¿½æº¯
 */
model WikiPageHistory {
  id       String @id @default(cuid())
  pageId   String // æ‰€å±é¡µé¢
  page     WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  title    String @db.VarChar(500) // å†å²ç‰ˆæœ¬æ ‡é¢˜
  content  String @db.Text // å†å²ç‰ˆæœ¬å†…å®¹
  version  Int // ç‰ˆæœ¬å·ï¼ˆé€’å¢ï¼‰

  // ç¼–è¾‘è€…
  editedById String
  editedBy   User   @relation("WikiHistoryEditor", fields: [editedById], references: [id], onDelete: Restrict)

  // ç¼–è¾‘æ—¶é—´
  editedAt DateTime @default(now())

  @@index([pageId, version]) // æŸ¥è¯¢ç‰¹å®šç‰ˆæœ¬
  @@index([editedAt(sort: Desc)]) // æŒ‰æ—¶é—´æ’åº
  @@map("wiki_page_history")
}

// ============================================
// OAuth é›†æˆæ¨¡å—
// ============================================

/**
 * OAuth è´¦æˆ·å…³è”è¡¨
 * æ”¯æŒç¬¬ä¸‰æ–¹ OAuth ç™»å½•ï¼ˆGitHubã€Google ç­‰ï¼‰
 * ECP-C1: é˜²å¾¡æ€§ç¼–ç¨‹ - ä»¤ç‰ŒåŠ å¯†å­˜å‚¨
 */
model OAuthAccount {
  id           String   @id @default(cuid())
  userId       String
  provider     String   @db.VarChar(50) // github, google, etc.
  providerId   String   @db.VarChar(255) // OAuth provider's user ID
  email        String?  @db.VarChar(255)
  displayName  String?  @db.VarChar(255)
  accessToken  String?  @db.Text
  refreshToken String?  @db.Text
  expiresAt    DateTime?
  scope        String?  @db.Text
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider])
  @@index([email])
  @@map("oauth_accounts")
}

// ============================================
// CI/CD Pipeline æ¨¡å—
// ============================================

enum PipelineStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILURE
  CANCELLED
}

/**
 * Pipeline é…ç½®è¡¨
 * å®šä¹‰ CI/CD æµæ°´çº¿é…ç½®
 */
model Pipeline {
  id        String   @id @default(cuid())
  projectId String
  name      String   @db.VarChar(100)
  config    Json // YAML/JSON é…ç½®
  triggers  String[] // push, pull_request, schedule
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  runs    PipelineRun[]

  @@unique([projectId, name])
  @@index([projectId])
  @@index([active])
  @@map("pipelines")
}

/**
 * Pipeline è¿è¡Œè®°å½•è¡¨
 * è®°å½•æ¯æ¬¡æµæ°´çº¿æ‰§è¡Œæƒ…å†µ
 */
model PipelineRun {
  id         String         @id @default(cuid())
  pipelineId String
  commitSha  String         @db.VarChar(64)
  branch     String         @db.VarChar(100)
  status     PipelineStatus @default(PENDING)
  startedAt  DateTime       @default(now())
  finishedAt DateTime?
  duration   Int? // milliseconds
  logs       String?        @db.Text
  metadata   Json?

  // å…³ç³»
  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@index([pipelineId])
  @@index([status])
  @@index([commitSha])
  @@index([startedAt])
  @@index([pipelineId, startedAt(sort: Desc)])
  @@map("pipeline_runs")
}

// ============================================
// Webhook æ¨¡å—
// ============================================

/**
 * Webhook é…ç½®è¡¨
 * æ”¯æŒäº‹ä»¶æ¨é€åˆ°å¤–éƒ¨ URL
 */
model Webhook {
  id        String   @id @default(cuid())
  projectId String
  url       String   @db.VarChar(500)
  secret    String   @db.VarChar(255) // HMAC ç­¾åå¯†é’¥
  events    String[] // push, pull_request.opened, issue.closed
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([projectId])
  @@index([active])
  @@map("webhooks")
}

/**
 * Webhook æŠ•é€’è®°å½•è¡¨
 * è®°å½•æ¯æ¬¡ Webhook å‘é€ç»“æœ
 */
model WebhookDelivery {
  id             String   @id @default(cuid())
  webhookId      String
  event          String   @db.VarChar(100)
  payload        Json
  requestHeaders Json?
  response       Json?
  statusCode     Int?
  success        Boolean  @default(false)
  retryCount     Int      @default(0)
  deliveredAt    DateTime @default(now())

  // å…³ç³»
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([event])
  @@index([success])
  @@index([deliveredAt(sort: Desc)])
  @@map("webhook_deliveries")
}

// ============================================
// Two-Factor Authentication æ¨¡å—
// ============================================

/**
 * ä¸¤æ­¥éªŒè¯é…ç½®è¡¨
 * æ”¯æŒTOTPï¼ˆTime-based One-Time Passwordï¼‰
 */
model TwoFactorAuth {
  id            String    @id @default(cuid())
  userId        String    @unique
  secret        String    @db.VarChar(255) // TOTP secret
  recoveryCodes String[] // æ¢å¤ä»£ç æ•°ç»„
  enabled       Boolean   @default(false)
  verifiedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("two_factor_auth")
}

// ============================================
// Real-time Collaboration æ¨¡å—
// ============================================

/**
 * åä½œä¼šè¯è¡¨
 * ç®¡ç†å®æ—¶åä½œç¼–è¾‘ä¼šè¯
 */
model CollaborationSession {
  id           String   @id @default(cuid())
  documentId   String   @db.VarChar(500) // æ–‡æ¡£IDï¼ˆæ–‡ä»¶è·¯å¾„æˆ–Wikié¡µé¢IDï¼‰
  documentType String   @db.VarChar(20) // file, wiki
  projectId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // å…³ç³»
  project      Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  participants CollaborationParticipant[]

  @@index([documentId])
  @@index([projectId])
  @@map("collaboration_sessions")
}

/**
 * åä½œå‚ä¸è€…è¡¨
 * è®°å½•æ¯ä¸ªä¼šè¯çš„å‚ä¸ç”¨æˆ·
 */
model CollaborationParticipant {
  id           String   @id @default(cuid())
  sessionId    String
  userId       String
  color        String   @db.VarChar(20) // ç”¨æˆ·å…‰æ ‡é¢œè‰²
  lastActiveAt DateTime @default(now()) // æœ€åæ´»è·ƒæ—¶é—´
  joinedAt     DateTime @default(now()) // åŠ å…¥æ—¶é—´

  // å…³ç³»
  session CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("collaboration_participants")
}

// ============================================
// GDPR Data Export æ¨¡å—
// ============================================

/**
 * æ•°æ®å¯¼å‡ºæ ¼å¼æšä¸¾
 */
enum DataExportFormat {
  JSON
  CSV
}

/**
 * æ•°æ®å¯¼å‡ºçŠ¶æ€æšä¸¾
 */
enum DataExportStatus {
  PENDING    // ç­‰å¾…å¤„ç†
  PROCESSING // å¤„ç†ä¸­
  COMPLETED  // å·²å®Œæˆ
  FAILED     // å¤±è´¥
  EXPIRED    // å·²è¿‡æœŸ
}

/**
 * æ•°æ®å¯¼å‡ºè¯·æ±‚è¡¨
 * æ”¯æŒ GDPR åˆè§„çš„ç”¨æˆ·æ•°æ®å¯¼å‡ºåŠŸèƒ½
 */
model DataExportRequest {
  id          String           @id @default(cuid())
  userId      String
  format      DataExportFormat @default(JSON)
  status      DataExportStatus @default(PENDING)
  filePath    String?          @db.VarChar(500) // MinIO å¯¹è±¡è·¯å¾„
  fileSize    Int?             // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  expiresAt   DateTime?        // è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼‰
  completedAt DateTime?        // å®Œæˆæ—¶é—´
  errorMsg    String?          @db.Text // å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([expiresAt]) // å®šæœŸæ¸…ç†è¿‡æœŸå¯¼å‡º
  @@map("data_export_requests")
}
