generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                     @id @default(cuid())
  username               String                     @unique @db.VarChar(50)
  email                  String                     @unique @db.VarChar(255)
  passwordHash           String                     @db.VarChar(255)
  avatar                 String?                    @db.VarChar(500)
  bio                    String?
  role                   UserRole                   @default(USER)
  isActive               Boolean                    @default(true)
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  emailVerified          Boolean                    @default(false)
  emailVerifyToken       String?                    @unique @db.VarChar(255)
  emailVerifyExpires     DateTime?
  passwordResetToken     String?                    @unique @db.VarChar(255)
  passwordResetExpires   DateTime?
  tokenVersion           Int                        @default(0)
  apiTokens              ApiToken[]
  auditLogs              AuditLog[]                 @relation("AuditLogUser")
  collaborationSessions  CollaborationParticipant[]
  commits                Commit[]
  dataExportRequests     DataExportRequest[]
  assignedIssues         IssueAssignee[]            @relation("IssueAssignees")
  issueComments          IssueComment[]             @relation("IssueCommentAuthor")
  issueEvents            IssueEvent[]               @relation("IssueEventActor")
  authoredIssues         Issue[]                    @relation("IssueAuthor")
  notificationPreference NotificationPreference?
  notifications          Notification[]
  oauthAccounts          OAuthAccount[]
  organizationMembers    OrganizationMember[]
  passwordHistories      PasswordHistory[]
  assignedPRs            PRAssignee[]               @relation("PRAssignees")
  prComments             PRComment[]
  prEvents               PREvent[]
  prReviews              PRReview[]
  uploadedFiles          ProjectFile[]
  projectMembers         ProjectMember[]
  ownedProjects          Project[]                  @relation("ProjectOwner")
  authoredPRs            PullRequest[]              @relation("PRAuthor")
  mergedPRs              PullRequest[]              @relation("PRMerger")
  teamMembers            TeamMember[]
  twoFactorAuth          TwoFactorAuth?
  sessions               UserSession[]
  createdWikiPages       WikiPage[]                 @relation("WikiPageCreator")
  editedWikiPages        WikiPage[]                 @relation("WikiPageEditor")
  editedWikiPageHistory  WikiPageHistory[]          @relation("WikiPageHistoryEditor")

  @@index([email])
  @@index([username])
  @@map("users")
}

model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String   @db.VarChar(255)
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_histories")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  ipAddress    String   @db.VarChar(45)
  userAgent    String
  device       String?  @db.VarChar(100)
  browser      String?  @db.VarChar(100)
  os           String?  @db.VarChar(100)
  location     String?  @db.VarChar(200)
  tokenVersion Int
  isActive     Boolean  @default(true)
  lastUsedAt   DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@map("user_sessions")
}

model Organization {
  id           String               @id @default(cuid())
  name         String               @db.VarChar(100)
  slug         String               @unique @db.VarChar(100)
  description  String?
  avatar       String?              @db.VarChar(500)
  website      String?              @db.VarChar(500)
  maxProjects  Int                  @default(1000)
  maxMembers   Int                  @default(1000)
  storageQuota BigInt               @default(107374182400)
  storageUsed  BigInt               @default(0)
  isPersonal   Boolean              @default(false)
  deletedAt    DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  members      OrganizationMember[]
  projects     Project[]
  teams        Team[]

  @@index([slug])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole      @default(MEMBER)
  joinedAt       DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([role])
  @@map("organization_members")
}

model Team {
  id                 String                  @id @default(cuid())
  organizationId     String
  name               String                  @db.VarChar(100)
  slug               String                  @db.VarChar(100)
  description        String?
  avatar             String?                 @db.VarChar(500)
  maxMembers         Int                     @default(100)
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  members            TeamMember[]
  projectPermissions TeamProjectPermission[]
  organization       Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, slug])
  @@index([slug])
  @@map("teams")
}

model TeamMember {
  id       String   @id @default(cuid())
  teamId   String
  userId   String
  role     TeamRole @default(MEMBER)
  joinedAt DateTime @default(now())
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([role])
  @@map("team_members")
}

model TeamProjectPermission {
  id        String     @id @default(cuid())
  teamId    String
  projectId String
  role      MemberRole
  createdAt DateTime   @default(now())
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, projectId])
  @@index([projectId])
  @@map("team_project_permissions")
}

model Project {
  id                     String                  @id @default(cuid())
  name                   String                  @db.VarChar(100)
  description            String?
  visibility             ProjectVisibility       @default(PRIVATE)
  ownerId                String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  organizationId         String?
  archivedAt             DateTime?
  defaultBranch          String?                 @default("main") @db.VarChar(100)
  isArchived             Boolean                 @default(false)
  allowSelfMerge         Boolean                 @default(true)
  requireApprovals       Int                     @default(1)
  requireReviewFromOwner Boolean                 @default(false)
  branchProtectionRules  BranchProtectionRule[]
  collaborationSessions  CollaborationSession[]
  issues                 Issue[]
  labels                 Label[]
  milestones             Milestone[]
  pipelines              Pipeline[]
  projectFiles           ProjectFile[]
  members                ProjectMember[]
  organization           Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner                  User                    @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  pullRequests           PullRequest[]
  repository             Repository?
  searchMetadata         SearchMetadata[]
  teamPermissions        TeamProjectPermission[]
  webhooks               Webhook[]
  wikiPages              WikiPage[]

  @@unique([ownerId, name])
  @@unique([organizationId, name])
  @@index([visibility])
  @@map("projects")
}

model ProjectMember {
  id        String     @id @default(cuid())
  projectId String
  userId    String
  role      MemberRole @default(MEMBER)
  joinedAt  DateTime   @default(now())
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

model Repository {
  id             String           @id @default(cuid())
  projectId      String           @unique
  defaultBranch  String           @default("main") @db.VarChar(100)
  storageUsed    BigInt           @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  branches       Branch[]
  commits        Commit[]
  files          File[]
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  searchMetadata SearchMetadata[]

  @@index([projectId])
  @@map("repositories")
}

model Branch {
  id           String     @id @default(cuid())
  repositoryId String
  name         String     @db.VarChar(100)
  commitId     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  commit       Commit?    @relation("BranchCommit", fields: [commitId], references: [id])
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  commits      Commit[]   @relation("BranchCommits")
  files        File[]

  @@unique([repositoryId, name])
  @@index([commitId])
  @@map("branches")
}

model Commit {
  id           String     @id @default(cuid())
  repositoryId String
  branchId     String
  authorId     String
  message      String
  hash         String     @default(cuid()) @db.VarChar(64)
  parentHash   String?    @db.VarChar(64)
  createdAt    DateTime   @default(now())
  branchHeads  Branch[]   @relation("BranchCommit")
  author       User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  branch       Branch     @relation("BranchCommits", fields: [branchId], references: [id], onDelete: Cascade)
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  files        File[]

  @@index([repositoryId])
  @@index([branchId])
  @@index([authorId])
  @@index([hash])
  @@index([createdAt])
  @@map("commits")
}

model File {
  id             String          @id @default(cuid())
  repositoryId   String
  branchId       String
  commitId       String?
  path           String          @db.VarChar(500)
  objectName     String          @db.VarChar(1000)
  size           Int
  mimeType       String          @db.VarChar(100)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  branch         Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  commit         Commit?         @relation(fields: [commitId], references: [id])
  repository     Repository      @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  searchMetadata SearchMetadata?

  @@unique([repositoryId, branchId, path])
  @@index([branchId])
  @@index([commitId])
  @@index([path])
  @@map("files")
}

model SearchMetadata {
  id            String      @id @default(cuid())
  fileId        String      @unique
  projectId     String
  repositoryId  String
  status        IndexStatus @default(PENDING)
  indexedAt     DateTime?
  failureReason String?
  retryCount    Int         @default(0)
  lastCommitId  String?     @db.VarChar(64)
  contentHash   String?     @db.VarChar(64)
  symbolCount   Int         @default(0)
  lineCount     Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  file          File        @relation(fields: [fileId], references: [id], onDelete: Cascade)
  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository    Repository  @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([repositoryId])
  @@index([status])
  @@index([indexedAt])
  @@map("search_metadata")
}

model RaftLog {
  id        String   @id @default(cuid())
  index     Int      @unique
  term      Int
  command   String
  timestamp BigInt
  createdAt DateTime @default(now())

  @@index([index])
  @@index([term])
  @@index([createdAt])
  @@map("raft_logs")
}

model RaftState {
  id          String        @id @default(cuid())
  nodeId      String        @unique @db.VarChar(50)
  currentTerm Int           @default(0)
  votedFor    String?       @db.VarChar(50)
  state       RaftNodeState @default(FOLLOWER)
  leaderId    String?       @db.VarChar(50)
  commitIndex Int           @default(0)
  lastApplied Int           @default(0)
  updatedAt   DateTime      @updatedAt

  @@index([nodeId])
  @@map("raft_state")
}

model ProjectFile {
  id         String   @id @default(cuid())
  projectId  String
  name       String   @db.VarChar(255)
  path       String   @db.VarChar(1000)
  size       Int
  mimeType   String   @db.VarChar(100)
  type       String   @db.VarChar(10)
  folder     String?  @db.VarChar(500)
  uploadedBy String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader   User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([uploadedBy])
  @@index([folder])
  @@index([type])
  @@map("project_files")
}

model Issue {
  id          String          @id @default(cuid())
  projectId   String
  number      Int
  title       String          @db.VarChar(500)
  body        String?
  state       IssueState      @default(OPEN)
  authorId    String
  milestoneId String?
  closedAt    DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  assignees   IssueAssignee[]
  comments    IssueComment[]
  events      IssueEvent[]
  labels      IssueLabel[]
  author      User            @relation("IssueAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  milestone   Milestone?      @relation(fields: [milestoneId], references: [id])
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, number])
  @@index([authorId])
  @@index([state])
  @@index([milestoneId])
  @@index([createdAt])
  @@map("issues")
}

model Label {
  id          String       @id @default(cuid())
  projectId   String
  name        String       @db.VarChar(50)
  color       String       @db.VarChar(7)
  description String?      @db.VarChar(200)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  issueLabels IssueLabel[]
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@map("labels")
}

model IssueLabel {
  id        String   @id @default(cuid())
  issueId   String
  labelId   String
  createdAt DateTime @default(now())
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  label     Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([issueId, labelId])
  @@index([labelId])
  @@index([issueId])
  @@map("issue_labels")
}

model Milestone {
  id          String         @id @default(cuid())
  projectId   String
  title       String         @db.VarChar(200)
  description String?
  dueDate     DateTime?
  state       MilestoneState @default(OPEN)
  closedAt    DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  issues      Issue[]
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, title])
  @@index([state])
  @@index([dueDate])
  @@map("milestones")
}

model IssueComment {
  id        String   @id @default(cuid())
  issueId   String
  authorId  String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation("IssueCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([authorId])
  @@index([createdAt])
  @@map("issue_comments")
}

model IssueAssignee {
  id         String   @id @default(cuid())
  issueId    String
  userId     String
  assignedAt DateTime @default(now())
  issue      Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user       User     @relation("IssueAssignees", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([issueId, userId])
  @@index([userId])
  @@index([issueId])
  @@map("issue_assignees")
}

model IssueEvent {
  id        String   @id @default(cuid())
  issueId   String
  actorId   String
  event     String   @db.VarChar(50)
  metadata  Json?
  createdAt DateTime @default(now())
  actor     User     @relation("IssueEventActor", fields: [actorId], references: [id], onDelete: Cascade)
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([actorId])
  @@index([event])
  @@index([createdAt])
  @@map("issue_events")
}

model PullRequest {
  id            String         @id @default(cuid())
  projectId     String
  number        Int
  title         String         @db.VarChar(500)
  body          String?
  sourceBranch  String         @db.VarChar(100)
  targetBranch  String         @db.VarChar(100)
  state         PRState        @default(OPEN)
  authorId      String
  mergedAt      DateTime?
  mergedBy      String?
  mergeCommit   String?        @db.VarChar(64)
  closedAt      DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  mergeStrategy MergeStrategy?
  assignees     PRAssignee[]
  comments      PRComment[]
  events        PREvent[]
  reviews       PRReview[]
  author        User           @relation("PRAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  merger        User?          @relation("PRMerger", fields: [mergedBy], references: [id])
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, number])
  @@index([projectId])
  @@index([authorId])
  @@index([state])
  @@index([createdAt])
  @@map("pull_requests")
}

model PRAssignee {
  id            String      @id @default(cuid())
  pullRequestId String
  userId        String
  assignedAt    DateTime    @default(now())
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  user          User        @relation("PRAssignees", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pullRequestId, userId])
  @@index([userId])
  @@index([pullRequestId])
  @@map("pr_assignees")
}

model PRReview {
  id            String      @id @default(cuid())
  pullRequestId String
  reviewerId    String
  state         ReviewState
  body          String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  reviewer      User        @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([reviewerId])
  @@index([state])
  @@map("pr_reviews")
}

model PRComment {
  id            String      @id @default(cuid())
  pullRequestId String
  authorId      String
  body          String
  filePath      String?     @db.VarChar(500)
  lineNumber    Int?
  commitHash    String?     @db.VarChar(64)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  author        User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([authorId])
  @@index([createdAt])
  @@map("pr_comments")
}

model PREvent {
  id            String      @id @default(cuid())
  pullRequestId String
  actorId       String
  event         String      @db.VarChar(50)
  metadata      Json?
  createdAt     DateTime    @default(now())
  actor         User        @relation(fields: [actorId], references: [id], onDelete: Cascade)
  pullRequest   PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([actorId])
  @@index([event])
  @@index([createdAt])
  @@map("pr_events")
}

/// *
///  * 通知表
///  * 存储所有用户通知记录
///  * ECP-C3: Performance Awareness - 添加索引优化查询
///  * - userId: 按用户查询未读通知
///  * - read: 快速过滤已读/未读
///  * - createdAt: 时间排序
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String           @db.VarChar(200)
  body      String?
  read      Boolean          @default(false)
  link      String?          @db.VarChar(500)
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

/// *
///  * 通知偏好设置表
///  * 用户可自定义接收哪些类型的通知
///  * ECP-A1: SOLID - 单一职责原则
///  * - 每个用户一条配置记录（1:1关系）
model NotificationPreference {
  id                 String   @id @default(cuid())
  userId             String   @unique
  prCreated          Boolean  @default(true)
  prMerged           Boolean  @default(true)
  prReviewed         Boolean  @default(true)
  prCommented        Boolean  @default(true)
  issueMentioned     Boolean  @default(true)
  issueAssigned      Boolean  @default(true)
  issueCommented     Boolean  @default(true)
  emailNotifications Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

/// *
///  * 分支保护规则表
///  * 为项目的特定分支配置保护策略，防止未经审核的代码合并
///  * MVP功能：
///  * - 要求PR审核才能合并
///  * - 设置最少审核人数
///  * - 禁止直接推送到保护分支
///  * 后续扩展：
///  * - 分支模式匹配（通配符支持）
///  * - CI/CD状态检查集成
///  * - Code Owner审查要求
model BranchProtectionRule {
  id                       String   @id @default(cuid())
  projectId                String
  branchPattern            String   @db.VarChar(100)
  requirePullRequest       Boolean  @default(true)
  requiredApprovingReviews Int      @default(1)
  dismissStaleReviews      Boolean  @default(false)
  requireCodeOwnerReview   Boolean  @default(false)
  allowForcePushes         Boolean  @default(false)
  allowDeletions           Boolean  @default(false)
  requireStatusChecks      Boolean  @default(false)
  requiredStatusChecks     String[]
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  project                  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, branchPattern])
  @@index([projectId])
  @@map("branch_protection_rules")
}

/// *
///  * 安全审计日志表
///  * Phase 4: 记录所有敏感操作和安全事件，用于合规审计和安全分析
///  * 核心功能：
///  * - 记录用户操作（登录、权限变更、敏感数据访问）
///  * - 记录资源变更（创建、更新、删除）
///  * - 记录审计追踪（谁、什么时间、做了什么、结果如何）
///  * - 支持 IP 地址和 User-Agent 追踪
///  * 合规要求：
///  * - SOC2: 审计日志保留至少90天
///  * - ISO27001: 记录安全相关事件
///  * - GDPR: 记录个人数据访问
model AuditLog {
  id          String          @id @default(cuid())
  entityId    String?         @db.VarChar(100)
  userId      String?         @db.VarChar(100)
  username    String?         @db.VarChar(50)
  ipAddress   String?         @db.VarChar(45)
  userAgent   String?
  description String
  metadata    Json?
  success     Boolean         @default(true)
  errorMsg    String?
  createdAt   DateTime        @default(now())
  action      AuditAction     @default(ACCESS)
  entityType  AuditEntityType
  user        User?           @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("audit_logs")
}

/// *
///  * API Token 表
///  * 用户可创建多个 API 令牌用于程序化访问 API
///  * 核心功能：
///  * - 支持多个令牌（每个令牌有独立名称）
///  * - 作用域控制（read, write, admin）
///  * - 可选过期时间
///  * - SHA256 哈希存储（安全性）
///  * - 令牌只在创建时显示一次
///  * ECP-C1: 防御性编程 - 令牌哈希存储，不可逆
///  * ECP-C2: 系统化错误处理 - 过期验证、作用域验证
model ApiToken {
  id          String    @id @default(cuid())
  userId      String
  name        String    @db.VarChar(100)
  tokenHash   String    @unique @db.VarChar(64)
  tokenPrefix String    @db.VarChar(8)
  scopes      String[]
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@index([userId, createdAt(sort: Desc)])
  @@map("api_tokens")
}

/// *
///  * Newsletter 订阅者表
///  * 用于营销网站的Newsletter订阅功能
///  * 核心功能：
///  * - 邮箱订阅
///  * - 双重确认（发送确认邮件）
///  * - 取消订阅
///  * ECP-C1: 防御性编程 - 邮箱唯一性、确认token安全
model NewsletterSubscriber {
  id           String    @id @default(cuid())
  email        String    @unique @db.VarChar(255)
  confirmToken String    @unique @db.VarChar(64)
  confirmed    Boolean   @default(false)
  confirmedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("newsletter_subscribers")
}

/// *
///  * Wiki 页面模型
///  * 支持层级结构、版本历史、Markdown 内容
///  * ECP-A1: SOLID - 清晰的数据模型结构
///  * ECP-C1: 防御性编程 - slug 唯一性约束
model WikiPage {
  id             String            @id @default(cuid())
  projectId      String
  slug           String            @db.VarChar(200)
  title          String            @db.VarChar(500)
  content        String
  parentId       String?
  order          Int               @default(0)
  createdById    String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  lastEditedById String
  history        WikiPageHistory[]
  createdBy      User              @relation("WikiPageCreator", fields: [createdById], references: [id])
  lastEditedBy   User              @relation("WikiPageEditor", fields: [lastEditedById], references: [id])
  project        Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([parentId])
  @@map("wiki_pages")
}

/// *
///  * Wiki 页面历史记录模型
///  * 保存每次编辑的历史版本
///  * ECP-C1: 防御性编程 - 完整的版本追溯
model WikiPageHistory {
  id         String   @id(map: "wiki_page_histories_pkey") @default(cuid())
  pageId     String
  title      String   @db.VarChar(500)
  content    String
  editedById String
  editedAt   DateTime @default(now())
  message    String?  @db.VarChar(500)
  version    Int      @default(1)
  editedBy   User     @relation("WikiPageHistoryEditor", fields: [editedById], references: [id])
  page       WikiPage @relation(fields: [pageId], references: [id], onDelete: Cascade, map: "wiki_page_histories_pageId_fkey")

  @@map("wiki_page_history")
}

/// *
///  * OAuth 账户关联表
///  * 支持第三方 OAuth 登录（GitHub、Google 等）
///  * ECP-C1: 防御性编程 - 令牌加密存储
model OAuthAccount {
  id           String    @id @default(cuid())
  userId       String
  provider     String    @db.VarChar(50)
  providerId   String    @db.VarChar(255)
  email        String?   @db.VarChar(255)
  displayName  String?   @db.VarChar(255)
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  scope        String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider])
  @@index([email])
  @@map("oauth_accounts")
}

/// *
///  * Pipeline 配置表
///  * 定义 CI/CD 流水线配置
model Pipeline {
  id        String        @id @default(cuid())
  projectId String
  name      String        @db.VarChar(100)
  config    Json
  triggers  String[]
  active    Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  runs      PipelineRun[]
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@index([projectId])
  @@index([active])
  @@map("pipelines")
}

/// *
///  * Pipeline 运行记录表
///  * 记录每次流水线执行情况
model PipelineRun {
  id         String         @id @default(cuid())
  pipelineId String
  commitSha  String         @db.VarChar(64)
  branch     String         @db.VarChar(100)
  status     PipelineStatus @default(PENDING)
  startedAt  DateTime       @default(now())
  finishedAt DateTime?
  duration   Int?
  logs       String?
  metadata   Json?
  pipeline   Pipeline       @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@index([pipelineId])
  @@index([status])
  @@index([commitSha])
  @@index([startedAt])
  @@index([pipelineId, startedAt(sort: Desc)])
  @@map("pipeline_runs")
}

/// *
///  * Webhook 配置表
///  * 支持事件推送到外部 URL
model Webhook {
  id         String            @id @default(cuid())
  projectId  String
  url        String            @db.VarChar(500)
  secret     String            @db.VarChar(255) // 已弃用：仅用于向后兼容，新创建的webhook使用secretHash
  secretHash String?           @db.VarChar(255) // SHA256哈希值，用于安全验证
  events     String[]
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  active     Boolean           @default(true)
  deliveries WebhookDelivery[]
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("webhooks")
}

/// *
///  * Webhook 投递记录表
///  * 记录每次 Webhook 发送结果
model WebhookDelivery {
  id             String   @id @default(cuid())
  webhookId      String
  event          String   @db.VarChar(100)
  payload        Json
  statusCode     Int?
  response       Json?
  success        Boolean  @default(false)
  deliveredAt    DateTime @default(now())
  requestHeaders Json?
  retryCount     Int      @default(0)
  webhook        Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@map("webhook_deliveries")
}

/// *
///  * 两步验证配置表
///  * 支持TOTP（Time-based One-Time Password）
model TwoFactorAuth {
  id            String    @id @default(cuid())
  userId        String    @unique
  secret        String    @db.VarChar(255)
  recoveryCodes String[]
  enabled       Boolean   @default(false)
  verifiedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("two_factor_auth")
}

/// *
///  * 协作会话表
///  * 管理实时协作编辑会话
model CollaborationSession {
  id           String                     @id @default(cuid())
  documentType String                     @db.VarChar(20)
  documentId   String                     @db.VarChar(500)
  projectId    String
  createdAt    DateTime                   @default(now())
  updatedAt    DateTime                   @updatedAt
  participants CollaborationParticipant[]
  project      Project                    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("collaboration_sessions")
}

/// *
///  * 协作参与者表
///  * 记录每个会话的参与用户
model CollaborationParticipant {
  id           String               @id @default(cuid())
  sessionId    String
  userId       String
  color        String               @db.VarChar(20)
  joinedAt     DateTime             @default(now())
  lastActiveAt DateTime             @default(now())
  session      CollaborationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("collaboration_participants")
}

/// *
///  * 数据导出请求表
///  * 支持 GDPR 合规的用户数据导出功能
model DataExportRequest {
  id          String           @id @default(cuid())
  userId      String
  filePath    String?          @db.VarChar(500)
  fileSize    Int?
  expiresAt   DateTime?
  completedAt DateTime?
  errorMsg    String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  format      DataExportFormat @default(JSON)
  status      DataExportStatus @default(PENDING)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("data_export_requests")
}

enum UserRole {
  USER
  SUPER_ADMIN
}

enum ProjectVisibility {
  PUBLIC
  PRIVATE
}

enum MemberRole {
  OWNER
  MAINTAINER
  MEMBER
  VIEWER
}

enum RaftNodeState {
  FOLLOWER
  CANDIDATE
  LEADER
}

enum IssueState {
  OPEN
  CLOSED
}

enum MilestoneState {
  OPEN
  CLOSED
}

enum PRState {
  OPEN
  MERGED
  CLOSED
}

enum ReviewState {
  APPROVED
  CHANGES_REQUESTED
  COMMENTED
}

enum MergeStrategy {
  MERGE
  SQUASH
  REBASE
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum TeamRole {
  MAINTAINER
  MEMBER
}

enum IndexStatus {
  PENDING
  INDEXING
  INDEXED
  FAILED
  OUTDATED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  ACCESS
  DOWNLOAD
  UPLOAD
  GRANT
  REVOKE
  APPROVE
  REJECT
}

enum AuditEntityType {
  USER
  PROJECT
  REPOSITORY
  FILE
  ISSUE
  PULL_REQUEST
  ORGANIZATION
  TEAM
  BRANCH_PROTECTION
  SETTINGS
}

/// *
///  * 通知类型枚举
///  * 支持的通知场景：
///  * - Pull Request相关：创建、合并、关闭、审查、评论
///  * - Issue相关：提及、分配、评论
enum NotificationType {
  PR_CREATED
  PR_MERGED
  PR_CLOSED
  PR_REVIEWED
  PR_COMMENTED
  ISSUE_MENTIONED
  ISSUE_ASSIGNED
  ISSUE_COMMENTED
}

enum PipelineStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILURE
  CANCELLED
}

/// *
///  * 数据导出格式枚举
enum DataExportFormat {
  JSON
  CSV
}

/// *
///  * 数据导出状态枚举
enum DataExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}
