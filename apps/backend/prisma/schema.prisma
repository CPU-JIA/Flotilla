// Prisma Schema for Cloud Dev Platform
// åŸºäºäº‘è®¡ç®—çš„å¼€å‘åä½œå¹³å°

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// æšä¸¾å®šä¹‰
// ============================================

enum UserRole {
  USER // æ™®é€šç”¨æˆ·
  SUPER_ADMIN // è¶…çº§ç®¡ç†å‘˜
}

enum ProjectVisibility {
  PUBLIC // å…¬å¼€
  PRIVATE // ç§æœ‰
}

enum MemberRole {
  OWNER // æ‰€æœ‰è€…
  MAINTAINER // ç»´æŠ¤è€…ï¼ˆå¯ç®¡ç†é¡¹ç›®è®¾ç½®ã€å®¡æ ¸PRï¼‰
  MEMBER // æˆå‘˜ï¼ˆå¯è¯»å†™ä»£ç ï¼‰
  VIEWER // æŸ¥çœ‹è€…ï¼ˆåªè¯»ï¼‰
}

enum RaftNodeState {
  FOLLOWER // è·Ÿéšè€…
  CANDIDATE // å€™é€‰äºº
  LEADER // é¢†å¯¼è€…
}

enum IssueState {
  OPEN // å¼€æ”¾çŠ¶æ€
  CLOSED // å·²å…³é—­
}

enum MilestoneState {
  OPEN // è¿›è¡Œä¸­
  CLOSED // å·²å®Œæˆ
}

enum PRState {
  OPEN // å¼€æ”¾çŠ¶æ€
  MERGED // å·²åˆå¹¶
  CLOSED // å·²å…³é—­
}

enum ReviewState {
  APPROVED // æ‰¹å‡†
  CHANGES_REQUESTED // è¯·æ±‚ä¿®æ”¹
  COMMENTED // ä»…è¯„è®º
}

enum MergeStrategy {
  MERGE // æ ‡å‡†merge commit (ä¿ç•™å®Œæ•´å†å²)
  SQUASH // Squash merge (å‹ç¼©æˆå•ä¸ªcommit)
  REBASE // Rebase merge (çº¿æ€§å†å²)
}

enum OrgRole {
  OWNER // ç»„ç»‡æ‰€æœ‰è€…ï¼ˆæœ€é«˜æƒé™ï¼‰
  ADMIN // ç»„ç»‡ç®¡ç†å‘˜ï¼ˆå¯ç®¡ç†æˆå‘˜å’Œè®¾ç½®ï¼‰
  MEMBER // ç»„ç»‡æˆå‘˜ï¼ˆåŸºç¡€æƒé™ï¼‰
}

enum TeamRole {
  MAINTAINER // å›¢é˜Ÿç»´æŠ¤è€…ï¼ˆå¯ç®¡ç†å›¢é˜Ÿå’Œåˆ†é…æƒé™ï¼‰
  MEMBER // å›¢é˜Ÿæˆå‘˜ï¼ˆç»§æ‰¿å›¢é˜Ÿæƒé™ï¼‰
}

enum IndexStatus {
  PENDING // ç­‰å¾…ç´¢å¼•
  INDEXING // ç´¢å¼•ä¸­
  INDEXED // å·²ç´¢å¼•
  FAILED // ç´¢å¼•å¤±è´¥
  OUTDATED // å·²è¿‡æœŸï¼ˆæ–‡ä»¶æœ‰æ–°æäº¤ï¼‰
}

enum AuditAction {
  CREATE // åˆ›å»º
  UPDATE // æ›´æ–°
  DELETE // åˆ é™¤
  LOGIN // ç™»å½•
  LOGOUT // ç™»å‡º
  ACCESS // è®¿é—®
  DOWNLOAD // ä¸‹è½½
  UPLOAD // ä¸Šä¼ 
  GRANT // æˆæƒ
  REVOKE // æ’¤é”€
  APPROVE // æ‰¹å‡†
  REJECT // æ‹’ç»
}

enum AuditEntityType {
  USER // ç”¨æˆ·
  PROJECT // é¡¹ç›®
  REPOSITORY // ä»“åº“
  FILE // æ–‡ä»¶
  ISSUE // Issue
  PULL_REQUEST // Pull Request
  ORGANIZATION // ç»„ç»‡
  TEAM // å›¢é˜Ÿ
  BRANCH_PROTECTION // åˆ†æ”¯ä¿æŠ¤
  SETTINGS // è®¾ç½®
}

// ============================================
// ç”¨æˆ·æ¨¡å—
// ============================================

model User {
  id           String   @id @default(cuid())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @db.VarChar(255)
  avatar       String?  @db.VarChar(500)
  bio          String?  @db.Text
  role         UserRole @default(USER)
  isActive     Boolean  @default(true) // è´¦æˆ·æ˜¯å¦æ¿€æ´»ï¼ˆå°ç¦åŠŸèƒ½ï¼‰

  // é‚®ç®±éªŒè¯å­—æ®µ
  emailVerified      Boolean   @default(false) // é‚®ç®±æ˜¯å¦å·²éªŒè¯
  emailVerifyToken   String?   @unique @db.VarChar(255) // é‚®ç®±éªŒè¯token
  emailVerifyExpires DateTime? // éªŒè¯tokenè¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰

  // å¯†ç é‡ç½®å­—æ®µ
  passwordResetToken   String?   @unique @db.VarChar(255) // å¯†ç é‡ç½®token
  passwordResetExpires DateTime? // é‡ç½®tokenè¿‡æœŸæ—¶é—´ï¼ˆ1å°æ—¶ï¼‰

  // ğŸ”’ SECURITY FIX: JWT Tokenç‰ˆæœ¬æ§åˆ¶ï¼ˆCWE-613: å¯†ç é‡ç½®åæ’¤é”€æ—§Tokenï¼‰
  tokenVersion Int @default(0) // Tokenç‰ˆæœ¬å·ï¼Œå¯†ç é‡ç½®/ç™»å‡ºæ—¶é€’å¢

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  ownedProjects          Project[]               @relation("ProjectOwner")
  projectMembers         ProjectMember[]
  commits                Commit[]
  uploadedFiles          ProjectFile[]
  organizationMembers    OrganizationMember[]
  teamMembers            TeamMember[]
  authoredIssues         Issue[]                 @relation("IssueAuthor")
  issueComments          IssueComment[]          @relation("IssueCommentAuthor")
  issueEvents            IssueEvent[]            @relation("IssueEventActor")
  authoredPRs            PullRequest[]           @relation("PRAuthor")
  mergedPRs              PullRequest[]           @relation("PRMerger")
  prReviews              PRReview[]
  prComments             PRComment[]
  prEvents               PREvent[]
  notifications          Notification[] // ç”¨æˆ·æ¥æ”¶çš„é€šçŸ¥
  notificationPreference NotificationPreference? // ç”¨æˆ·é€šçŸ¥åå¥½è®¾ç½®ï¼ˆ1:1å…³ç³»ï¼‰
  auditLogs              AuditLog[] // Phase 4: ç”¨æˆ·çš„å®¡è®¡æ—¥å¿—
  passwordHistories      PasswordHistory[] // ğŸ”’ å¯†ç å†å²è®°å½•ï¼ˆé˜²æ­¢é‡ç”¨æ—§å¯†ç ï¼‰
  sessions               UserSession[] // ğŸ”’ Phase 4: ç”¨æˆ·ä¼šè¯è®°å½•ï¼ˆè®¾å¤‡ç®¡ç†ï¼‰

  @@index([email])
  @@index([username])
  @@map("users")
}

// ğŸ”’ SECURITY FIX: å¯†ç å†å²è®°å½•è¡¨ï¼ˆé˜²æ­¢é‡ç”¨æ—§å¯†ç ï¼‰
// CWE-521: Weak Password Requirements
model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String   @db.VarChar(255)
  createdAt    DateTime @default(now())

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)]) // æŒ‰ç”¨æˆ·å’Œæ—¶é—´å€’åºç´¢å¼•ï¼ˆæŸ¥è¯¢æœ€è¿‘å¯†ç ï¼‰
  @@map("password_histories")
}

// ğŸ”’ Phase 4: ç”¨æˆ·ä¼šè¯è¡¨ï¼ˆè®¾å¤‡ç®¡ç†ã€å¼‚åœ°ç™»å½•æ£€æµ‹ï¼‰
// è®°å½•æ¯æ¬¡ç™»å½•çš„è®¾å¤‡ã€IPã€åœ°ç†ä½ç½®
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  ipAddress String   @db.VarChar(45) // IPv4: 15å­—ç¬¦, IPv6: 45å­—ç¬¦
  userAgent String   @db.Text // æµè§ˆå™¨User-Agent
  device    String?  @db.VarChar(100) // è®¾å¤‡ç±»å‹ï¼ˆè§£æè‡ªUser-Agentï¼‰
  browser   String?  @db.VarChar(100) // æµè§ˆå™¨ç±»å‹
  os        String?  @db.VarChar(100) // æ“ä½œç³»ç»Ÿ
  location  String?  @db.VarChar(200) // åœ°ç†ä½ç½®ï¼ˆåŸå¸‚/å›½å®¶ï¼‰

  // Tokenç‰ˆæœ¬ï¼ˆç”¨äºæ’¤é”€ç‰¹å®šä¼šè¯ï¼‰
  tokenVersion Int

  // ä¼šè¯çŠ¶æ€
  isActive  Boolean  @default(true) // ä¼šè¯æ˜¯å¦æ¿€æ´»
  lastUsedAt DateTime @default(now()) // æœ€åæ´»è·ƒæ—¶é—´
  expiresAt DateTime // Tokenè¿‡æœŸæ—¶é—´

  createdAt DateTime @default(now())

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive]) // æŸ¥è¯¢ç”¨æˆ·çš„æ´»è·ƒä¼šè¯
  @@index([userId, createdAt(sort: Desc)]) // æŸ¥è¯¢ç”¨æˆ·çš„å†å²ä¼šè¯
  @@index([expiresAt]) // å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯
  @@map("user_sessions")
}

// ============================================
// ç»„ç»‡ä¸å›¢é˜Ÿæ¨¡å—
// ============================================

model Organization {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(100)
  slug        String  @unique @db.VarChar(100)
  description String? @db.Text
  avatar      String? @db.VarChar(500)
  website     String? @db.VarChar(500)

  // èµ„æºé…é¢
  maxProjects  Int    @default(1000)
  maxMembers   Int    @default(1000)
  storageQuota BigInt @default(107374182400) // 100GB default
  storageUsed  BigInt @default(0)

  // ä¸ªäººç»„ç»‡æ ‡è¯†ï¼ˆç”¨äºæ•°æ®è¿ç§»æ—¶åŒºåˆ†ä¸ªäººé¡¹ç›®ç»„ç»‡ï¼‰
  isPersonal Boolean @default(false)

  // è½¯åˆ é™¤æ”¯æŒï¼ˆ30å¤©ä¿æŠ¤æœŸï¼‰
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // å…³ç³»
  members  OrganizationMember[]
  teams    Team[]
  projects Project[]

  @@index([slug])
  @@index([deletedAt])
  @@index([createdAt])
  @@map("organizations")
}

model OrganizationMember {
  id             String  @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole @default(MEMBER)

  joinedAt DateTime @default(now())

  // å…³ç³»
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([role])
  @@map("organization_members")
}

model Team {
  id             String  @id @default(cuid())
  organizationId String
  name           String  @db.VarChar(100)
  slug           String  @db.VarChar(100)
  description    String? @db.Text
  avatar         String? @db.VarChar(500)

  // å›¢é˜Ÿæˆå‘˜é…é¢
  maxMembers Int @default(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  organization       Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members            TeamMember[]
  projectPermissions TeamProjectPermission[]

  @@unique([organizationId, slug])
  @@index([slug])
  @@map("teams")
}

model TeamMember {
  id     String   @id @default(cuid())
  teamId String
  userId String
  role   TeamRole @default(MEMBER)

  joinedAt DateTime @default(now())

  // å…³ç³»
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([role])
  @@map("team_members")
}

model TeamProjectPermission {
  id        String     @id @default(cuid())
  teamId    String
  projectId String
  role      MemberRole // å¤ç”¨é¡¹ç›®è§’è‰²ï¼šOWNER/MAINTAINER/MEMBER/VIEWER

  createdAt DateTime @default(now())

  // å…³ç³»
  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([teamId, projectId])
  @@index([projectId])
  @@map("team_project_permissions")
}

// ============================================
// é¡¹ç›®æ¨¡å—
// ============================================

model Project {
  id             String            @id @default(cuid())
  name           String            @db.VarChar(100)
  description    String?           @db.Text
  visibility     ProjectVisibility @default(PRIVATE)
  ownerId        String
  organizationId String?

  // é¡¹ç›®è®¾ç½®åŠŸèƒ½å­—æ®µ
  defaultBranch String?   @default("main") @db.VarChar(100)
  isArchived    Boolean   @default(false)
  archivedAt    DateTime?

  // PR Approval Settings
  requireApprovals       Int     @default(1)
  allowSelfMerge         Boolean @default(true)
  requireReviewFromOwner Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  owner                 User                    @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  organization          Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  repository            Repository?
  members               ProjectMember[]
  projectFiles          ProjectFile[]
  teamPermissions       TeamProjectPermission[]
  issues                Issue[]
  labels                Label[]
  milestones            Milestone[]
  pullRequests          PullRequest[]
  branchProtectionRules BranchProtectionRule[]
  searchMetadata        SearchMetadata[] // Code Searchç´¢å¼•å…ƒæ•°æ®

  @@unique([ownerId, name])
  @@unique([organizationId, name])
  @@index([visibility])
  @@map("projects")
}

model ProjectMember {
  id        String     @id @default(cuid())
  projectId String
  userId    String
  role      MemberRole @default(MEMBER)

  joinedAt DateTime @default(now())

  // å…³ç³»
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@map("project_members")
}

// ============================================
// ä»“åº“æ¨¡å—
// ============================================

model Repository {
  id            String @id @default(cuid())
  projectId     String @unique
  defaultBranch String @default("main") @db.VarChar(100)
  storageUsed   BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  branches       Branch[]
  commits        Commit[]
  files          File[]
  searchMetadata SearchMetadata[] // Code Searchç´¢å¼•å…ƒæ•°æ®

  @@index([projectId])
  @@map("repositories")
}

model Branch {
  id           String  @id @default(cuid())
  repositoryId String
  name         String  @db.VarChar(100)
  commitId     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  commit     Commit?    @relation("BranchCommit", fields: [commitId], references: [id], onDelete: SetNull)
  commits    Commit[]   @relation("BranchCommits")
  files      File[]

  @@unique([repositoryId, name])
  @@index([commitId])
  @@map("branches")
}

model Commit {
  id           String  @id @default(cuid())
  repositoryId String
  branchId     String
  authorId     String
  message      String  @db.Text
  hash         String  @default(cuid()) @db.VarChar(64)
  parentHash   String? @db.VarChar(64)

  createdAt DateTime @default(now())

  // å…³ç³»
  repository  Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  branch      Branch     @relation("BranchCommits", fields: [branchId], references: [id], onDelete: Cascade)
  author      User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  files       File[]
  branchHeads Branch[]   @relation("BranchCommit")

  @@index([repositoryId])
  @@index([branchId])
  @@index([authorId])
  @@index([hash])
  @@index([createdAt])
  @@map("commits")
}

model File {
  id           String  @id @default(cuid())
  repositoryId String
  branchId     String
  commitId     String?
  path         String  @db.VarChar(500)
  objectName   String  @db.VarChar(1000) // MinIOå¯¹è±¡åç§°
  size         Int
  mimeType     String  @db.VarChar(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  branch     Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  commit     Commit?    @relation(fields: [commitId], references: [id], onDelete: SetNull)

  // Code Searchç´¢å¼•å…ƒæ•°æ®ï¼ˆå¯é€‰å…³ç³»ï¼‰
  searchMetadata SearchMetadata?

  @@unique([repositoryId, branchId, path])
  @@index([branchId])
  @@index([commitId])
  @@index([path])
  @@map("files")
}

// ============================================
// Code Search æ¨¡å—
// ============================================

model SearchMetadata {
  id           String @id @default(cuid())
  fileId       String @unique // å…³è”åˆ°Fileè¡¨
  projectId    String
  repositoryId String

  // ç´¢å¼•çŠ¶æ€
  status        IndexStatus @default(PENDING)
  indexedAt     DateTime? // ä¸Šæ¬¡ç´¢å¼•æ—¶é—´
  failureReason String?     @db.Text // å¤±è´¥åŸå› 
  retryCount    Int         @default(0) // é‡è¯•æ¬¡æ•°

  // æ–‡ä»¶å¿«ç…§ï¼ˆç”¨äºæ£€æµ‹å˜åŒ–ï¼‰
  lastCommitId String? @db.VarChar(64)
  contentHash  String? @db.VarChar(64) // SHA256 hash

  // ç´¢å¼•ç»Ÿè®¡
  symbolCount Int @default(0) // ä»£ç ç¬¦å·æ•°é‡
  lineCount   Int @default(0) // æ€»è¡Œæ•°

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  file       File       @relation(fields: [fileId], references: [id], onDelete: Cascade)
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([repositoryId])
  @@index([status])
  @@index([indexedAt])
  @@map("search_metadata")
}

// ============================================
// Raft åˆ†å¸ƒå¼å…±è¯†æ¨¡å—
// ============================================

model RaftLog {
  id        String @id @default(cuid())
  index     Int    @unique
  term      Int
  command   String @db.Text
  timestamp BigInt

  createdAt DateTime @default(now())

  @@index([index])
  @@index([term])
  @@index([createdAt])
  @@map("raft_logs")
}

model RaftState {
  id          String        @id @default(cuid())
  nodeId      String        @unique @db.VarChar(50)
  currentTerm Int           @default(0)
  votedFor    String?       @db.VarChar(50)
  state       RaftNodeState @default(FOLLOWER)
  leaderId    String?       @db.VarChar(50)
  commitIndex Int           @default(0)
  lastApplied Int           @default(0)

  updatedAt DateTime @updatedAt

  @@index([nodeId])
  @@map("raft_state")
}

// ============================================
// é¡¹ç›®æ–‡ä»¶ç®¡ç†æ¨¡å—
// ============================================

model ProjectFile {
  id         String  @id @default(cuid())
  projectId  String
  name       String  @db.VarChar(255)
  path       String  @db.VarChar(1000) // MinIOä¸­çš„å¯¹è±¡è·¯å¾„
  size       Int
  mimeType   String  @db.VarChar(100)
  type       String  @db.VarChar(10) // 'file' or 'folder'
  folder     String? @db.VarChar(500) // æ‰€å±æ–‡ä»¶å¤¹è·¯å¾„
  uploadedBy String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([uploadedBy])
  @@index([folder])
  @@index([type])
  @@map("project_files")
}

// ============================================
// Issue è¿½è¸ªç³»ç»Ÿæ¨¡å—
// ============================================

model Issue {
  id        String     @id @default(cuid())
  projectId String
  number    Int // é¡¹ç›®å†…å”¯ä¸€ç¼–å·ï¼ˆè‡ªå¢ï¼‰
  title     String     @db.VarChar(500)
  body      String?    @db.Text
  state     IssueState @default(OPEN)
  authorId  String

  // å…³è”å…³ç³»ï¼ˆå¤šå¯¹å¤šï¼‰
  assigneeIds String[] // åˆ†é…ç»™çš„ç”¨æˆ·IDæ•°ç»„
  labelIds    String[] // æ ‡ç­¾IDæ•°ç»„
  milestoneId String?

  closedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // å…³ç³»
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author    User           @relation("IssueAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  milestone Milestone?     @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  comments  IssueComment[]
  events    IssueEvent[]

  @@unique([projectId, number])
  @@index([authorId])
  @@index([state])
  @@index([milestoneId])
  @@index([createdAt])
  @@map("issues")
}

model Label {
  id          String  @id @default(cuid())
  projectId   String
  name        String  @db.VarChar(50)
  color       String  @db.VarChar(7) // Hex color (#RRGGBB)
  description String? @db.VarChar(200)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@map("labels")
}

model Milestone {
  id          String         @id @default(cuid())
  projectId   String
  title       String         @db.VarChar(200)
  description String?        @db.Text
  dueDate     DateTime?
  state       MilestoneState @default(OPEN)
  closedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues  Issue[]

  @@unique([projectId, title])
  @@index([state])
  @@index([dueDate])
  @@map("milestones")
}

model IssueComment {
  id       String @id @default(cuid())
  issueId  String
  authorId String
  body     String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  issue  Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author User  @relation("IssueCommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([authorId])
  @@index([createdAt])
  @@map("issue_comments")
}

model IssueEvent {
  id       String @id @default(cuid())
  issueId  String
  actorId  String
  event    String @db.VarChar(50) // äº‹ä»¶ç±»å‹ï¼šopened, closed, reopened, assigned, labeled, etc.
  metadata Json? // äº‹ä»¶ç›¸å…³å…ƒæ•°æ®

  createdAt DateTime @default(now())

  // å…³ç³»
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  actor User  @relation("IssueEventActor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([actorId])
  @@index([event])
  @@index([createdAt])
  @@map("issue_events")
}

// ============================================
// Pull Request ç³»ç»Ÿæ¨¡å—
// ============================================

model PullRequest {
  id           String  @id @default(cuid())
  projectId    String
  number       Int // é¡¹ç›®å†…å”¯ä¸€ç¼–å·ï¼ˆè‡ªå¢ï¼‰
  title        String  @db.VarChar(500)
  body         String? @db.Text
  sourceBranch String  @db.VarChar(100)
  targetBranch String  @db.VarChar(100)
  state        PRState @default(OPEN)
  authorId     String

  // åˆå¹¶ç›¸å…³
  mergedAt      DateTime?
  mergedBy      String?
  mergeCommit   String?        @db.VarChar(64) // åˆå¹¶åç”Ÿæˆçš„ commit hash
  mergeStrategy MergeStrategy? // ä½¿ç”¨çš„åˆå¹¶ç­–ç•¥

  closedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // å…³ç³»
  project  Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  author   User        @relation("PRAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  merger   User?       @relation("PRMerger", fields: [mergedBy], references: [id], onDelete: SetNull)
  reviews  PRReview[]
  comments PRComment[]
  events   PREvent[]

  @@unique([projectId, number])
  @@index([projectId])
  @@index([authorId])
  @@index([state])
  @@index([createdAt])
  @@map("pull_requests")
}

model PRReview {
  id            String      @id @default(cuid())
  pullRequestId String
  reviewerId    String
  state         ReviewState
  body          String?     @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  reviewer    User        @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([reviewerId])
  @@index([state])
  @@map("pr_reviews")
}

model PRComment {
  id            String  @id @default(cuid())
  pullRequestId String
  authorId      String
  body          String  @db.Text
  filePath      String? @db.VarChar(500) // For line-level comments
  lineNumber    Int? // For line-level comments
  commitHash    String? @db.VarChar(64) // é”å®šåˆ°ç‰¹å®š commitï¼Œé˜²æ­¢ diff å˜åŒ–åè¡Œå·é”™ä½

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  author      User        @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([authorId])
  @@index([createdAt])
  @@map("pr_comments")
}

model PREvent {
  id            String @id @default(cuid())
  pullRequestId String
  actorId       String
  event         String @db.VarChar(50) // äº‹ä»¶ç±»å‹ï¼šopened, closed, merged, reviewed, etc.
  metadata      Json? // äº‹ä»¶ç›¸å…³å…ƒæ•°æ®

  createdAt DateTime @default(now())

  // å…³ç³»
  pullRequest PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  actor       User        @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([pullRequestId])
  @@index([actorId])
  @@index([event])
  @@index([createdAt])
  @@map("pr_events")
}

// ============================================
// é€šçŸ¥ç³»ç»Ÿæ¨¡å—
// ============================================

/**
 * é€šçŸ¥ç±»å‹æšä¸¾
 * æ”¯æŒçš„é€šçŸ¥åœºæ™¯ï¼š
 * - Pull Requestç›¸å…³ï¼šåˆ›å»ºã€åˆå¹¶ã€å…³é—­ã€å®¡æŸ¥ã€è¯„è®º
 * - Issueç›¸å…³ï¼šæåŠã€åˆ†é…ã€è¯„è®º
 */
enum NotificationType {
  PR_CREATED // PRè¢«åˆ›å»º
  PR_MERGED // PRè¢«åˆå¹¶
  PR_CLOSED // PRè¢«å…³é—­
  PR_REVIEWED // PRè¢«å®¡æŸ¥
  PR_COMMENTED // PRè¢«è¯„è®º
  ISSUE_MENTIONED // åœ¨Issueä¸­è¢«æåŠ
  ISSUE_ASSIGNED // è¢«åˆ†é…åˆ°Issue
  ISSUE_COMMENTED // Issueè¢«è¯„è®º
}

/**
 * é€šçŸ¥è¡¨
 * å­˜å‚¨æ‰€æœ‰ç”¨æˆ·é€šçŸ¥è®°å½•
 * ECP-C3: Performance Awareness - æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
 * - userId: æŒ‰ç”¨æˆ·æŸ¥è¯¢æœªè¯»é€šçŸ¥
 * - read: å¿«é€Ÿè¿‡æ»¤å·²è¯»/æœªè¯»
 * - createdAt: æ—¶é—´æ’åº
 */
model Notification {
  id       String           @id @default(cuid())
  userId   String // é€šçŸ¥æ¥æ”¶è€…
  type     NotificationType // é€šçŸ¥ç±»å‹
  title    String           @db.VarChar(200) // é€šçŸ¥æ ‡é¢˜
  body     String?          @db.Text // é€šçŸ¥å†…å®¹ï¼ˆæ”¯æŒMarkdownï¼‰
  read     Boolean          @default(false) // æ˜¯å¦å·²è¯»
  link     String?          @db.VarChar(500) // ç›¸å…³èµ„æºé“¾æ¥ï¼ˆå¦‚PRè¯¦æƒ…é¡µï¼‰
  metadata Json? // é¢å¤–å…ƒæ•°æ®ï¼ˆPR IDã€Issue IDã€è¯„è®ºå†…å®¹ç­‰ï¼‰

  createdAt DateTime @default(now())

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([userId, read]) // å¤åˆç´¢å¼•ï¼šæŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æœªè¯»é€šçŸ¥
  @@map("notifications")
}

/**
 * é€šçŸ¥åå¥½è®¾ç½®è¡¨
 * ç”¨æˆ·å¯è‡ªå®šä¹‰æ¥æ”¶å“ªäº›ç±»å‹çš„é€šçŸ¥
 * ECP-A1: SOLID - å•ä¸€èŒè´£åŸåˆ™
 * - æ¯ä¸ªç”¨æˆ·ä¸€æ¡é…ç½®è®°å½•ï¼ˆ1:1å…³ç³»ï¼‰
 */
model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique // ç”¨æˆ·IDï¼ˆå”¯ä¸€ï¼‰

  // PRé€šçŸ¥å¼€å…³
  prCreated   Boolean @default(true) // PRåˆ›å»ºé€šçŸ¥
  prMerged    Boolean @default(true) // PRåˆå¹¶é€šçŸ¥
  prReviewed  Boolean @default(true) // PRå®¡æŸ¥é€šçŸ¥
  prCommented Boolean @default(true) // PRè¯„è®ºé€šçŸ¥

  // Issueé€šçŸ¥å¼€å…³
  issueMentioned Boolean @default(true) // IssueæåŠé€šçŸ¥
  issueAssigned  Boolean @default(true) // Issueåˆ†é…é€šçŸ¥
  issueCommented Boolean @default(true) // Issueè¯„è®ºé€šçŸ¥

  // é‚®ä»¶é€šçŸ¥ï¼ˆæš‚æœªå®ç°ï¼Œé¢„ç•™å­—æ®µï¼‰
  emailNotifications Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ============================================
// åˆ†æ”¯ä¿æŠ¤è§„åˆ™æ¨¡å—
// ============================================

/**
 * åˆ†æ”¯ä¿æŠ¤è§„åˆ™è¡¨
 * ä¸ºé¡¹ç›®çš„ç‰¹å®šåˆ†æ”¯é…ç½®ä¿æŠ¤ç­–ç•¥ï¼Œé˜²æ­¢æœªç»å®¡æ ¸çš„ä»£ç åˆå¹¶
 * MVPåŠŸèƒ½ï¼š
 * - è¦æ±‚PRå®¡æ ¸æ‰èƒ½åˆå¹¶
 * - è®¾ç½®æœ€å°‘å®¡æ ¸äººæ•°
 * - ç¦æ­¢ç›´æ¥æ¨é€åˆ°ä¿æŠ¤åˆ†æ”¯
 * åç»­æ‰©å±•ï¼š
 * - åˆ†æ”¯æ¨¡å¼åŒ¹é…ï¼ˆé€šé…ç¬¦æ”¯æŒï¼‰
 * - CI/CDçŠ¶æ€æ£€æŸ¥é›†æˆ
 * - Code Ownerå®¡æŸ¥è¦æ±‚
 */
model BranchProtectionRule {
  id        String @id @default(cuid())
  projectId String

  // ä¿æŠ¤çš„åˆ†æ”¯åç§°ï¼ˆMVP: ç²¾ç¡®åŒ¹é…ï¼Œå¦‚ "main", "develop"ï¼‰
  branchPattern String @db.VarChar(100)

  // æ ¸å¿ƒä¿æŠ¤è§„åˆ™
  requirePullRequest       Boolean @default(true) // å¿…é¡»é€šè¿‡PRä¿®æ”¹ï¼ˆä¸èƒ½ç›´æ¥pushï¼‰
  requiredApprovingReviews Int     @default(1) // æœ€å°‘æ‰¹å‡†å®¡æ ¸æ•°é‡
  dismissStaleReviews      Boolean @default(false) // æ–°æäº¤åä½œåºŸæ—§å®¡æŸ¥
  requireCodeOwnerReview   Boolean @default(false) // è¦æ±‚Code Ownerå®¡æŸ¥

  // é«˜çº§ä¿æŠ¤é€‰é¡¹
  allowForcePushes Boolean @default(false) // å…è®¸å¼ºåˆ¶æ¨é€ï¼ˆå±é™©æ“ä½œï¼‰
  allowDeletions   Boolean @default(false) // å…è®¸åˆ é™¤ä¿æŠ¤åˆ†æ”¯

  // çŠ¶æ€æ£€æŸ¥ï¼ˆCI/CDé›†æˆï¼ŒPhase 2åŠŸèƒ½ï¼Œæš‚æ—¶ä¿ç•™å­—æ®µï¼‰
  requireStatusChecks  Boolean  @default(false) // è¦æ±‚çŠ¶æ€æ£€æŸ¥é€šè¿‡
  requiredStatusChecks String[] // å¿…é¡»é€šè¿‡çš„æ£€æŸ¥é¡¹ ["ci", "tests", "build"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, branchPattern]) // æ¯ä¸ªé¡¹ç›®çš„æ¯ä¸ªåˆ†æ”¯åªèƒ½æœ‰ä¸€æ¡ä¿æŠ¤è§„åˆ™
  @@index([projectId])
  @@map("branch_protection_rules")
}

// ============================================
// å®‰å…¨å®¡è®¡æ—¥å¿—æ¨¡å—
// ============================================

/**
 * å®‰å…¨å®¡è®¡æ—¥å¿—è¡¨
 * Phase 4: è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œå’Œå®‰å…¨äº‹ä»¶ï¼Œç”¨äºåˆè§„å®¡è®¡å’Œå®‰å…¨åˆ†æ
 * æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - è®°å½•ç”¨æˆ·æ“ä½œï¼ˆç™»å½•ã€æƒé™å˜æ›´ã€æ•æ„Ÿæ•°æ®è®¿é—®ï¼‰
 * - è®°å½•èµ„æºå˜æ›´ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰
 * - è®°å½•å®¡è®¡è¿½è¸ªï¼ˆè°ã€ä»€ä¹ˆæ—¶é—´ã€åšäº†ä»€ä¹ˆã€ç»“æœå¦‚ä½•ï¼‰
 * - æ”¯æŒ IP åœ°å€å’Œ User-Agent è¿½è¸ª
 * åˆè§„è¦æ±‚ï¼š
 * - SOC2: å®¡è®¡æ—¥å¿—ä¿ç•™è‡³å°‘90å¤©
 * - ISO27001: è®°å½•å®‰å…¨ç›¸å…³äº‹ä»¶
 * - GDPR: è®°å½•ä¸ªäººæ•°æ®è®¿é—®
 */
model AuditLog {
  id String @id @default(cuid())

  // æ“ä½œä¿¡æ¯
  action     AuditAction     @default(ACCESS) // æ“ä½œç±»å‹
  entityType AuditEntityType // å®ä½“ç±»å‹
  entityId   String?         @db.VarChar(100) // å®ä½“ IDï¼ˆå¯é€‰ï¼Œå¦‚ç™»å½•æ“ä½œæ— å®ä½“ï¼‰

  // æ“ä½œè€…ä¿¡æ¯
  userId    String? @db.VarChar(100) // æ“ä½œç”¨æˆ· IDï¼ˆç³»ç»Ÿæ“ä½œå¯ä¸º nullï¼‰
  username  String? @db.VarChar(50) // æ“ä½œç”¨æˆ·åï¼ˆå†—ä½™ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
  ipAddress String? @db.VarChar(45) // IP åœ°å€ï¼ˆIPv4/IPv6ï¼‰
  userAgent String? @db.Text // User-Agent

  // æ“ä½œè¯¦æƒ…
  description String  @db.Text // æ“ä½œæè¿°ï¼ˆäººç±»å¯è¯»ï¼‰
  metadata    Json? // é¢å¤–å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
  success     Boolean @default(true) // æ“ä½œæ˜¯å¦æˆåŠŸ
  errorMsg    String? @db.Text // å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯

  // æ—¶é—´æˆ³
  createdAt DateTime @default(now())

  // å…³ç³»ï¼ˆå¯é€‰ï¼Œç”¨äºçº§è”åˆ é™¤ï¼‰
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // ç´¢å¼•ä¼˜åŒ–
  @@index([userId]) // æŒ‰ç”¨æˆ·æŸ¥è¯¢å®¡è®¡æ—¥å¿—
  @@index([action]) // æŒ‰æ“ä½œç±»å‹æŸ¥è¯¢
  @@index([entityType]) // æŒ‰å®ä½“ç±»å‹æŸ¥è¯¢
  @@index([createdAt]) // æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
  @@index([success]) // æŸ¥è¯¢å¤±è´¥æ“ä½œ
  @@index([userId, createdAt]) // å¤åˆç´¢å¼•ï¼šç”¨æˆ·çš„æ—¶é—´çº¿
  @@map("audit_logs")
}
